var Er=Object.defineProperty;var wi=i=>{throw TypeError(i)};var Ir=(i,t,e)=>t in i?Er(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var M=(i,t,e)=>Ir(i,typeof t!="symbol"?t+"":t,e),es=(i,t,e)=>t.has(i)||wi("Cannot "+e);var E=(i,t,e)=>(es(i,t,"read from private field"),e?e.call(i):t.get(i)),U=(i,t,e)=>t.has(i)?wi("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(i):t.set(i,e),L=(i,t,e,s)=>(es(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e),ss=(i,t,e)=>(es(i,t,"access private method"),e);const Tr=[EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError,globalThis.DOMException,globalThis.AssertionError,globalThis.SystemError].filter(Boolean).map(i=>[i.name,i]),je=new Map(Tr);class vs extends Error{constructor(e){super(vs._prepareSuperMessage(e));M(this,"name","NonError")}static _prepareSuperMessage(e){try{return JSON.stringify(e)}catch{return String(e)}}}const Cr=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0},{property:"cause",enumerable:!1}],Ss=new WeakSet,Dr=i=>{Ss.add(i);const t=i.toJSON();return Ss.delete(i),t},_n=i=>je.get(i)??Error,Ns=({from:i,seen:t,to:e,forceEnumerable:s,maxDepth:n,depth:r,useToJSON:a,serialize:o})=>{if(!e)if(Array.isArray(i))e=[];else if(!o&&bi(i)){const l=_n(i.name);e=new l}else e={};if(t.push(i),r>=n)return e;if(a&&typeof i.toJSON=="function"&&!Ss.has(i))return Dr(i);const h=l=>Ns({from:l,seen:[...t],forceEnumerable:s,maxDepth:n,depth:r,useToJSON:a,serialize:o});for(const[l,c]of Object.entries(i)){if(c&&c instanceof Uint8Array&&c.constructor.name==="Buffer"){e[l]="[object Buffer]";continue}if(c!==null&&typeof c=="object"&&typeof c.pipe=="function"){e[l]="[object Stream]";continue}if(typeof c!="function"){if(!c||typeof c!="object"){try{e[l]=c}catch{}continue}if(!t.includes(i[l])){r++,e[l]=h(i[l]);continue}e[l]="[Circular]"}}for(const{property:l,enumerable:c}of Cr)typeof i[l]<"u"&&i[l]!==null&&Object.defineProperty(e,l,{value:bi(i[l])?h(i[l]):i[l],enumerable:s?!0:c,configurable:!0,writable:!0});return e};function kr(i,t={}){const{maxDepth:e=Number.POSITIVE_INFINITY,useToJSON:s=!0}=t;return typeof i=="object"&&i!==null?Ns({from:i,seen:[],forceEnumerable:!0,maxDepth:e,depth:0,useToJSON:s,serialize:!0}):typeof i=="function"?`[Function: ${i.name||"anonymous"}]`:i}function Rr(i,t={}){const{maxDepth:e=Number.POSITIVE_INFINITY}=t;if(i instanceof Error)return i;if(Or(i)){const s=_n(i.name);return Ns({from:i,seen:[],to:new s,maxDepth:e,depth:0,serialize:!1})}return new vs(i)}function bi(i){return!!i&&typeof i=="object"&&"name"in i&&"message"in i&&"stack"in i}function Or(i){return!!i&&typeof i=="object"&&"message"in i&&!Array.isArray(i)}const wn=i=>i.data!==void 0,Lr=({data:i})=>Array.isArray(i)?i.length:i.byteLength,Si=i=>i.byteLength??Lr(i),Pr=25e7;class Ur{constructor(t=Pr){this.entries=new Map,this.maxSize=t,this.currentSize=0,this.first=null,this.last=null}get size(){return this.currentSize}get numberOfEntries(){return this.entries.size}removeEntryFromStore(t){this.entries.delete(t.key),this.currentSize-=Si(t.data)}removeEntryFromList(t){const{prev:e,next:s}=t;e?e.next=s:this.first=s,s?s.prev=e:this.last=e}addEntryAsFirst(t){this.first?this.first.prev=t:this.last=t,t.next=this.first,t.prev=null,this.first=t}moveEntryToFirst(t){t!==this.first&&(this.removeEntryFromList(t),this.addEntryAsFirst(t))}evictLast(){if(!this.last){console.error("VolumeCache: attempt to evict last entry from cache when no last entry is set");return}this.removeEntryFromStore(this.last),this.last.prev&&(this.last.prev.next=null),this.last=this.last.prev}evict(t){this.removeEntryFromStore(t),this.removeEntryFromList(t)}insert(t,e){const s=Si(e);if(s>this.maxSize)return console.error("VolumeCache: attempt to insert a single entry larger than the cache"),!1;const n=this.getEntry(t);if(n!==void 0)return n.data=e,!0;const r={data:e,prev:null,next:null,key:t};for(this.addEntryAsFirst(r),this.entries.set(t,r),this.currentSize+=s;this.currentSize>this.maxSize;)this.evictLast();return!0}getEntry(t){const e=this.entries.get(t);return e&&this.moveEntryToFirst(e),e}get(t){var e;return(e=this.getEntry(t))==null?void 0:e.data}clearWithPrefix(t){for(const[e,s]of this.entries.entries())e.startsWith(t)&&this.evict(s)}clear(){for(;this.last;)this.evictLast()}}/**
 * @license
 * Copyright 2010-2024 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const bn="171",Bs=300,Ai=1e3,Gt=1001,zi=1002,Ge=1003,Sn=1006,Fr=1008,qe=1009,vr=1010,Nr=1011,Br=1012,qr=1013,Vr=1014,Gr=1015,An=1023,$r=1024,Yr=1028,Rt=1029,Xr="",De=2e3,Mi=2001;class zn{addEventListener(t,e){this._listeners===void 0&&(this._listeners={});const s=this._listeners;s[t]===void 0&&(s[t]=[]),s[t].indexOf(e)===-1&&s[t].push(e)}hasEventListener(t,e){if(this._listeners===void 0)return!1;const s=this._listeners;return s[t]!==void 0&&s[t].indexOf(e)!==-1}removeEventListener(t,e){if(this._listeners===void 0)return;const n=this._listeners[t];if(n!==void 0){const r=n.indexOf(e);r!==-1&&n.splice(r,1)}}dispatchEvent(t){if(this._listeners===void 0)return;const s=this._listeners[t.type];if(s!==void 0){t.target=this;const n=s.slice(0);for(let r=0,a=n.length;r<a;r++)n[r].call(this,t);t.target=null}}}const V=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];function qs(){const i=Math.random()*4294967295|0,t=Math.random()*4294967295|0,e=Math.random()*4294967295|0,s=Math.random()*4294967295|0;return(V[i&255]+V[i>>8&255]+V[i>>16&255]+V[i>>24&255]+"-"+V[t&255]+V[t>>8&255]+"-"+V[t>>16&15|64]+V[t>>24&255]+"-"+V[e&63|128]+V[e>>8&255]+"-"+V[e>>16&255]+V[e>>24&255]+V[s&255]+V[s>>8&255]+V[s>>16&255]+V[s>>24&255]).toLowerCase()}function P(i,t,e){return Math.max(t,Math.min(e,i))}class It{constructor(t=0,e=0){It.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,s=this.y,n=t.elements;return this.x=n[0]*e+n[3]*s+n[6],this.y=n[1]*e+n[4]*s+n[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=P(this.x,t.x,e.x),this.y=P(this.y,t.y,e.y),this}clampScalar(t,e){return this.x=P(this.x,t,e),this.y=P(this.y,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(P(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(P(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const s=Math.cos(e),n=Math.sin(e),r=this.x-t.x,a=this.y-t.y;return this.x=r*s-a*n+t.x,this.y=r*n+a*s+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Me{constructor(t,e,s,n,r,a,o,h,l){Me.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],t!==void 0&&this.set(t,e,s,n,r,a,o,h,l)}set(t,e,s,n,r,a,o,h,l){const c=this.elements;return c[0]=t,c[1]=n,c[2]=o,c[3]=e,c[4]=r,c[5]=h,c[6]=s,c[7]=a,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this}extractBasis(t,e,s){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),s.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,n=e.elements,r=this.elements,a=s[0],o=s[3],h=s[6],l=s[1],c=s[4],u=s[7],f=s[2],d=s[5],m=s[8],y=n[0],g=n[3],p=n[6],x=n[1],w=n[4],A=n[7],b=n[2],S=n[5],z=n[8];return r[0]=a*y+o*x+h*b,r[3]=a*g+o*w+h*S,r[6]=a*p+o*A+h*z,r[1]=l*y+c*x+u*b,r[4]=l*g+c*w+u*S,r[7]=l*p+c*A+u*z,r[2]=f*y+d*x+m*b,r[5]=f*g+d*w+m*S,r[8]=f*p+d*A+m*z,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[1],n=t[2],r=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8];return e*a*c-e*o*l-s*r*c+s*o*h+n*r*l-n*a*h}invert(){const t=this.elements,e=t[0],s=t[1],n=t[2],r=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=c*a-o*l,f=o*h-c*r,d=l*r-a*h,m=e*u+s*f+n*d;if(m===0)return this.set(0,0,0,0,0,0,0,0,0);const y=1/m;return t[0]=u*y,t[1]=(n*l-c*s)*y,t[2]=(o*s-n*a)*y,t[3]=f*y,t[4]=(c*e-n*h)*y,t[5]=(n*r-o*e)*y,t[6]=d*y,t[7]=(s*h-l*e)*y,t[8]=(a*e-s*r)*y,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,s,n,r,a,o){const h=Math.cos(r),l=Math.sin(r);return this.set(s*h,s*l,-s*(h*a+l*o)+a+t,-n*l,n*h,-n*(-l*a+h*o)+o+e,0,0,1),this}scale(t,e){return this.premultiply(is.makeScale(t,e)),this}rotate(t){return this.premultiply(is.makeRotation(-t)),this}translate(t,e){return this.premultiply(is.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,s,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,s=t.elements;for(let n=0;n<9;n++)if(e[n]!==s[n])return!1;return!0}fromArray(t,e=0){for(let s=0;s<9;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t}clone(){return new this.constructor().fromArray(this.elements)}}const is=new Me;function Ei(i){return document.createElementNS("http://www.w3.org/1999/xhtml",i)}function ns(i){return i<.04045?i*.0773993808:Math.pow(i*.9478672986+.0521327014,2.4)}let Ot;class jr{static getDataURL(t){if(/^data:/i.test(t.src)||typeof HTMLCanvasElement>"u")return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{Ot===void 0&&(Ot=Ei("canvas")),Ot.width=t.width,Ot.height=t.height;const s=Ot.getContext("2d");t instanceof ImageData?s.putImageData(t,0,0):s.drawImage(t,0,0,t.width,t.height),e=Ot}return e.width>2048||e.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",t),e.toDataURL("image/jpeg",.6)):e.toDataURL("image/png")}static sRGBToLinear(t){if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap){const e=Ei("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");s.drawImage(t,0,0,t.width,t.height);const n=s.getImageData(0,0,t.width,t.height),r=n.data;for(let a=0;a<r.length;a++)r[a]=ns(r[a]/255)*255;return s.putImageData(n,0,0),e}else if(t.data){const e=t.data.slice(0);for(let s=0;s<e.length;s++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[s]=Math.floor(ns(e[s]/255)*255):e[s]=ns(e[s]);return{data:e,width:t.width,height:t.height}}else return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}let Hr=0;class Zr{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:Hr++}),this.uuid=qs(),this.data=t,this.dataReady=!0,this.version=0}set needsUpdate(t){t===!0&&this.version++}toJSON(t){const e=t===void 0||typeof t=="string";if(!e&&t.images[this.uuid]!==void 0)return t.images[this.uuid];const s={uuid:this.uuid,url:""},n=this.data;if(n!==null){let r;if(Array.isArray(n)){r=[];for(let a=0,o=n.length;a<o;a++)n[a].isDataTexture?r.push(rs(n[a].image)):r.push(rs(n[a]))}else r=rs(n);s.url=r}return e||(t.images[this.uuid]=s),s}}function rs(i){return typeof HTMLImageElement<"u"&&i instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&i instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&i instanceof ImageBitmap?jr.getDataURL(i):i.data?{data:Array.from(i.data),width:i.width,height:i.height,type:i.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let Kr=0;class bt extends zn{constructor(t=bt.DEFAULT_IMAGE,e=bt.DEFAULT_MAPPING,s=Gt,n=Gt,r=Sn,a=Fr,o=An,h=qe,l=bt.DEFAULT_ANISOTROPY,c=Xr){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Kr++}),this.uuid=qs(),this.name="",this.source=new Zr(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=s,this.wrapT=n,this.magFilter=r,this.minFilter=a,this.anisotropy=l,this.format=o,this.internalFormat=null,this.type=h,this.offset=new It(0,0),this.repeat=new It(1,1),this.center=new It(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Me,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=c,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return new this.constructor().copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=t===void 0||typeof t=="string";if(!e&&t.textures[this.uuid]!==void 0)return t.textures[this.uuid];const s={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(s.userData=this.userData),e||(t.textures[this.uuid]=s),s}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(this.mapping!==Bs)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case Ai:t.x=t.x-Math.floor(t.x);break;case Gt:t.x=t.x<0?0:1;break;case zi:Math.abs(Math.floor(t.x)%2)===1?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x);break}if(t.y<0||t.y>1)switch(this.wrapT){case Ai:t.y=t.y-Math.floor(t.y);break;case Gt:t.y=t.y<0?0:1;break;case zi:Math.abs(Math.floor(t.y)%2)===1?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y);break}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){t===!0&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){t===!0&&this.pmremVersion++}}bt.DEFAULT_IMAGE=null;bt.DEFAULT_MAPPING=Bs;bt.DEFAULT_ANISOTROPY=1;class Ee{constructor(t=0,e=0,s=0,n=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=s,this._w=n}static slerpFlat(t,e,s,n,r,a,o){let h=s[n+0],l=s[n+1],c=s[n+2],u=s[n+3];const f=r[a+0],d=r[a+1],m=r[a+2],y=r[a+3];if(o===0){t[e+0]=h,t[e+1]=l,t[e+2]=c,t[e+3]=u;return}if(o===1){t[e+0]=f,t[e+1]=d,t[e+2]=m,t[e+3]=y;return}if(u!==y||h!==f||l!==d||c!==m){let g=1-o;const p=h*f+l*d+c*m+u*y,x=p>=0?1:-1,w=1-p*p;if(w>Number.EPSILON){const b=Math.sqrt(w),S=Math.atan2(b,p*x);g=Math.sin(g*S)/b,o=Math.sin(o*S)/b}const A=o*x;if(h=h*g+f*A,l=l*g+d*A,c=c*g+m*A,u=u*g+y*A,g===1-o){const b=1/Math.sqrt(h*h+l*l+c*c+u*u);h*=b,l*=b,c*=b,u*=b}}t[e]=h,t[e+1]=l,t[e+2]=c,t[e+3]=u}static multiplyQuaternionsFlat(t,e,s,n,r,a){const o=s[n],h=s[n+1],l=s[n+2],c=s[n+3],u=r[a],f=r[a+1],d=r[a+2],m=r[a+3];return t[e]=o*m+c*u+h*d-l*f,t[e+1]=h*m+c*f+l*u-o*d,t[e+2]=l*m+c*d+o*f-h*u,t[e+3]=c*m-o*u-h*f-l*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,s,n){return this._x=t,this._y=e,this._z=s,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const s=t._x,n=t._y,r=t._z,a=t._order,o=Math.cos,h=Math.sin,l=o(s/2),c=o(n/2),u=o(r/2),f=h(s/2),d=h(n/2),m=h(r/2);switch(a){case"XYZ":this._x=f*c*u+l*d*m,this._y=l*d*u-f*c*m,this._z=l*c*m+f*d*u,this._w=l*c*u-f*d*m;break;case"YXZ":this._x=f*c*u+l*d*m,this._y=l*d*u-f*c*m,this._z=l*c*m-f*d*u,this._w=l*c*u+f*d*m;break;case"ZXY":this._x=f*c*u-l*d*m,this._y=l*d*u+f*c*m,this._z=l*c*m+f*d*u,this._w=l*c*u-f*d*m;break;case"ZYX":this._x=f*c*u-l*d*m,this._y=l*d*u+f*c*m,this._z=l*c*m-f*d*u,this._w=l*c*u+f*d*m;break;case"YZX":this._x=f*c*u+l*d*m,this._y=l*d*u+f*c*m,this._z=l*c*m-f*d*u,this._w=l*c*u-f*d*m;break;case"XZY":this._x=f*c*u-l*d*m,this._y=l*d*u-f*c*m,this._z=l*c*m+f*d*u,this._w=l*c*u+f*d*m;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+a)}return e===!0&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const s=e/2,n=Math.sin(s);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(s),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,s=e[0],n=e[4],r=e[8],a=e[1],o=e[5],h=e[9],l=e[2],c=e[6],u=e[10],f=s+o+u;if(f>0){const d=.5/Math.sqrt(f+1);this._w=.25/d,this._x=(c-h)*d,this._y=(r-l)*d,this._z=(a-n)*d}else if(s>o&&s>u){const d=2*Math.sqrt(1+s-o-u);this._w=(c-h)/d,this._x=.25*d,this._y=(n+a)/d,this._z=(r+l)/d}else if(o>u){const d=2*Math.sqrt(1+o-s-u);this._w=(r-l)/d,this._x=(n+a)/d,this._y=.25*d,this._z=(h+c)/d}else{const d=2*Math.sqrt(1+u-s-o);this._w=(a-n)/d,this._x=(r+l)/d,this._y=(h+c)/d,this._z=.25*d}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let s=t.dot(e)+1;return s<Number.EPSILON?(s=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=s):(this._x=0,this._y=-t.z,this._z=t.y,this._w=s)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=s),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(P(this.dot(t),-1,1)))}rotateTowards(t,e){const s=this.angleTo(t);if(s===0)return this;const n=Math.min(1,e/s);return this.slerp(t,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return t===0?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const s=t._x,n=t._y,r=t._z,a=t._w,o=e._x,h=e._y,l=e._z,c=e._w;return this._x=s*c+a*o+n*l-r*h,this._y=n*c+a*h+r*o-s*l,this._z=r*c+a*l+s*h-n*o,this._w=a*c-s*o-n*h-r*l,this._onChangeCallback(),this}slerp(t,e){if(e===0)return this;if(e===1)return this.copy(t);const s=this._x,n=this._y,r=this._z,a=this._w;let o=a*t._w+s*t._x+n*t._y+r*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=a,this._x=s,this._y=n,this._z=r,this;const h=1-o*o;if(h<=Number.EPSILON){const d=1-e;return this._w=d*a+e*this._w,this._x=d*s+e*this._x,this._y=d*n+e*this._y,this._z=d*r+e*this._z,this.normalize(),this}const l=Math.sqrt(h),c=Math.atan2(l,o),u=Math.sin((1-e)*c)/l,f=Math.sin(e*c)/l;return this._w=a*u+this._w*f,this._x=s*u+this._x*f,this._y=n*u+this._y*f,this._z=r*u+this._z*f,this._onChangeCallback(),this}slerpQuaternions(t,e,s){return this.copy(t).slerp(e,s)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),s=Math.random(),n=Math.sqrt(1-s),r=Math.sqrt(s);return this.set(n*Math.sin(t),n*Math.cos(t),r*Math.sin(e),r*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class _{constructor(t=0,e=0,s=0){_.prototype.isVector3=!0,this.x=t,this.y=e,this.z=s}set(t,e,s){return s===void 0&&(s=this.z),this.x=t,this.y=e,this.z=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(Ii.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(Ii.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,s=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[3]*s+r[6]*n,this.y=r[1]*e+r[4]*s+r[7]*n,this.z=r[2]*e+r[5]*s+r[8]*n,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,s=this.y,n=this.z,r=t.elements,a=1/(r[3]*e+r[7]*s+r[11]*n+r[15]);return this.x=(r[0]*e+r[4]*s+r[8]*n+r[12])*a,this.y=(r[1]*e+r[5]*s+r[9]*n+r[13])*a,this.z=(r[2]*e+r[6]*s+r[10]*n+r[14])*a,this}applyQuaternion(t){const e=this.x,s=this.y,n=this.z,r=t.x,a=t.y,o=t.z,h=t.w,l=2*(a*n-o*s),c=2*(o*e-r*n),u=2*(r*s-a*e);return this.x=e+h*l+a*u-o*c,this.y=s+h*c+o*l-r*u,this.z=n+h*u+r*c-a*l,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,s=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[4]*s+r[8]*n,this.y=r[1]*e+r[5]*s+r[9]*n,this.z=r[2]*e+r[6]*s+r[10]*n,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=P(this.x,t.x,e.x),this.y=P(this.y,t.y,e.y),this.z=P(this.z,t.z,e.z),this}clampScalar(t,e){return this.x=P(this.x,t,e),this.y=P(this.y,t,e),this.z=P(this.z,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(P(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const s=t.x,n=t.y,r=t.z,a=e.x,o=e.y,h=e.z;return this.x=n*h-r*o,this.y=r*a-s*h,this.z=s*o-n*a,this}projectOnVector(t){const e=t.lengthSq();if(e===0)return this.set(0,0,0);const s=t.dot(this)/e;return this.copy(t).multiplyScalar(s)}projectOnPlane(t){return as.copy(this).projectOnVector(t),this.sub(as)}reflect(t){return this.sub(as.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(P(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y,n=this.z-t.z;return e*e+s*s+n*n}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,s){const n=Math.sin(e)*t;return this.x=n*Math.sin(s),this.y=Math.cos(e)*t,this.z=n*Math.cos(s),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,s){return this.x=t*Math.sin(e),this.y=s,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),s=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=s,this.z=n,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,e*4)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,e*3)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=Math.random()*2-1,s=Math.sqrt(1-e*e);return this.x=s*Math.cos(t),this.y=e,this.z=s*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const as=new _,Ii=new Ee;class st{constructor(t=new _(1/0,1/0,1/0),e=new _(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e+=3)this.expandByPoint(Z.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,s=t.count;e<s;e++)this.expandByPoint(Z.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const s=Z.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(s),this.max.copy(t).add(s),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return new this.constructor().copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const s=t.geometry;if(s!==void 0){const r=s.getAttribute("position");if(e===!0&&r!==void 0&&t.isInstancedMesh!==!0)for(let a=0,o=r.count;a<o;a++)t.isMesh===!0?t.getVertexPosition(a,Z):Z.fromBufferAttribute(r,a),Z.applyMatrix4(t.matrixWorld),this.expandByPoint(Z);else t.boundingBox!==void 0?(t.boundingBox===null&&t.computeBoundingBox(),ke.copy(t.boundingBox)):(s.boundingBox===null&&s.computeBoundingBox(),ke.copy(s.boundingBox)),ke.applyMatrix4(t.matrixWorld),this.union(ke)}const n=t.children;for(let r=0,a=n.length;r<a;r++)this.expandByObject(n[r],e);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,Z),Z.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,s;return t.normal.x>0?(e=t.normal.x*this.min.x,s=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,s=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,s+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,s+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,s+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,s+=t.normal.z*this.min.z),e<=-t.constant&&s>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(ie),Re.subVectors(this.max,ie),Lt.subVectors(t.a,ie),Pt.subVectors(t.b,ie),Ut.subVectors(t.c,ie),dt.subVectors(Pt,Lt),mt.subVectors(Ut,Pt),zt.subVectors(Lt,Ut);let e=[0,-dt.z,dt.y,0,-mt.z,mt.y,0,-zt.z,zt.y,dt.z,0,-dt.x,mt.z,0,-mt.x,zt.z,0,-zt.x,-dt.y,dt.x,0,-mt.y,mt.x,0,-zt.y,zt.x,0];return!os(e,Lt,Pt,Ut,Re)||(e=[1,0,0,0,1,0,0,0,1],!os(e,Lt,Pt,Ut,Re))?!1:(Oe.crossVectors(dt,mt),e=[Oe.x,Oe.y,Oe.z],os(e,Lt,Pt,Ut,Re))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,Z).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=this.getSize(Z).length()*.5),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()?this:(nt[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),nt[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),nt[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),nt[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),nt[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),nt[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),nt[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),nt[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(nt),this)}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const nt=[new _,new _,new _,new _,new _,new _,new _,new _],Z=new _,ke=new st,Lt=new _,Pt=new _,Ut=new _,dt=new _,mt=new _,zt=new _,ie=new _,Re=new _,Oe=new _,Mt=new _;function os(i,t,e,s,n){for(let r=0,a=i.length-3;r<=a;r+=3){Mt.fromArray(i,r);const o=n.x*Math.abs(Mt.x)+n.y*Math.abs(Mt.y)+n.z*Math.abs(Mt.z),h=t.dot(Mt),l=e.dot(Mt),c=s.dot(Mt);if(Math.max(-Math.max(h,l,c),Math.min(h,l,c))>o)return!1}return!0}class ht{constructor(t,e,s,n,r,a,o,h,l,c,u,f,d,m,y,g){ht.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t!==void 0&&this.set(t,e,s,n,r,a,o,h,l,c,u,f,d,m,y,g)}set(t,e,s,n,r,a,o,h,l,c,u,f,d,m,y,g){const p=this.elements;return p[0]=t,p[4]=e,p[8]=s,p[12]=n,p[1]=r,p[5]=a,p[9]=o,p[13]=h,p[2]=l,p[6]=c,p[10]=u,p[14]=f,p[3]=d,p[7]=m,p[11]=y,p[15]=g,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new ht().fromArray(this.elements)}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}copyPosition(t){const e=this.elements,s=t.elements;return e[12]=s[12],e[13]=s[13],e[14]=s[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,s){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),s.setFromMatrixColumn(this,2),this}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,0,t.y,e.y,s.y,0,t.z,e.z,s.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,s=t.elements,n=1/Ft.setFromMatrixColumn(t,0).length(),r=1/Ft.setFromMatrixColumn(t,1).length(),a=1/Ft.setFromMatrixColumn(t,2).length();return e[0]=s[0]*n,e[1]=s[1]*n,e[2]=s[2]*n,e[3]=0,e[4]=s[4]*r,e[5]=s[5]*r,e[6]=s[6]*r,e[7]=0,e[8]=s[8]*a,e[9]=s[9]*a,e[10]=s[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,s=t.x,n=t.y,r=t.z,a=Math.cos(s),o=Math.sin(s),h=Math.cos(n),l=Math.sin(n),c=Math.cos(r),u=Math.sin(r);if(t.order==="XYZ"){const f=a*c,d=a*u,m=o*c,y=o*u;e[0]=h*c,e[4]=-h*u,e[8]=l,e[1]=d+m*l,e[5]=f-y*l,e[9]=-o*h,e[2]=y-f*l,e[6]=m+d*l,e[10]=a*h}else if(t.order==="YXZ"){const f=h*c,d=h*u,m=l*c,y=l*u;e[0]=f+y*o,e[4]=m*o-d,e[8]=a*l,e[1]=a*u,e[5]=a*c,e[9]=-o,e[2]=d*o-m,e[6]=y+f*o,e[10]=a*h}else if(t.order==="ZXY"){const f=h*c,d=h*u,m=l*c,y=l*u;e[0]=f-y*o,e[4]=-a*u,e[8]=m+d*o,e[1]=d+m*o,e[5]=a*c,e[9]=y-f*o,e[2]=-a*l,e[6]=o,e[10]=a*h}else if(t.order==="ZYX"){const f=a*c,d=a*u,m=o*c,y=o*u;e[0]=h*c,e[4]=m*l-d,e[8]=f*l+y,e[1]=h*u,e[5]=y*l+f,e[9]=d*l-m,e[2]=-l,e[6]=o*h,e[10]=a*h}else if(t.order==="YZX"){const f=a*h,d=a*l,m=o*h,y=o*l;e[0]=h*c,e[4]=y-f*u,e[8]=m*u+d,e[1]=u,e[5]=a*c,e[9]=-o*c,e[2]=-l*c,e[6]=d*u+m,e[10]=f-y*u}else if(t.order==="XZY"){const f=a*h,d=a*l,m=o*h,y=o*l;e[0]=h*c,e[4]=-u,e[8]=l*c,e[1]=f*u+y,e[5]=a*c,e[9]=d*u-m,e[2]=m*u-d,e[6]=o*c,e[10]=y*u+f}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(Wr,t,Jr)}lookAt(t,e,s){const n=this.elements;return X.subVectors(t,e),X.lengthSq()===0&&(X.z=1),X.normalize(),yt.crossVectors(s,X),yt.lengthSq()===0&&(Math.abs(s.z)===1?X.x+=1e-4:X.z+=1e-4,X.normalize(),yt.crossVectors(s,X)),yt.normalize(),Le.crossVectors(X,yt),n[0]=yt.x,n[4]=Le.x,n[8]=X.x,n[1]=yt.y,n[5]=Le.y,n[9]=X.y,n[2]=yt.z,n[6]=Le.z,n[10]=X.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,n=e.elements,r=this.elements,a=s[0],o=s[4],h=s[8],l=s[12],c=s[1],u=s[5],f=s[9],d=s[13],m=s[2],y=s[6],g=s[10],p=s[14],x=s[3],w=s[7],A=s[11],b=s[15],S=n[0],z=n[4],T=n[8],C=n[12],D=n[1],k=n[5],R=n[9],v=n[13],O=n[2],q=n[6],ut=n[10],Dt=n[14],ft=n[3],W=n[7],it=n[11],kt=n[15];return r[0]=a*S+o*D+h*O+l*ft,r[4]=a*z+o*k+h*q+l*W,r[8]=a*T+o*R+h*ut+l*it,r[12]=a*C+o*v+h*Dt+l*kt,r[1]=c*S+u*D+f*O+d*ft,r[5]=c*z+u*k+f*q+d*W,r[9]=c*T+u*R+f*ut+d*it,r[13]=c*C+u*v+f*Dt+d*kt,r[2]=m*S+y*D+g*O+p*ft,r[6]=m*z+y*k+g*q+p*W,r[10]=m*T+y*R+g*ut+p*it,r[14]=m*C+y*v+g*Dt+p*kt,r[3]=x*S+w*D+A*O+b*ft,r[7]=x*z+w*k+A*q+b*W,r[11]=x*T+w*R+A*ut+b*it,r[15]=x*C+w*v+A*Dt+b*kt,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[4],n=t[8],r=t[12],a=t[1],o=t[5],h=t[9],l=t[13],c=t[2],u=t[6],f=t[10],d=t[14],m=t[3],y=t[7],g=t[11],p=t[15];return m*(+r*h*u-n*l*u-r*o*f+s*l*f+n*o*d-s*h*d)+y*(+e*h*d-e*l*f+r*a*f-n*a*d+n*l*c-r*h*c)+g*(+e*l*u-e*o*d-r*a*u+s*a*d+r*o*c-s*l*c)+p*(-n*o*c-e*h*u+e*o*f+n*a*u-s*a*f+s*h*c)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,s){const n=this.elements;return t.isVector3?(n[12]=t.x,n[13]=t.y,n[14]=t.z):(n[12]=t,n[13]=e,n[14]=s),this}invert(){const t=this.elements,e=t[0],s=t[1],n=t[2],r=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=t[9],f=t[10],d=t[11],m=t[12],y=t[13],g=t[14],p=t[15],x=u*g*l-y*f*l+y*h*d-o*g*d-u*h*p+o*f*p,w=m*f*l-c*g*l-m*h*d+a*g*d+c*h*p-a*f*p,A=c*y*l-m*u*l+m*o*d-a*y*d-c*o*p+a*u*p,b=m*u*h-c*y*h-m*o*f+a*y*f+c*o*g-a*u*g,S=e*x+s*w+n*A+r*b;if(S===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const z=1/S;return t[0]=x*z,t[1]=(y*f*r-u*g*r-y*n*d+s*g*d+u*n*p-s*f*p)*z,t[2]=(o*g*r-y*h*r+y*n*l-s*g*l-o*n*p+s*h*p)*z,t[3]=(u*h*r-o*f*r-u*n*l+s*f*l+o*n*d-s*h*d)*z,t[4]=w*z,t[5]=(c*g*r-m*f*r+m*n*d-e*g*d-c*n*p+e*f*p)*z,t[6]=(m*h*r-a*g*r-m*n*l+e*g*l+a*n*p-e*h*p)*z,t[7]=(a*f*r-c*h*r+c*n*l-e*f*l-a*n*d+e*h*d)*z,t[8]=A*z,t[9]=(m*u*r-c*y*r-m*s*d+e*y*d+c*s*p-e*u*p)*z,t[10]=(a*y*r-m*o*r+m*s*l-e*y*l-a*s*p+e*o*p)*z,t[11]=(c*o*r-a*u*r-c*s*l+e*u*l+a*s*d-e*o*d)*z,t[12]=b*z,t[13]=(c*y*n-m*u*n+m*s*f-e*y*f-c*s*g+e*u*g)*z,t[14]=(m*o*n-a*y*n-m*s*h+e*y*h+a*s*g-e*o*g)*z,t[15]=(a*u*n-c*o*n+c*s*h-e*u*h-a*s*f+e*o*f)*z,this}scale(t){const e=this.elements,s=t.x,n=t.y,r=t.z;return e[0]*=s,e[4]*=n,e[8]*=r,e[1]*=s,e[5]*=n,e[9]*=r,e[2]*=s,e[6]*=n,e[10]*=r,e[3]*=s,e[7]*=n,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,s,n))}makeTranslation(t,e,s){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,s,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),s=Math.sin(t);return this.set(1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,0,s,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const s=Math.cos(e),n=Math.sin(e),r=1-s,a=t.x,o=t.y,h=t.z,l=r*a,c=r*o;return this.set(l*a+s,l*o-n*h,l*h+n*o,0,l*o+n*h,c*o+s,c*h-n*a,0,l*h-n*o,c*h+n*a,r*h*h+s,0,0,0,0,1),this}makeScale(t,e,s){return this.set(t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1),this}makeShear(t,e,s,n,r,a){return this.set(1,s,r,0,t,1,a,0,e,n,1,0,0,0,0,1),this}compose(t,e,s){const n=this.elements,r=e._x,a=e._y,o=e._z,h=e._w,l=r+r,c=a+a,u=o+o,f=r*l,d=r*c,m=r*u,y=a*c,g=a*u,p=o*u,x=h*l,w=h*c,A=h*u,b=s.x,S=s.y,z=s.z;return n[0]=(1-(y+p))*b,n[1]=(d+A)*b,n[2]=(m-w)*b,n[3]=0,n[4]=(d-A)*S,n[5]=(1-(f+p))*S,n[6]=(g+x)*S,n[7]=0,n[8]=(m+w)*z,n[9]=(g-x)*z,n[10]=(1-(f+y))*z,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this}decompose(t,e,s){const n=this.elements;let r=Ft.set(n[0],n[1],n[2]).length();const a=Ft.set(n[4],n[5],n[6]).length(),o=Ft.set(n[8],n[9],n[10]).length();this.determinant()<0&&(r=-r),t.x=n[12],t.y=n[13],t.z=n[14],K.copy(this);const l=1/r,c=1/a,u=1/o;return K.elements[0]*=l,K.elements[1]*=l,K.elements[2]*=l,K.elements[4]*=c,K.elements[5]*=c,K.elements[6]*=c,K.elements[8]*=u,K.elements[9]*=u,K.elements[10]*=u,e.setFromRotationMatrix(K),s.x=r,s.y=a,s.z=o,this}makePerspective(t,e,s,n,r,a,o=De){const h=this.elements,l=2*r/(e-t),c=2*r/(s-n),u=(e+t)/(e-t),f=(s+n)/(s-n);let d,m;if(o===De)d=-(a+r)/(a-r),m=-2*a*r/(a-r);else if(o===Mi)d=-a/(a-r),m=-a*r/(a-r);else throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);return h[0]=l,h[4]=0,h[8]=u,h[12]=0,h[1]=0,h[5]=c,h[9]=f,h[13]=0,h[2]=0,h[6]=0,h[10]=d,h[14]=m,h[3]=0,h[7]=0,h[11]=-1,h[15]=0,this}makeOrthographic(t,e,s,n,r,a,o=De){const h=this.elements,l=1/(e-t),c=1/(s-n),u=1/(a-r),f=(e+t)*l,d=(s+n)*c;let m,y;if(o===De)m=(a+r)*u,y=-2*u;else if(o===Mi)m=r*u,y=-1*u;else throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);return h[0]=2*l,h[4]=0,h[8]=0,h[12]=-f,h[1]=0,h[5]=2*c,h[9]=0,h[13]=-d,h[2]=0,h[6]=0,h[10]=y,h[14]=-m,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(t){const e=this.elements,s=t.elements;for(let n=0;n<16;n++)if(e[n]!==s[n])return!1;return!0}fromArray(t,e=0){for(let s=0;s<16;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}}const Ft=new _,K=new ht,Wr=new _(0,0,0),Jr=new _(1,1,1),yt=new _,Le=new _,X=new _,Ti=new ht,Ci=new Ee;class He{constructor(t=0,e=0,s=0,n=He.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=s,this._order=n}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,s,n=this._order){return this._x=t,this._y=e,this._z=s,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,s=!0){const n=t.elements,r=n[0],a=n[4],o=n[8],h=n[1],l=n[5],c=n[9],u=n[2],f=n[6],d=n[10];switch(e){case"XYZ":this._y=Math.asin(P(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-a,r)):(this._x=Math.atan2(f,l),this._z=0);break;case"YXZ":this._x=Math.asin(-P(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(o,d),this._z=Math.atan2(h,l)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(P(f,-1,1)),Math.abs(f)<.9999999?(this._y=Math.atan2(-u,d),this._z=Math.atan2(-a,l)):(this._y=0,this._z=Math.atan2(h,r));break;case"ZYX":this._y=Math.asin(-P(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(f,d),this._z=Math.atan2(h,r)):(this._x=0,this._z=Math.atan2(-a,l));break;case"YZX":this._z=Math.asin(P(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(o,d));break;case"XZY":this._z=Math.asin(-P(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(f,l),this._y=Math.atan2(o,r)):(this._x=Math.atan2(-c,d),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,s===!0&&this._onChangeCallback(),this}setFromQuaternion(t,e,s){return Ti.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Ti,e,s)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return Ci.setFromEuler(this),this.setFromQuaternion(Ci,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],t[3]!==void 0&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}He.DEFAULT_ORDER="XYZ";class Qr{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return(this.mask&t.mask)!==0}isEnabled(t){return(this.mask&(1<<t|0))!==0}}let ta=0;const Di=new _,vt=new Ee,rt=new ht,Pe=new _,ne=new _,ea=new _,sa=new Ee,ki=new _(1,0,0),Ri=new _(0,1,0),Oi=new _(0,0,1),Li={type:"added"},ia={type:"removed"},Nt={type:"childadded",child:null},hs={type:"childremoved",child:null};class Tt extends zn{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:ta++}),this.uuid=qs(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Tt.DEFAULT_UP.clone();const t=new _,e=new He,s=new Ee,n=new _(1,1,1);function r(){s.setFromEuler(e,!1)}function a(){e.setFromQuaternion(s,void 0,!1)}e._onChange(r),s._onChange(a),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:s},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new ht},normalMatrix:{value:new Me}}),this.matrix=new ht,this.matrixWorld=new ht,this.matrixAutoUpdate=Tt.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Tt.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Qr,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return vt.setFromAxisAngle(t,e),this.quaternion.multiply(vt),this}rotateOnWorldAxis(t,e){return vt.setFromAxisAngle(t,e),this.quaternion.premultiply(vt),this}rotateX(t){return this.rotateOnAxis(ki,t)}rotateY(t){return this.rotateOnAxis(Ri,t)}rotateZ(t){return this.rotateOnAxis(Oi,t)}translateOnAxis(t,e){return Di.copy(t).applyQuaternion(this.quaternion),this.position.add(Di.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(ki,t)}translateY(t){return this.translateOnAxis(Ri,t)}translateZ(t){return this.translateOnAxis(Oi,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(rt.copy(this.matrixWorld).invert())}lookAt(t,e,s){t.isVector3?Pe.copy(t):Pe.set(t,e,s);const n=this.parent;this.updateWorldMatrix(!0,!1),ne.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?rt.lookAt(ne,Pe,this.up):rt.lookAt(Pe,ne,this.up),this.quaternion.setFromRotationMatrix(rt),n&&(rt.extractRotation(n.matrixWorld),vt.setFromRotationMatrix(rt),this.quaternion.premultiply(vt.invert()))}add(t){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(Li),Nt.child=t,this.dispatchEvent(Nt),Nt.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let s=0;s<arguments.length;s++)this.remove(arguments[s]);return this}const e=this.children.indexOf(t);return e!==-1&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(ia),hs.child=t,this.dispatchEvent(hs),hs.child=null),this}removeFromParent(){const t=this.parent;return t!==null&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),rt.copy(this.matrixWorld).invert(),t.parent!==null&&(t.parent.updateWorldMatrix(!0,!1),rt.multiply(t.parent.matrixWorld)),t.applyMatrix4(rt),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(Li),Nt.child=t,this.dispatchEvent(Nt),Nt.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let s=0,n=this.children.length;s<n;s++){const a=this.children[s].getObjectByProperty(t,e);if(a!==void 0)return a}}getObjectsByProperty(t,e,s=[]){this[t]===e&&s.push(this);const n=this.children;for(let r=0,a=n.length;r<a;r++)n[r].getObjectsByProperty(t,e,s);return s}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ne,t,ea),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ne,sa,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let s=0,n=e.length;s<n;s++)e[s].traverse(t)}traverseVisible(t){if(this.visible===!1)return;t(this);const e=this.children;for(let s=0,n=e.length;s<n;s++)e[s].traverseVisible(t)}traverseAncestors(t){const e=this.parent;e!==null&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let s=0,n=e.length;s<n;s++)e[s].updateMatrixWorld(t)}updateWorldMatrix(t,e){const s=this.parent;if(t===!0&&s!==null&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),e===!0){const n=this.children;for(let r=0,a=n.length;r<a;r++)n[r].updateWorldMatrix(!1,!0)}}toJSON(t){const e=t===void 0||typeof t=="string",s={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},s.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const n={};n.uuid=this.uuid,n.type=this.type,this.name!==""&&(n.name=this.name),this.castShadow===!0&&(n.castShadow=!0),this.receiveShadow===!0&&(n.receiveShadow=!0),this.visible===!1&&(n.visible=!1),this.frustumCulled===!1&&(n.frustumCulled=!1),this.renderOrder!==0&&(n.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),n.up=this.up.toArray(),this.matrixAutoUpdate===!1&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(n.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(n.type="BatchedMesh",n.perObjectFrustumCulled=this.perObjectFrustumCulled,n.sortObjects=this.sortObjects,n.drawRanges=this._drawRanges,n.reservedRanges=this._reservedRanges,n.visibility=this._visibility,n.active=this._active,n.bounds=this._bounds.map(o=>({boxInitialized:o.boxInitialized,boxMin:o.box.min.toArray(),boxMax:o.box.max.toArray(),sphereInitialized:o.sphereInitialized,sphereRadius:o.sphere.radius,sphereCenter:o.sphere.center.toArray()})),n.maxInstanceCount=this._maxInstanceCount,n.maxVertexCount=this._maxVertexCount,n.maxIndexCount=this._maxIndexCount,n.geometryInitialized=this._geometryInitialized,n.geometryCount=this._geometryCount,n.matricesTexture=this._matricesTexture.toJSON(t),this._colorsTexture!==null&&(n.colorsTexture=this._colorsTexture.toJSON(t)),this.boundingSphere!==null&&(n.boundingSphere={center:n.boundingSphere.center.toArray(),radius:n.boundingSphere.radius}),this.boundingBox!==null&&(n.boundingBox={min:n.boundingBox.min.toArray(),max:n.boundingBox.max.toArray()}));function r(o,h){return o[h.uuid]===void 0&&(o[h.uuid]=h.toJSON(t)),h.uuid}if(this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&this.environment.isRenderTargetTexture!==!0&&(n.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=r(t.geometries,this.geometry);const o=this.geometry.parameters;if(o!==void 0&&o.shapes!==void 0){const h=o.shapes;if(Array.isArray(h))for(let l=0,c=h.length;l<c;l++){const u=h[l];r(t.shapes,u)}else r(t.shapes,h)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(r(t.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const o=[];for(let h=0,l=this.material.length;h<l;h++)o.push(r(t.materials,this.material[h]));n.material=o}else n.material=r(t.materials,this.material);if(this.children.length>0){n.children=[];for(let o=0;o<this.children.length;o++)n.children.push(this.children[o].toJSON(t).object)}if(this.animations.length>0){n.animations=[];for(let o=0;o<this.animations.length;o++){const h=this.animations[o];n.animations.push(r(t.animations,h))}}if(e){const o=a(t.geometries),h=a(t.materials),l=a(t.textures),c=a(t.images),u=a(t.shapes),f=a(t.skeletons),d=a(t.animations),m=a(t.nodes);o.length>0&&(s.geometries=o),h.length>0&&(s.materials=h),l.length>0&&(s.textures=l),c.length>0&&(s.images=c),u.length>0&&(s.shapes=u),f.length>0&&(s.skeletons=f),d.length>0&&(s.animations=d),m.length>0&&(s.nodes=m)}return s.object=n,s;function a(o){const h=[];for(const l in o){const c=o[l];delete c.metadata,h.push(c)}return h}}clone(t){return new this.constructor().copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),e===!0)for(let s=0;s<t.children.length;s++){const n=t.children[s];this.add(n.clone())}return this}}Tt.DEFAULT_UP=new _(0,1,0);Tt.DEFAULT_MATRIX_AUTO_UPDATE=!0;Tt.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;class ls extends bt{constructor(t=null,e=1,s=1,n,r,a,o,h,l=Ge,c=Ge,u,f){super(null,a,o,h,l,c,n,r,u,f),this.isDataTexture=!0,this.image={data:t,width:e,height:s},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:bn}}));typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=bn);function Mn(i,t,e,s={}){return t!==void 0&&e!==void 0&&(s={...s,headers:{...s.headers,Range:`bytes=${t}-${t+e-1}`}}),fetch(i,s)}function na(i,t){return{...i,...t,headers:{...i.headers,...t.headers}}}function Pi(i,t){const e=typeof i=="string"?new URL(i):i;e.pathname.endsWith("/")||(e.pathname+="/");const s=new URL(t.slice(1),e);return s.search=e.search,s}async function Ui(i){if(i.status!==404){if(i.status===200||i.status===206)return new Uint8Array(await i.arrayBuffer());throw new Error(`Unexpected response status ${i.status} ${i.statusText}`)}}async function ra(i,t,e,s){if(s)return fetch(i,{...e,headers:{...e.headers,Range:`bytes=-${t}`}});let n=await fetch(i,{...e,method:"HEAD"});if(!n.ok)return n;let r=n.headers.get("Content-Length"),a=Number(r);return Mn(i,a-t,a,e)}var de,me,ye,As;class En{constructor(t,e={}){U(this,ye);M(this,"url");U(this,de);U(this,me);this.url=t,L(this,de,e.overrides??{}),L(this,me,e.useSuffixRequest??!1)}async get(t,e={}){let s=Pi(this.url,t).href,n=await fetch(s,ss(this,ye,As).call(this,e));return Ui(n)}async getRange(t,e,s={}){let n=Pi(this.url,t),r=ss(this,ye,As).call(this,s),a;return"suffixLength"in e?a=await ra(n,e.suffixLength,r,E(this,me)):a=await Mn(n,e.offset,e.length,r),Ui(a)}}de=new WeakMap,me=new WeakMap,ye=new WeakSet,As=function(t){return na(E(this,de),t)};var H;class Vs{constructor(t,e,s){U(this,H);typeof t=="number"?L(this,H,new Uint8Array(t)):t instanceof ArrayBuffer?L(this,H,new Uint8Array(t,e,s)):L(this,H,new Uint8Array(Array.from(t,n=>n?1:0)))}get BYTES_PER_ELEMENT(){return 1}get byteOffset(){return E(this,H).byteOffset}get byteLength(){return E(this,H).byteLength}get buffer(){return E(this,H).buffer}get length(){return E(this,H).length}get(t){let e=E(this,H)[t];return typeof e=="number"?e!==0:e}set(t,e){E(this,H)[t]=e?1:0}fill(t){E(this,H).fill(t?1:0)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}H=new WeakMap;var Xt;class Ze{constructor(t,e,s,n){M(this,"_data");M(this,"chars");U(this,Xt);if(this.chars=t,L(this,Xt,new TextEncoder),typeof e=="number")this._data=new Uint8Array(e*t);else if(e instanceof ArrayBuffer)n&&(n=n*t),this._data=new Uint8Array(e,s,n);else{let r=Array.from(e);this._data=new Uint8Array(r.length*t);for(let a=0;a<r.length;a++)this.set(a,r[a])}}get BYTES_PER_ELEMENT(){return this.chars}get byteOffset(){return this._data.byteOffset}get byteLength(){return this._data.byteLength}get buffer(){return this._data.buffer}get length(){return this.byteLength/this.BYTES_PER_ELEMENT}get(t){const e=new Uint8Array(this.buffer,this.byteOffset+this.chars*t,this.chars);return new TextDecoder().decode(e).replace(/\x00/g,"")}set(t,e){const s=new Uint8Array(this.buffer,this.byteOffset+this.chars*t,this.chars);s.fill(0),s.set(E(this,Xt).encode(e))}fill(t){const e=E(this,Xt).encode(t);for(let s=0;s<this.length;s++)this._data.set(e,s*this.chars)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}Xt=new WeakMap;var G;const mi=class mi{constructor(t,e,s,n){U(this,G);M(this,"chars");if(this.chars=t,typeof e=="number")L(this,G,new Int32Array(e*t));else if(e instanceof ArrayBuffer)n&&(n*=t),L(this,G,new Int32Array(e,s,n));else{const r=e,a=new mi(t,1);L(this,G,new Int32Array(function*(){for(let o of r)a.set(0,o),yield*E(a,G)}()))}}get BYTES_PER_ELEMENT(){return E(this,G).BYTES_PER_ELEMENT*this.chars}get byteLength(){return E(this,G).byteLength}get byteOffset(){return E(this,G).byteOffset}get buffer(){return E(this,G).buffer}get length(){return E(this,G).length/this.chars}get(t){const e=this.chars*t;let s="";for(let n=0;n<this.chars;n++)s+=String.fromCodePoint(E(this,G)[e+n]);return s.replace(/\u0000/g,"")}set(t,e){const s=this.chars*t,n=E(this,G).subarray(s,s+this.chars);n.fill(0);for(let r=0;r<this.chars;r++)n[r]=e.codePointAt(r)??0}fill(t){this.set(0,t);let e=E(this,G).subarray(0,this.chars);for(let s=1;s<this.length;s++)E(this,G).set(e,s*this.chars)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}};G=new WeakMap;let Zt=mi;function Gs(i){const t=JSON.stringify(i,null,2);return new TextEncoder().encode(t)}function Ct(i){const t=new TextDecoder().decode(i);return JSON.parse(t)}function Fi(i,t){const e=t/2,s=t-1;let n=0;for(let r=0;r<i.length;r+=t)for(let a=0;a<e;a+=1)n=i[r+a],i[r+a]=i[r+s-a],i[r+s-a]=n}function In(i){if(i==="v2:object")return globalThis.Array;let t=i.match(/v2:([US])(\d+)/);if(t){let[,s,n]=t;return(s==="U"?Zt:Ze).bind(null,Number(n))}let e={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float16:globalThis.Float16Array,float32:Float32Array,float64:Float64Array,bool:Vs}[i];return F(e,`Unknown or unsupported data_type: ${i}`),e}function St(i,t){const e=i.length;typeof t=="string"&&(t=t==="C"?Array.from({length:e},(r,a)=>a):Array.from({length:e},(r,a)=>e-1-a)),F(e===t.length,"Order length must match the number of dimensions.");let s=1,n=new Array(e);for(let r=t.length-1;r>=0;r--)n[t[r]]=s,s*=i[t[r]];return n}function aa({name:i,configuration:t}){if(i==="default"){const e=(t==null?void 0:t.separator)??"/";return s=>["c",...s].join(e)}if(i==="v2"){const e=(t==null?void 0:t.separator)??".";return s=>s.join(e)||"0"}throw new Error(`Unknown chunk key encoding: ${i}`)}function oa(i){if(i==="|O")return{data_type:"v2:object"};let t=i.match(/^([<|>])(.*)$/);F(t,`Invalid dtype: ${i}`);let[,e,s]=t,n={b1:"bool",i1:"int8",u1:"uint8",i2:"int16",u2:"uint16",i4:"int32",u4:"uint32",i8:"int64",u8:"uint64",f2:"float16",f4:"float32",f8:"float64"}[s]??(s.startsWith("S")||s.startsWith("U")?`v2:${s}`:void 0);return F(n,`Unsupported or unknown dtype: ${i}`),e==="|"?{data_type:n}:{data_type:n,endian:e==="<"?"little":"big"}}function ha(i,t={}){let e=[],s=oa(i.dtype);i.order==="F"&&e.push({name:"transpose",configuration:{order:"F"}}),"endian"in s&&s.endian==="big"&&e.push({name:"bytes",configuration:{endian:"big"}});for(let{id:n,...r}of i.filters??[])e.push({name:n,configuration:r});if(i.compressor){let{id:n,...r}=i.compressor;e.push({name:n,configuration:r})}return{zarr_format:3,node_type:"array",shape:i.shape,data_type:s.data_type,chunk_grid:{name:"regular",configuration:{chunk_shape:i.chunks}},chunk_key_encoding:{name:"v2",configuration:{separator:i.dimension_separator??"."}},codecs:e,fill_value:i.fill_value,attributes:t}}function la(i,t={}){return{zarr_format:3,node_type:"group",attributes:t}}function ca(i,t){if(t!=="number"&&t!=="bigint"&&t!=="boolean"&&t!=="object"&&t!=="string")return i===t;let e=i==="bool";if(t==="boolean")return e;let s=i.startsWith("v2:U")||i.startsWith("v2:S");if(t==="string")return s;let n=i==="int64"||i==="uint64";if(t==="bigint")return n;let r=i==="v2:object";return t==="object"?r:!s&&!n&&!e&&!r}function ua(i){return(i==null?void 0:i.name)==="sharding_indexed"}function Tn(i){return(i.data_type==="uint64"||i.data_type==="int64")&&i.fill_value!=null?BigInt(i.fill_value):i.fill_value}function $s(i,...t){if(!t.some(e=>i instanceof e))throw i}function F(i,t=""){if(!i)throw new Error(t)}async function Cn(i,{format:t,signal:e}){const s=i instanceof Response?i:new Response(i);F(s.body,"Response does not contain body.");try{return await new Response(s.body.pipeThrough(new DecompressionStream(t),{signal:e})).arrayBuffer()}catch{throw e==null||e.throwIfAborted(),new Error(`Failed to decode ${t}`)}}class Ys{constructor(t,e){M(this,"kind","array_to_array");F(t.keepbits>=0,"keepbits must be zero or positive")}static fromConfig(t,e){return new Ys(t,e)}encode(t){throw new Error("`BitroundCodec.encode` is not implemented. Please open an issue at https://github.com/manzt/zarrita.js/issues.")}decode(t){return t}}const vi=fa();function fa(){const i=new Uint32Array([305419896]);return new Uint8Array(i.buffer,i.byteOffset,i.byteLength)[0]!==18}function Ni(i){return"BYTES_PER_ELEMENT"in i?i.BYTES_PER_ELEMENT:4}var pe,gt,ge,xe,jt;const yi=class yi{constructor(t,e){M(this,"kind","array_to_bytes");U(this,pe);U(this,gt);U(this,ge);U(this,xe);U(this,jt);L(this,jt,t==null?void 0:t.endian),L(this,gt,In(e.data_type)),L(this,xe,e.shape),L(this,pe,St(e.shape,"C"));const s=new(E(this,gt))(0);L(this,ge,s.BYTES_PER_ELEMENT)}static fromConfig(t,e){return new yi(t,e)}encode(t){let e=new Uint8Array(t.data.buffer);return vi&&E(this,jt)==="big"&&Fi(e,Ni(E(this,gt))),e}decode(t){return vi&&E(this,jt)==="big"&&Fi(t,Ni(E(this,gt))),{data:new(E(this,gt))(t.buffer,t.byteOffset,t.byteLength/E(this,ge)),shape:E(this,xe),stride:E(this,pe)}}};pe=new WeakMap,gt=new WeakMap,ge=new WeakMap,xe=new WeakMap,jt=new WeakMap;let $e=yi;class Xs{constructor(){M(this,"kind","bytes_to_bytes")}static fromConfig(){return new Xs}encode(t){throw new Error("Not implemented")}decode(t){return new Uint8Array(t.buffer,t.byteOffset,t.byteLength-4)}}class js{constructor(){M(this,"kind","bytes_to_bytes")}static fromConfig(t){return new js}encode(t){throw new Error("Gzip encoding is not enabled by default. Please register a custom codec with `numcodecs/gzip`.")}async decode(t){const e=await Cn(t,{format:"gzip"});return new Uint8Array(e)}}function da(i,t){return F(!Number.isNaN(t),"JsonCodec allow_nan is false but NaN was encountered during encoding."),F(t!==Number.POSITIVE_INFINITY,"JsonCodec allow_nan is false but Infinity was encountered during encoding."),F(t!==Number.NEGATIVE_INFINITY,"JsonCodec allow_nan is false but -Infinity was encountered during encoding."),t}function ma(i,t){return t instanceof Object&&!Array.isArray(t)?Object.keys(t).sort().reduce((e,s)=>(e[s]=t[s],e),{}):t}var _e,we;const pi=class pi{constructor(t={}){M(this,"configuration");M(this,"kind","array_to_bytes");U(this,_e);U(this,we);this.configuration=t;const{encoding:e="utf-8",skipkeys:s=!1,ensure_ascii:n=!0,check_circular:r=!0,allow_nan:a=!0,sort_keys:o=!0,indent:h,strict:l=!0}=t;let c=t.separators;c||(h?c=[", ",": "]:c=[",",":"]),L(this,_e,{encoding:e,skipkeys:s,ensure_ascii:n,check_circular:r,allow_nan:a,indent:h,separators:c,sort_keys:o}),L(this,we,{strict:l})}static fromConfig(t){return new pi(t)}encode(t){const{indent:e,encoding:s,ensure_ascii:n,check_circular:r,allow_nan:a,sort_keys:o}=E(this,_e);F(s==="utf-8","JsonCodec does not yet support non-utf-8 encoding.");const h=[];F(r,"JsonCodec does not yet support skipping the check for circular references during encoding."),a||h.push(da),o&&h.push(ma);const l=Array.from(t.data);l.push("|O"),l.push(t.shape);let c;h.length&&(c=(f,d)=>{let m=d;for(let y of h)m=y(f,m);return m});let u=JSON.stringify(l,c,e);return n&&(u=u.replace(/[\u007F-\uFFFF]/g,f=>{const d=`0000${f.charCodeAt(0).toString(16)}`;return`\\u${d.substring(d.length-4)}`})),new TextEncoder().encode(u)}decode(t){const{strict:e}=E(this,we);F(e,"JsonCodec does not yet support non-strict decoding.");const s=Ct(t),n=s.pop();s.pop(),F(n,"0D not implemented for JsonCodec.");const r=St(n,"C");return{data:s,shape:n,stride:r}}};_e=new WeakMap,we=new WeakMap;let zs=pi;function Bi(i){return i instanceof Vs||i instanceof Ze||i instanceof Zt?new Proxy(i,{get(e,s){return e.get(Number(s))},set(e,s,n){return e.set(Number(s),n),!0}}):i}function ya(i,t){let e;return i.data instanceof Ze||i.data instanceof Zt?e=new i.constructor(i.data.length,i.data.chars):e=new i.constructor(i.data.length),{data:e,shape:i.shape,stride:St(i.shape,t)}}function pa(i,t){let e=ya(i,t),s=i.shape.length,n=i.data.length,r=Array(s).fill(0),a=Bi(i.data),o=Bi(e.data);for(let h=0;h<n;h++){let l=0;for(let c=0;c<s;c++)l+=r[c]*e.stride[c];o[l]=a[h],r[0]+=1;for(let c=0;c<s;c++)if(r[c]===i.shape[c]){if(c+1===s)break;r[c]=0,r[c+1]+=1}}return e}function ga(i){let t=i.shape.length;return F(t===i.stride.length,"Shape and stride must have the same length."),i.stride.map((e,s)=>({stride:e,index:s})).sort((e,s)=>s.stride-e.stride).map(e=>e.index)}function xa(i,t){let e=ga(i);return F(e.length===t.length,"Orders must match"),e.every((s,n)=>s===t[n])}var be,Ht;const gi=class gi{constructor(t,e){M(this,"kind","array_to_array");U(this,be);U(this,Ht);let s=t.order??"C",n=e.shape.length,r=new Array(n),a=new Array(n);if(s==="C")for(let o=0;o<n;++o)r[o]=o,a[o]=o;else if(s==="F")for(let o=0;o<n;++o)r[o]=n-o-1,a[o]=n-o-1;else r=s,r.forEach((o,h)=>{F(a[o]===void 0,`Invalid permutation: ${JSON.stringify(s)}`),a[o]=h});L(this,be,r),L(this,Ht,a)}static fromConfig(t,e){return new gi(t,e)}encode(t){return xa(t,E(this,Ht))?t:pa(t,E(this,Ht))}decode(t){return{data:t.data,shape:t.shape,stride:St(t.shape,E(this,be))}}};be=new WeakMap,Ht=new WeakMap;let Ms=gi;var Se,Ae;const xi=class xi{constructor(t){M(this,"kind","array_to_bytes");U(this,Se);U(this,Ae);L(this,Se,t),L(this,Ae,St(t,"C"))}static fromConfig(t,e){return new xi(e.shape)}encode(t){throw new Error("Method not implemented.")}decode(t){let e=new TextDecoder,s=new DataView(t.buffer),n=Array(s.getUint32(0,!0)),r=4;for(let a=0;a<n.length;a++){let o=s.getUint32(r,!0);r+=4,n[a]=e.decode(t.buffer.slice(r,r+o)),r+=o}return{data:n,shape:E(this,Se),stride:E(this,Ae)}}};Se=new WeakMap,Ae=new WeakMap;let Es=xi;class Hs{constructor(){M(this,"kind","bytes_to_bytes")}static fromConfig(t){return new Hs}encode(t){throw new Error("Zlib encoding is not enabled by default. Please register a codec with `numcodecs/zlib`.")}async decode(t){const e=await Cn(t,{format:"deflate"});return new Uint8Array(e)}}function _a(){return new Map().set("blosc",()=>import("./blosc-E49GQuAK.js").then(i=>i.default)).set("lz4",()=>import("./lz4-BIGKWw27.js").then(i=>i.default)).set("zstd",()=>import("./zstd-IvP746pw.js").then(i=>i.default)).set("gzip",()=>js).set("zlib",()=>Hs).set("transpose",()=>Ms).set("bytes",()=>$e).set("crc32c",()=>Xs).set("vlen-utf8",()=>Es).set("json2",()=>zs).set("bitround",()=>Ys)}const Dn=_a();function Is(i){let t;return{async encode(e){t||(t=await qi(i));for(const n of t.array_to_array)e=await n.encode(e);let s=await t.array_to_bytes.encode(e);for(const n of t.bytes_to_bytes)s=await n.encode(s);return s},async decode(e){t||(t=await qi(i));for(let n=t.bytes_to_bytes.length-1;n>=0;n--)e=await t.bytes_to_bytes[n].decode(e);let s=await t.array_to_bytes.decode(e);for(let n=t.array_to_array.length-1;n>=0;n--)s=await t.array_to_array[n].decode(s);return s}}}async function qi(i){let t=i.codecs.map(async r=>{var o;let a=await((o=Dn.get(r.name))==null?void 0:o());return F(a,`Unknown codec: ${r.name}`),{Codec:a,meta:r}}),e=[],s,n=[];for await(let{Codec:r,meta:a}of t){let o=r.fromConfig(a.configuration,i);switch(o.kind){case"array_to_array":e.push(o);break;case"array_to_bytes":s=o;break;default:n.push(o)}}return s||(F(wa(i),`Cannot encode ${i.data_type} to bytes without a codec`),s=$e.fromConfig({endian:"little"},i)),{array_to_array:e,array_to_bytes:s,bytes_to_bytes:n}}function wa(i){return i.data_type!=="v2:object"}class lt extends Error{constructor(t,e={}){super(`Node not found: ${t}`,e),this.name="NodeNotFoundError"}}class Jt extends Error{constructor(t){super(`Missing key: ${t}`),this.name="KeyError"}}async function ba(i,t){const e=t??".zmetadata";let s=await i.get(`/${e}`);if(!s)throw new lt("v2 consolidated metadata",{cause:new Jt(`/${e}`)});let n=Ct(s);return F(n.zarr_consolidated_format===1,"Unsupported consolidated format."),n}function Sa(i){return i.endsWith(".zarray")||i.endsWith(".zgroup")||i.endsWith(".zattrs")||i.endsWith("zarr.json")}function Aa(i){return"zarr_format"in i&&i.zarr_format===3}async function kn(i,t={}){var n;let e=await ba(i,t.metadataKey),s={};for(let[r,a]of Object.entries(e.metadata))s[`/${r}`]=a;return{async get(...r){let[a,o]=r;if(s[a])return Gs(s[a]);let h=await i.get(a,o);if(Sa(a)&&h){let l=Ct(h);s[a]=l}return h},getRange:(n=i.getRange)==null?void 0:n.bind(i),contents(){let r=[];for(let[a,o]of Object.entries(s)){let h=a.split("/"),l=h.pop(),c=h.join("/")||"/";l===".zarray"&&r.push({path:c,kind:"array"}),l===".zgroup"&&r.push({path:c,kind:"group"}),Aa(o)&&r.push({path:c,kind:o.node_type})}return r}}}async function za(i,t={}){return kn(i,t).catch(e=>($s(e,lt),i))}const Vi=18446744073709551615n;function Ma(i,t,e,s){F(i.store.getRange,"Store does not support range requests");let n=i.store.getRange.bind(i.store),r=t.map((h,l)=>h/s.chunk_shape[l]),a=Is({data_type:"uint64",shape:[...r,2],codecs:s.index_codecs}),o={};return async h=>{let l=h.map((x,w)=>Math.floor(x/r[w])),c=i.resolve(e(l)).path,u;if(c in o)u=o[c];else{let x=4,w=16*r.reduce((b,S)=>b*S,1),A=await n(c,{suffixLength:w+x});u=o[c]=A?await a.decode(A):null}if(u===null)return;let{data:f,shape:d,stride:m}=u,y=h.map((x,w)=>x%d[w]).reduce((x,w,A)=>x+w*m[A],0),g=f[y],p=f[y+1];if(!(g===Vi&&p===Vi))return n(c,{offset:Number(g),length:Number(p)})}}class ct{constructor(t,e="/"){M(this,"store");M(this,"path");this.store=t,this.path=e}resolve(t){let e=new URL(`file://${this.path.endsWith("/")?this.path:`${this.path}/`}`);return new ct(this.store,new URL(t,e).pathname)}}function Rn(i){return new ct(i??new Map)}var ze;class Ie extends ct{constructor(e,s,n){super(e,s);M(this,"kind","group");U(this,ze);L(this,ze,n)}get attrs(){return E(this,ze).attributes}}ze=new WeakMap;function Gi(i){var e;const t=i.find(s=>s.name==="transpose");return((e=t==null?void 0:t.configuration)==null?void 0:e.order)??"C"}const ae=Symbol("zarrita.context");function On(i){return i[ae]}function Ea(i,t){let{configuration:e}=t.codecs.find(ua)??{},s={encode_chunk_key:aa(t.chunk_key_encoding),TypedArray:In(t.data_type),fill_value:t.fill_value};if(e){let r=Gi(e.codecs);return{...s,kind:"sharded",chunk_shape:e.chunk_shape,codec:Is({data_type:t.data_type,shape:e.chunk_shape,codecs:e.codecs}),get_strides(a){return St(a,r)},get_chunk_bytes:Ma(i,t.chunk_grid.configuration.chunk_shape,s.encode_chunk_key,e)}}let n=Gi(t.codecs);return{...s,kind:"regular",chunk_shape:t.chunk_grid.configuration.chunk_shape,codec:Is({data_type:t.data_type,shape:t.chunk_grid.configuration.chunk_shape,codecs:t.codecs}),get_strides(r){return St(r,n)},async get_chunk_bytes(r,a){let o=s.encode_chunk_key(r),h=i.resolve(o).path;return i.store.get(h,a)}}}var pn,gn,Et,xn;let Kt=(xn=class extends(gn=ct,pn=ae,gn){constructor(e,s,n){super(e,s);M(this,"kind","array");U(this,Et);M(this,pn);L(this,Et,{...n,fill_value:Tn(n)}),this[ae]=Ea(this,n)}get attrs(){return E(this,Et).attributes}get shape(){return E(this,Et).shape}get chunks(){return this[ae].chunk_shape}get dtype(){return E(this,Et).data_type}async getChunk(e,s){let n=this[ae],r=await n.get_chunk_bytes(e,s);if(!r){let a=n.chunk_shape.reduce((h,l)=>h*l,1),o=new n.TypedArray(a);return o.fill(n.fill_value),{data:o,shape:n.chunk_shape,stride:n.get_strides(n.chunk_shape)}}return n.codec.decode(r)}is(e){return ca(this.dtype,e)}},Et=new WeakMap,xn);async function Ia(i,t={}){let e="store"in i?i:new ct(i);return"shape"in t?await Ca(e,t):Ta(e,t)}async function Ta(i,t={}){let e={zarr_format:3,node_type:"group",attributes:t.attributes??{}};return await i.store.set(i.resolve("zarr.json").path,Gs(e)),new Ie(i.store,i.path,e)}async function Ca(i,t){let e={zarr_format:3,node_type:"array",shape:t.shape,data_type:t.data_type,chunk_grid:{name:"regular",configuration:{chunk_shape:t.chunk_shape}},chunk_key_encoding:{name:"default",configuration:{separator:t.chunk_separator??"/"}},codecs:t.codecs??[],fill_value:t.fill_value??null,attributes:t.attributes??{}};return await i.store.set(i.resolve("zarr.json").path,Gs(e)),new Kt(i.store,i.path,e)}function*Da(i,t,e=1){t===void 0&&(t=i,i=0);for(let s=i;s<t;s+=e)yield s}function*ka(...i){if(i.length===0)return;const t=i.map(s=>s[Symbol.iterator]()),e=t.map(s=>s.next());if(e.some(s=>s.done))throw new Error("Input contains an empty iterator.");for(let s=0;;){if(e[s].done){if(t[s]=i[s][Symbol.iterator](),e[s]=t[s].next(),++s>=t.length)return}else yield e.map(({value:n})=>n),s=0;e[s]=t[s].next()}}function Ln({start:i,stop:t,step:e},s){if(e===0)throw new Error("slice step cannot be zero");e=e??1;const n=e<0,[r,a]=n?[-1,s-1]:[0,s];return i===null?i=n?a:r:i<0?(i+=s,i<r&&(i=r)):i>a&&(i=a),t===null?t=n?r:a:t<0?(t+=s,t<r&&(t=r)):t>a&&(t=a),[i,t,e]}function Ts(i,t,e=null){return t===void 0&&(t=i,i=null),{start:i,stop:t,step:e}}function Pn(){const i=[];return{add:t=>i.push(t()),onIdle:()=>Promise.all(i)}}class Ke extends Error{constructor(t){super(t),this.name="IndexError"}}function Ra(i,t){throw new Ke(`too many indicies for array; expected ${t.length}, got ${i.length}`)}function Oa(i){throw new Ke(`index out of bounds for dimension with length ${i}`)}function La(){throw new Ke("only slices with step >= 1 are supported")}function Pa(i,t){i.length>t.length&&Ra(i,t)}function Ua(i,t){return i=Math.trunc(i),i<0&&(i=t+i),(i>=t||i<0)&&Oa(t),i}class Fa{constructor({dim_sel:t,dim_len:e,dim_chunk_len:s}){M(this,"dim_sel");M(this,"dim_len");M(this,"dim_chunk_len");M(this,"nitems");t=Ua(t,e),this.dim_sel=t,this.dim_len=e,this.dim_chunk_len=s,this.nitems=1}*[Symbol.iterator](){const t=Math.floor(this.dim_sel/this.dim_chunk_len),e=t*this.dim_chunk_len,s=this.dim_sel-e;yield{dim_chunk_ix:t,dim_chunk_sel:s}}}class $i{constructor({dim_sel:t,dim_len:e,dim_chunk_len:s}){M(this,"start");M(this,"stop");M(this,"step");M(this,"dim_len");M(this,"dim_chunk_len");M(this,"nitems");M(this,"nchunks");const[n,r,a]=Ln(t,e);this.start=n,this.stop=r,this.step=a,this.step<1&&La(),this.dim_len=e,this.dim_chunk_len=s,this.nitems=Math.max(0,Math.ceil((this.stop-this.start)/this.step)),this.nchunks=Math.ceil(this.dim_len/this.dim_chunk_len)}*[Symbol.iterator](){const t=Math.floor(this.start/this.dim_chunk_len),e=Math.ceil(this.stop/this.dim_chunk_len);for(const s of Da(t,e)){const n=s*this.dim_chunk_len,r=Math.min(this.dim_len,(s+1)*this.dim_chunk_len),a=r-n;let o=0,h=0;if(this.start<n){const d=(n-this.start)%this.step;d&&(h+=this.step-d),o=Math.ceil((n-this.start)/this.step)}else h=this.start-n;const l=this.stop>r?a:this.stop-n,c=[h,l,this.step],u=Math.ceil((l-h)/this.step),f=[o,o+u,1];yield{dim_chunk_ix:s,dim_chunk_sel:c,dim_out_sel:f}}}}function va(i,t){let e=[];return i===null?e=t.map(s=>Ts(null)):Array.isArray(i)&&(e=i.map(s=>s??Ts(null))),Pa(e,t),e}class Un{constructor({selection:t,shape:e,chunk_shape:s}){M(this,"dim_indexers");M(this,"shape");this.dim_indexers=va(t,e).map((n,r)=>new(typeof n=="number"?Fa:$i)({dim_sel:n,dim_len:e[r],dim_chunk_len:s[r]})),this.shape=this.dim_indexers.filter(n=>n instanceof $i).map(n=>n.nitems)}*[Symbol.iterator](){for(const t of ka(...this.dim_indexers)){const e=t.map(n=>n.dim_chunk_ix),s=t.map(n=>"dim_out_sel"in n?{from:n.dim_chunk_sel,to:n.dim_out_sel}:{from:n.dim_chunk_sel,to:null});yield{chunk_coords:e,mapping:s}}}}function Na(i,t){return"get"in i?i.get(t):i[t]}async function Fn(i,t,e,s){var h;let n=On(i),r=new Un({selection:t,shape:i.shape,chunk_shape:i.chunks}),a=s.prepare(new n.TypedArray(r.shape.reduce((l,c)=>l*c,1)),r.shape,n.get_strides(r.shape)),o=((h=e.create_queue)==null?void 0:h.call(e))??Pn();for(const{chunk_coords:l,mapping:c}of r)o.add(async()=>{let{data:u,shape:f,stride:d}=await i.getChunk(l,e.opts),m=s.prepare(u,f,d);s.set_from_chunk(a,m,c)});return await o.onIdle(),r.shape.length===0?Na(a.data,0):a}function Ba(i){return i.to==null?{from:i.to,to:i.from}:{from:i.to,to:i.from}}async function vn(i,t,e,s,n){const r=On(i);if(r.kind==="sharded")throw new Error("Set not supported for sharded arrays.");const a=new Un({selection:t,shape:i.shape,chunk_shape:i.chunks}),o=i.chunks.reduce((l,c)=>l*c,1),h=s.create_queue?s.create_queue():Pn();for(const{chunk_coords:l,mapping:c}of a){const u=c.map(d=>d.from),f=c.map(Ba);h.add(async()=>{const d=i.resolve(r.encode_chunk_key(l)).path;let m;const y=i.chunks.slice(),g=r.get_strides(y);if(qa(u,y))if(m=new r.TypedArray(o),typeof e=="object"){const p=n.prepare(m,y.slice(),g.slice());n.set_from_chunk(p,e,f)}else m.fill(e);else{m=await i.getChunk(l).then(({data:x})=>x);const p=n.prepare(m,y.slice(),g.slice());typeof e=="object"?n.set_from_chunk(p,e,f):n.set_scalar(p,u,e)}await i.store.set(d,await r.codec.encode({data:m,shape:y,stride:g}))})}await h.onIdle()}function qa(i,t){return i.every((e,s)=>{if(typeof e=="number")return!1;const[n,r,a]=e;return r-n===t[s]&&a===1})}function Zs(i,t=0,e){let s=e??i.length-t;return{length:s,subarray(n,r=s){return Zs(i,t+n,r-n)},set(n,r=0){for(let a=0;a<n.length;a++)i[t+r+a]=n.get(a)},get(n){return i[t+n]}}}function cs(i){return globalThis.Array.isArray(i.data)?{data:Zs(i.data),stride:i.stride,bytes_per_element:1}:{data:new Uint8Array(i.data.buffer,i.data.byteOffset,i.data.byteLength),stride:i.stride,bytes_per_element:i.data.BYTES_PER_ELEMENT}}function Va(i){return"chars"in i?i.constructor.bind(null,i.chars):i.constructor}function Ga(i,t){if(globalThis.Array.isArray(i.data))return Zs([t]);let e=Va(i.data),s=new e([t]);return new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}const Nn={prepare(i,t,e){return{data:i,shape:t,stride:e}},set_scalar(i,t,e){let s=cs(i);Cs(s,t,Ga(i,e),s.bytes_per_element)},set_from_chunk(i,t,e){let s=cs(i);Ve(s,cs(t),s.bytes_per_element,e)}};async function Bn(i,t=null,e={}){return Fn(i,t,e,Nn)}async function $a(i,t,e,s={}){return vn(i,t,e,s,Nn)}function qn(i,t,e){return e<0&&t<i?Math.floor((i-t-1)/-e)+1:i<t?Math.floor((t-i-1)/e)+1:0}function Cs(i,t,e,s){if(t.length===0){i.data.set(e,0);return}const[n,...r]=t,[a,...o]=i.stride;if(typeof n=="number"){const f=i.data.subarray(a*n*s);Cs({data:f,stride:o},r,e,s);return}const[h,l,c]=n,u=qn(h,l,c);if(r.length===0){for(let f=0;f<u;f++)i.data.set(e,a*(h+c*f)*s);return}for(let f=0;f<u;f++){const d=i.data.subarray(a*(h+c*f)*s);Cs({data:d,stride:o},r,e,s)}}function Ve(i,t,e,s){const[n,...r]=s,[a,...o]=i.stride,[h,...l]=t.stride;if(n.from===null){if(r.length===0){i.data.set(t.data.subarray(0,e),n.to*e);return}Ve({data:i.data.subarray(a*n.to*e),stride:o},t,e,r);return}if(n.to===null){if(r.length===0){let p=n.from*e;i.data.set(t.data.subarray(p,p+e),0);return}Ve(i,{data:t.data.subarray(h*n.from*e),stride:l},e,r);return}const[c,u,f]=n.to,[d,m,y]=n.from,g=qn(c,u,f);if(r.length===0){if(f===1&&y===1&&a===1&&h===1){let p=d*e,x=g*e;i.data.set(t.data.subarray(p,p+x),c*e);return}for(let p=0;p<g;p++){let x=h*(d+y*p)*e;i.data.set(t.data.subarray(x,x+e),a*(c+f*p)*e)}return}for(let p=0;p<g;p++)Ve({data:i.data.subarray(a*(c+p*f)*e),stride:o},{data:t.data.subarray(h*(d+p*y)*e),stride:l},e,r)}let We=Ya();function Ya(){let i=new WeakMap;function t(e){let s=i.get(e)??{v2:0,v3:0};return i.set(e,s),s}return{increment(e,s){t(e)[s]+=1},version_max(e){let s=t(e);return s.v3>s.v2?"v3":"v2"}}}async function Xa(i){let t=await i.store.get(i.resolve(".zattrs").path);return t?Ct(t):{}}async function ja(i,t={}){let e="store"in i?i:new ct(i),s={};return(t.attrs??!0)&&(s=await Xa(e)),t.kind==="array"?Yi(e,s):t.kind==="group"?Xi(e,s):Yi(e,s).catch(n=>($s(n,lt),Xi(e,s)))}async function Yi(i,t){let{path:e}=i.resolve(".zarray"),s=await i.store.get(e);if(!s)throw new lt("v2 array",{cause:new Jt(e)});return We.increment(i.store,"v2"),new Kt(i.store,i.path,ha(Ct(s),t))}async function Xi(i,t){let{path:e}=i.resolve(".zgroup"),s=await i.store.get(e);if(!s)throw new lt("v2 group",{cause:new Jt(e)});return We.increment(i.store,"v2"),new Ie(i.store,i.path,la(Ct(s),t))}async function Ha(i){let{store:t,path:e}=i.resolve("zarr.json"),s=await i.store.get(e);if(!s)throw new lt("v3 array or group",{cause:new Jt(e)});let n=Ct(s);return n.node_type==="array"&&(n.fill_value=Tn(n)),n.node_type==="array"?new Kt(t,i.path,n):new Ie(t,i.path,n)}async function Za(i,t={}){let e="store"in i?i:new ct(i),s=await Ha(e);if(We.increment(e.store,"v3"),t.kind===void 0||t.kind==="array"&&s instanceof Kt||t.kind==="group"&&s instanceof Ie)return s;let n=s instanceof Kt?"array":"group";throw new Error(`Expected node of kind ${t.kind}, found ${n}.`)}async function ot(i,t={}){let e="store"in i?i.store:i,s=We.version_max(e),n=s==="v2"?ot.v2:ot.v3,r=s==="v2"?ot.v3:ot.v2;return n(i,t).catch(a=>($s(a,lt),r(i,t)))}ot.v2=ja;ot.v3=Za;var Ka=Object.freeze({__proto__:null,Array:Kt,BoolArray:Vs,ByteStringArray:Ze,FetchStore:En,Group:Ie,IndexError:Ke,KeyError:Jt,Location:ct,NodeNotFoundError:lt,UnicodeStringArray:Zt,_zarrita_internal_get:Fn,_zarrita_internal_get_strides:St,_zarrita_internal_set:vn,_zarrita_internal_slice_indices:Ln,create:Ia,get:Bn,open:ot,registry:Dn,root:Rn,set:$a,slice:Ts,tryWithConsolidated:za,withConsolidated:kn});const ji="request cancelled";class Vn{constructor(t=10,e=5){this.allRequests=new Map,this.activeRequests=new Set,this.queue=[],this.queueLowPriority=[],this.maxActiveRequests=t,this.maxLowPriorityRequests=Math.min(t,e)}registerRequest(t,e){let s,n;const r=new Promise((o,h)=>{s=o,n=h}),a={key:t,action:e,resolve:s,reject:n,promise:r};return this.allRequests.set(t,a),a}addRequestToQueue(t,e){if(this.allRequests.has(t)){const s=this.allRequests.get(t);s&&s.timeoutId&&(clearTimeout(s.timeoutId),s.timeoutId=void 0),!this.queue.includes(t)&&!this.queueLowPriority.includes(t)&&(e?this.queueLowPriority.push(t):this.queue.push(t),this.dequeue())}}addRequest(t,e,s=!1,n=0){var a;if(this.allRequests.has(t)){const o=this.queueLowPriority.indexOf(t);o>-1&&!s?(this.queueLowPriority.splice(o,1),this.addRequestToQueue(t)):n<=0&&this.addRequestToQueue(t,s)}else{const o=this.registerRequest(t,e);if(n>0){const h=setTimeout(()=>this.addRequestToQueue(t,s),n);o.timeoutId=h}else this.addRequestToQueue(t,s)}const r=(a=this.allRequests.get(t))==null?void 0:a.promise;if(!r)throw new Error("Found no promise to return when getting stored request data.");return r}addRequests(t,e=!1,s=10){const n=[];for(let r=0;r<t.length;r++){const a=t[r],o=this.addRequest(a.key,a.requestAction,e,s*r);n.push(o)}return n}async dequeue(){const t=this.activeRequests.size;if(t>=this.maxActiveRequests||this.queue.length===0&&(t>=this.maxLowPriorityRequests||this.queueLowPriority.length===0))return;const e=this.queue.shift()??this.queueLowPriority.shift();if(!e)return;if(this.activeRequests.has(e)){this.dequeue();return}const s=this.allRequests.get(e);if(!s)return;const n=s.key;this.activeRequests.add(n),await s.action().then(s.resolve,s.reject),this.activeRequests.delete(n),this.allRequests.delete(n),this.dequeue()}cancelRequest(t,e=ji){if(!this.allRequests.has(t))return;const s=this.allRequests.get(t);s&&(s.timeoutId&&clearTimeout(s.timeoutId),s.reject(e));const n=this.queue.indexOf(t);if(n>-1)this.queue.splice(n,1);else{const r=this.queueLowPriority.indexOf(t);r>-1&&this.queueLowPriority.splice(r,1)}this.allRequests.delete(t),this.activeRequests.delete(t)}cancelAllRequests(t=ji){this.queue=[],this.queueLowPriority=[];for(const e of this.allRequests.keys())this.cancelRequest(e,t)}hasRequest(t){return this.allRequests.has(t)}requestRunning(t){return this.activeRequests.has(t)}}class Gn{constructor(t,e){typeof t=="number"||t===void 0?this.queue=new Vn(t,e):this.queue=t,this.nextSubscriberId=0,this.subscribers=new Map,this.requests=new Map}resolveAll(t,e){var n;const s=this.requests.get(t);if(s){for(const{resolve:r,subscriberId:a}of s)r(e),(n=this.subscribers.get(a))==null||n.delete(t);this.requests.delete(t)}}rejectAll(t,e){var n;const s=this.requests.get(t);if(s){for(const{reject:r,subscriberId:a}of s)r(e),(n=this.subscribers.get(a))==null||n.delete(t);this.requests.delete(t)}}addSubscriber(){const t=this.nextSubscriberId;return this.nextSubscriberId++,this.subscribers.set(t,new Map),t}addRequest(t,e,s,n,r){if(this.queue.addRequest(t,s,n,r).then(o=>this.resolveAll(t,o)).catch(o=>this.rejectAll(t,o)),this.requests.has(t)||this.requests.set(t,[]),e>=this.nextSubscriberId||e<0)throw new Error(`SubscribableRequestQueue: subscriber id ${e} has not been registered`);if(!this.subscribers.get(e))throw new Error(`SubscribableRequestQueue: subscriber id ${e} has been removed`);return new Promise((o,h)=>{var u;(u=this.requests.get(t))==null||u.push({resolve:o,reject:h,subscriberId:e});const l=this.subscribers.get(e),c=l==null?void 0:l.get(t);c?c.push(h):l==null||l.set(t,[h])})}rejectSubscription(t,e,s){e(s);const n=this.requests.get(t);if(!n)return;const r=n.findIndex(a=>a.reject===e);r>=0&&n.splice(r,1),n.length<1&&!this.queue.requestRunning(t)&&(this.queue.cancelRequest(t,s),this.requests.delete(t))}cancelRequest(t,e,s){const n=this.subscribers.get(e);if(!n)return!1;const r=n.get(t);if(!r||!r.length)return!1;for(const a of r)this.rejectSubscription(t,a,s);return n.delete(t),!0}removeSubscriber(t,e){const s=this.subscribers.get(t);if(s){for(const[n,r]of s.entries())for(const a of r)this.rejectSubscription(n,a,e);this.subscribers.delete(t)}}hasRequest(t){return this.queue.hasRequest(t)}requestRunning(t){return this.queue.requestRunning(t)}hasSubscriber(t){return this.subscribers.has(t)}isSubscribed(t,e){var s;return((s=this.subscribers.get(t))==null?void 0:s.has(e))??!1}}const Ds={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float32:Float32Array,float64:Float64Array};function Wa(i){return i instanceof Float32Array||i instanceof Float64Array}const Hi=256;class xt{constructor(t){this.dataMinBin=0,this.dataMaxBin=0,this.maxBin=0,this.bins=new Uint32Array,this.min=0,this.max=0,this.binSize=0;const e=xt.calculateHistogram(t,Hi);this.bins=e.bins,this.min=e.min,this.max=e.max,this.binSize=e.binSize;for(let n=0;n<this.bins.length;n++)if(this.bins[n]>0){this.dataMinBin=n;break}for(let n=this.bins.length-1;n>=0;n--)if(this.bins[n]>0){this.dataMaxBin=n;break}this.pixelCount=t.length,this.maxBin=1;let s=this.bins[1];for(let n=1;n<this.bins.length;n++)this.bins[n]>s&&(this.maxBin=n,s=this.bins[n])}static findBin(t,e,s,n){const r=(t-e)/s;return n?Math.max(Math.min(Math.floor(r),Hi-1),0):r}findBinOfValue(t){return xt.findBin(t,this.min,this.binSize,!0)}findFractionalBinOfValue(t){return xt.findBin(t,this.min,this.binSize,!1)}getValueFromBinIndex(t){return this.min+t*this.binSize}getDataMin(){return this.min}getDataMax(){return this.max}getMin(){return this.dataMinBin}getMax(){return this.dataMaxBin}getNumBins(){return this.bins.length}getBin(t){return this.bins[t]}getBinRange(t){return[this.min+t*this.binSize,this.min+(t+1)*this.binSize]}findBinOfPercentile(t){const e=this.pixelCount*t;let s=0,n=0;for(s=0;s<this.bins.length&&(n+=this.bins[s],!(n>e));++s);return s}findBestFitBins(){const e=this.pixelCount/10;let s=0,n=0;for(s=1;s<this.bins.length&&(n+=this.bins[s],!(n>e));++s);const r=s;for(n=0,s=this.bins.length-1;s>=1&&(n+=this.bins[s],!(n>e));--s);return[r,s]}findAutoIJBins(){const e=this.pixelCount,s=e/10,n=e/5e3;let r=this.bins.length-1,a=1;for(let o=1;o<this.bins.length;++o)if(this.bins[o]>n&&this.bins[o]<=s){r=o;break}for(let o=this.bins.length-1;o>=1;--o)if(this.bins[o]>n&&this.bins[o]<=s){a=o;break}return a<r&&(r=0,a=255),[r,a]}findAutoMinMax(){const e=Math.floor(this.bins[this.maxBin]*.1);let s=0,n=this.bins.length-1;for(let r=1;r<this.bins.length;++r)if(this.bins[r]>e){s=r;break}for(let r=this.bins.length-1;r>=1;--r)if(this.bins[r]>e){n=r;break}return[s,n]}static calculateHistogram(t,e=1){e<1&&(e=1);let s=t[0],n=t[0];for(let h=1;h<t.length;h++)t[h]<s?s=t[h]:t[h]>n&&(n=t[h]);const r=new Uint32Array(e).fill(0),a=Wa(t)?n:n+1,o=a<=s?1:(a-s)/e;for(let h=0;h<t.length;h++){const l=t[h],c=xt.findBin(l,s,o,!0);r[c]++}return{bins:r,min:s,max:n,binSize:o}}}const us=[[255,0,255],[255,255,255],[0,255,255]];function Ja(i,t,e){let s,n,r,a=0;if(arguments.length===1){const f=i;t=f.s,e=f.v,a=f.h}else a=i;const o=Math.floor(a*6),h=a*6-o,l=e*(1-t),c=e*(1-h*t),u=e*(1-(1-h)*t);switch(o%6){case 0:s=e,n=u,r=l;break;case 1:s=c,n=e,r=l;break;case 2:s=l,n=e,r=u;break;case 3:s=l,n=c,r=e;break;case 4:s=u,n=l,r=e;break;case 5:s=e,n=l,r=c;break}return[Math.round(s*255),Math.round(n*255),Math.round(r*255)]}function Qa(i){return function(){return i=Math.imul(48271,i)|0%2147483647,(i&2147483647)/2147483648}}const fs=Qa(123),oe=i=>(us[i]||(us[i]=Ja(fs(),fs()*.5+.5,fs()*.5+.5)),us[i]);function Vt(i,t,e){return Math.min(Math.max(t,i),e)}function _t(i,t,e){return e*(t-i)+i}function to(i,t,e,s,n,r,a){const o=(i-t)/(e-t),l=((a-r)*o+r-s)/(n-s);return t+l*(e-t)}function eo(i,t,e,s,n,r,a){const o=(i-t)/(e-t),l=((n-s)*o+s-r)/(a-r);return t+l*(e-t)}const et=256,pt=et*4;function so(i){const t=et,e=new Uint8Array(t*4).fill(0);if(i.length===0)return e;if(i.sort((l,c)=>l.x-c.x),i.length===1){const l=Ue(i[0]),c=Vt(i[0].x,0,255);for(let u=c;u<t;++u)e[u*4+0]=l[0],e[u*4+1]=l[1],e[u*4+2]=l[2],e[u*4+3]=l[3];return e}let s=i[0],n=i[1],r=Ue(s),a=Ue(n),o=1,h=0;for(let l=0;l<t;++l){for(;l>n.x;)s=n,r=a,o++,o>=i.length?n={x:255,color:n.color,opacity:n.opacity}:n=i[o],a=Ue(n);n.x===s.x?h=1:h=(l-s.x)/(n.x-s.x),e[l*4+0]=Vt(_t(r[0],a[0],h),0,255),e[l*4+1]=Vt(_t(r[1],a[1],h),0,255),e[l*4+2]=Vt(_t(r[2],a[2],h),0,255),e[l*4+3]=Vt(_t(r[3],a[3],h),0,255)}return e}function Ue(i){return[i.color[0],i.color[1],i.color[2],Math.floor(i.opacity*255)]}const ds=(i=0,t=1)=>[{x:0,opacity:i,color:[255,255,255]},{x:255,opacity:t,color:[255,255,255]}];class io{constructor(){this.lut=new Uint8Array(pt),this.controlPoints=[],this.createFullRange()}createFromMinMax(t,e){if(e<t){const a=e;e=t,t=a}if(t<0&&e<0)return this.controlPoints=ds(1,1),this.createFromControlPoints(this.controlPoints);if(t>=255&&e>=255)return this.controlPoints=ds(0,0),this.createFromControlPoints(this.controlPoints);const s=[];let n=0;t<0&&(n=-t/(e-t)),s.push({x:0,opacity:n,color:[255,255,255]}),t>0&&s.push({x:t,opacity:0,color:[255,255,255]}),e<255&&(e===t?s.push({x:t+.5,opacity:1,color:[255,255,255]}):s.push({x:e,opacity:1,color:[255,255,255]}));let r=1;return e>255&&(r=(255-t)/(e-t)),s.push({x:255,opacity:r,color:[255,255,255]}),this.createFromControlPoints(s)}createFullRange(){return this.controlPoints=ds(),this.createFromControlPoints(this.controlPoints)}createFromWindowLevel(t,e){const s=e-t*.5,n=e+t*.5;return this.createFromMinMax(s*255,n*255)}createFromControlPoints(t){return this.lut=so(t),this.controlPoints=t,this}createFromEqHistogram(t){const e=[];for(let n=0;n<t.getNumBins();++n)e[n]=0;e[0]=t.getBin(0);for(let n=1;n<t.getNumBins();++n)e[n]=e[n-1]+t.getBin(n);if(e[e.length-1]-e[0]>0){const n=[{x:0,opacity:0,color:[255,255,255]}];let r=0,a=0,o=0,h=0;for(let l=1;l<et;++l)h=o,o=Vt(Math.round(255*(e[l]-e[0])),0,255),r=o-h,r!=a&&(n.push({x:l-1,opacity:h/255,color:[255,255,255]}),a=r);return n.push({x:255,opacity:1,color:[255,255,255]}),this.createFromControlPoints(n)}else return this.createFullRange()}createLabelColors(t){const e=new Uint8Array(pt).fill(0),s=[];s.push({x:0,opacity:0,color:[0,0,0]});let n=0,r=0,a=0,o=0,h=0,l=0,c=0,u=0;for(let f=1;f<et;++f){const d=Math.floor(f/(et-1)*(t.getNumBins()-1));if(t.getBin(d)>0){const m=oe(d);e[f*4+0]=m[0],e[f*4+1]=m[1],e[f*4+2]=m[2],e[f*4+3]=255,h=m[0],l=m[1],c=m[2],u=1}else h=0,l=0,c=0,u=0;(h!==n||l!==r||c!==a||u!==o)&&(o===0&&s.push({x:f-.5,opacity:o,color:[n,r,a]}),s.push({x:f,opacity:u,color:[h,l,c]}),n=h,r=l,a=c,o=u)}return this.lut=e,this.controlPoints=s,this}remapDomains(t,e,s,n){this.lut=no(this.lut,t,e,s,n),this.controlPoints=ro(this.controlPoints,t,e,s,n)}}function no(i,t,e,s,n){const r=new Uint8Array(pt);for(let a=0;a<et;++a){let o=to(a,0,et-1,t,e,s,n);o<0&&(o=0),o>et-1&&(o=et-1);const h=Math.floor(o),l=Math.ceil(o),c=o-h;r[a*4+0]=Math.round(_t(i[h*4+0],i[l*4+0],c)),r[a*4+1]=Math.round(_t(i[h*4+1],i[l*4+1],c)),r[a*4+2]=Math.round(_t(i[h*4+2],i[l*4+2],c)),r[a*4+3]=Math.round(_t(i[h*4+3],i[l*4+3],c))}return r}function ro(i,t,e,s,n,r=!0){if(i.length===0)return i;const a=[],o=i[0].x,h=i[i.length-1].x;for(let l=0;l<i.length;++l){const c=i[l],f={x:eo(c.x,0,et-1,t,e,s,n),opacity:c.opacity,color:[c.color[0],c.color[1],c.color[2]]};a.push(f)}return r?ao(a,o,h):a}function ao(i,t,e){const n=i[0],r=i[1],a=i[i.length-2],o=i[i.length-1];return Math.abs(n.opacity-((r==null?void 0:r.opacity)??1/0))<1e-4&&(n.x<0?n.x=Math.min(0,r.x-1):t<1e-4&&(n.x=0)),Math.abs(o.opacity-((a==null?void 0:a.opacity)??1/0))<1e-4&&(o.x>255?o.x=Math.max(255,a.x+1):e>255-1e-4&&(o.x=255)),i}class Zi{constructor(t){this.loaded=!1,this.dtype="uint8",this.imgData={data:new Uint8Array,width:0,height:0},this.rawMin=0,this.rawMax=255,this.frame=0,this.dataTexture=new ls(new Uint8Array,0,0),this.lutTexture=new ls(new Uint8Array(pt),256,1,An,qe),this.lutTexture.minFilter=this.lutTexture.magFilter=Sn,this.lutTexture.generateMipmaps=!1,this.volumeData=new Uint8Array,this.name=t,this.histogram=new xt(new Uint8Array),this.dims=[0,0,0],this.lut=new io().createFromMinMax(0,255),this.colorPalette=new Uint8Array(pt).fill(0),this.colorPaletteAlpha=0}combineLuts(t,e){const s=e||new Uint8Array(pt);if(!t)return s;const n=[t[0]/255,t[1]/255,t[2]/255];if(this.colorPaletteAlpha===1)s.set(this.colorPalette);else if(this.colorPaletteAlpha===0){s.set(this.lut.lut);for(let r=0;r<pt/4;++r)s[r*4+0]*=n[0],s[r*4+1]*=n[1],s[r*4+2]*=n[2]}else for(let r=0;r<pt/4;++r)s[r*4+0]=this.colorPalette[r*4+0]*this.colorPaletteAlpha+this.lut.lut[r*4+0]*(1-this.colorPaletteAlpha)*n[0],s[r*4+1]=this.colorPalette[r*4+1]*this.colorPaletteAlpha+this.lut.lut[r*4+1]*(1-this.colorPaletteAlpha)*n[1],s[r*4+2]=this.colorPalette[r*4+2]*this.colorPaletteAlpha+this.lut.lut[r*4+2]*(1-this.colorPaletteAlpha)*n[2],s[r*4+3]=this.colorPalette[r*4+3]*this.colorPaletteAlpha+this.lut.lut[r*4+3]*(1-this.colorPaletteAlpha);return this.lutTexture.image.data.set(s),this.lutTexture.needsUpdate=!0,s}setRawDataRange(t,e){!(this.rawMin===0&&this.rawMax===0)&&!(t===0&&e===0)&&(this.lut.remapDomains(this.rawMin,this.rawMax,t,e),this.rawMin=t,this.rawMax=e)}getHistogram(){return this.histogram}getIntensity(t,e,s){return this.volumeData[t+e*this.dims[0]+s*(this.dims[0]*this.dims[1])]}normalizeRaw(t){return(t-this.rawMin)/(this.rawMax-this.rawMin)}getIntensityFromAtlas(t,e,s){const n=this.imgData.width/this.dims[0],r=s%n,a=Math.floor(s/n),o=r*this.dims[0]+t+(a*this.dims[1]+e)*this.imgData.width;return this.imgData.data[o]}rebuildDataTexture(t,e,s){this.dataTexture&&this.dataTexture.dispose();let n=$r,r=qe,a="LUMINANCE";switch(this.dtype){case"uint8":r=qe,n=Rt,a="R8UI";break;case"int8":r=vr,n=Rt,a="R8I";break;case"uint16":r=Br,n=Rt,a="R16UI";break;case"int16":r=Nr,n=Rt,a="R16I";break;case"uint32":r=Vr,n=Rt,a="R32UI";break;case"int32":r=qr,n=Rt,a="R32I";break;case"float32":r=Gr,n=Yr,a="R32F";break;default:console.warn("unsupported dtype for channel data",this.dtype);break}this.dataTexture=new ls(t,e,s,n,r,Bs,Gt,Gt,Ge,Ge),this.dataTexture.internalFormat=a,this.dataTexture.needsUpdate=!0}setFromAtlas(t,e,s,n,r,a,o,h=0){this.dtype=n,this.imgData={data:t,width:e,height:s},this.rebuildDataTexture(this.imgData.data,e,s),this.loaded=!0,this.histogram=new xt(t),this.frame=h,this.setRawDataRange(r,a),this.unpackFromAtlas(o.x,o.y,o.z)}unpackFromAtlas(t,e,s){const n=this.imgData.data;this.dims=[t,e,s];const r=Ds[this.dtype];this.volumeData=new r(t*e*s);const a=this.imgData.width/t,o=this.imgData.width;let h=0,l=0,c=0,u=0,f=0;for(let d=0;d<s;++d){h=d%a,l=Math.floor(d/a),c=h*t+l*e*o;for(let m=0;m<e;++m)u=m*o,f=d*(t*e)+m*t,this.volumeData.set(n.subarray(c+u,c+u+t),f)}}setFromVolumeData(t,e,s,n,r,a,o,h,l,c=0){this.dims=[e,s,n],this.volumeData=t,this.dtype=l,this.frame=c,this.packToAtlas(e,s,n,r,a),this.loaded=!0,this.setRawDataRange(o,h),this.histogram=new xt(this.volumeData)}packToAtlas(t,e,s,n,r){(n%t!==0||r%e!==0||n/t*(r/e)<s)&&(console.log("ERROR - atlas and volume dims are inconsistent"),console.log(n,r,t,e,s));const a=Ds[this.dtype];this.imgData={width:n,height:r,data:new a(n*r)},this.imgData.data.fill(0);const o=this.imgData.data,h=t,l=e,c=s,u=this.imgData.width/h,f=this.imgData.width;let d=0,m=0,y=0,g=0,p=0;for(let x=0;x<c;++x){d=x%u,m=Math.floor(x/u),y=d*h+m*l*f;for(let w=0;w<l;++w)g=w*f,p=x*(h*l)+w*h,o.set(this.volumeData.subarray(p,p+h),y+g)}this.rebuildDataTexture(this.imgData.data,n,r)}setLut(t){this.lut=t}setColorPalette(t){this.colorPalette=t}setColorPaletteAlpha(t){this.colorPaletteAlpha=t}}function Ki(i){return new _(i.shape[4],i.shape[3],i.shape[2])}function oo(i){return new _(i.spacing[4],i.spacing[3],i.spacing[2])}function $n(){return{name:"",atlasTileDims:[1,1],subregionSize:[1,1,1],subregionOffset:[0,0,0],numChannelsPerSource:[1],channelNames:["0"],channelColors:[[255,255,255]],multiscaleLevel:0,multiscaleLevelDims:[{shape:[1,1,1,1,1],spacing:[1,1,1,1,1],spaceUnit:"",timeUnit:"",dataType:"uint8"}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}}}class Je{constructor(t){this.imageInfo=t||$n()}get currentLevelDims(){return this.imageInfo.multiscaleLevelDims[this.imageInfo.multiscaleLevel]}get numChannels(){return this.imageInfo.numChannelsPerSource.reduce((t,e)=>t+e,0)}get numChannelsPerSource(){return this.imageInfo.numChannelsPerSource}get originalSize(){return Ki(this.imageInfo.multiscaleLevelDims[0])}get volumeSize(){return Ki(this.currentLevelDims)}get physicalPixelSize(){return oo(this.imageInfo.multiscaleLevelDims[0])}get spatialUnit(){return this.imageInfo.multiscaleLevelDims[0].spaceUnit}get times(){return this.currentLevelDims.shape[0]}get timeScale(){return this.currentLevelDims.spacing[0]}get timeUnit(){return this.currentLevelDims.timeUnit}get numMultiscaleLevels(){return this.imageInfo.multiscaleLevelDims.length}get channelNames(){return this.imageInfo.channelNames}get channelColors(){return this.imageInfo.channelColors}get subregionSize(){return new _(...this.imageInfo.subregionSize)}get subregionOffset(){return new _(...this.imageInfo.subregionOffset)}get multiscaleLevel(){return this.imageInfo.multiscaleLevel}get atlasTileDims(){return new It(...this.imageInfo.atlasTileDims)}get transform(){return{translation:new _(...this.imageInfo.transform.translation),rotation:new _(...this.imageInfo.transform.rotation),scale:new _(...this.imageInfo.transform.scale)}}}function ho(i){const{atlasTileDims:t}=i,e=i.multiscaleLevelDims[i.multiscaleLevel];return[t[0]*e.shape[4],t[1]*e.shape[3]]}const ce=4096,Fe={angstrom:"",day:"d",foot:"ft",hour:"h",inch:"in",meter:"m",micron:"m",mile:"mi",minute:"min",parsec:"pc",second:"s",yard:"yd"},lo=["meter","second"],Wi={micro:"",deca:"da"};function Ji(i){if(i===void 0)return null;if(Fe[i])return Fe[i];const t=lo.find(e=>i.endsWith(e));if(t){const e=i.substring(0,i.length-t.length);return Wi[e]?Wi[e]+Fe[t]:(e.endsWith("a")?e[0].toUpperCase():e[0])+Fe[t]}return null}function ue(i,t,e){let s=1,n=i,r=n*t/(s*e),a=s,o=n;for(;r>1;)a=s,o=n,n-=1,s=Math.ceil(i/n),r=n*t/(s*e);return new It(a,o)}function Yn(i,t=ce){const e=i[2],s=i[1],n=i[0],r=Math.floor(t/e),a=Math.floor(t/s);return r*a>=n}function co(i,t=ce){if(i.length<=1)return 0;for(let e=0;e<i.length;++e)if(Yn(i[e],t))return e}const ms=i=>Math.max(Math.ceil(i),1),uo=(i,[t,e,s])=>[ms(t*i.z),ms(e*i.y),ms(s*i.x)];function fo(i,t){const e=i.getSize(new _);return t.map(s=>uo(e,s))}function Xn(i,t){if(i.useExplicitLevel&&i.multiscaleLevel!==void 0)return Math.max(0,Math.min(t.length-1,i.multiscaleLevel));let e=co(t,i.maxAtlasEdge);if(e!==void 0&&(e=Math.max(e+(i.scaleLevelBias??0),i.multiscaleLevel??0),e=Math.max(0,Math.min(t.length-1,e)),Yn(t[e],i.maxAtlasEdge)))return e;e===void 0&&(e=t.length-1);const s=t[e];return console.error(`Volume is too large; no multiscale level found that fits in preferred memory footprint. Selected level ${e}  has dimensions `,s,`. Max atlas edge allowed is ${i.maxAtlasEdge}.`),console.log("All available levels: ",t),e}function Qi(i,t){const e=fo(i.subregion,t);return Xn(i,e)}function tn(i,t){const e=i.min.clone().multiply(t).floor(),s=i.max.clone().multiply(t).ceil();return e.x===s.x&&e.x<t.x&&(s.x+=1),e.y===s.y&&e.y<t.y&&(s.y+=1),e.z===s.z&&e.z<t.z&&(s.z+=1),new st(e,s)}function en(i,t){const e=t.getSize(new _),s=i.min.clone().multiply(e).add(t.min),n=i.max.clone().multiply(e).add(t.min);return new st(s,n)}function mo(i){for(const t in i)if(Object.prototype.hasOwnProperty.call(i,t))return!1;return!0}function yo(i){const t=new Je(i),e=t.volumeSize.clone().multiply(t.physicalPixelSize),s={};s.Dimensions={...t.subregionSize},s["Original dimensions"]={...t.originalSize},s["Physical size"]={x:e.x+t.spatialUnit,y:e.y+t.spatialUnit,z:e.z+t.spatialUnit},s["Physical size per pixel"]={x:t.physicalPixelSize.x+t.spatialUnit,y:t.physicalPixelSize.y+t.spatialUnit,z:t.physicalPixelSize.z+t.spatialUnit},s["Multiresolution levels"]=i.multiscaleLevelDims;const n=t.numChannelsPerSource.reduce((r,a)=>r+a,0);return s.Channels=n,s["Time series frames"]=t.times||1,i.userData&&!mo(i.userData)&&(s["User data"]=i.userData),s}class po{constructor(t=$n(),e=new jn,s){if(this.loaded=!1,this.imageInfo=new Je(t),this.name=t.name,this.loadSpec={multiscaleLevel:0,scaleLevelBias:0,maxAtlasEdge:ce,channels:Array.from({length:this.imageInfo.numChannels},(n,r)=>r),...e},this.loadSpecRequired={...this.loadSpec,channels:this.loadSpec.channels.slice(),subregion:this.loadSpec.subregion.clone()},this.loader=s,this.imageMetadata={},this.normRegionSize=new _(1,1,1),this.normRegionOffset=new _(0,0,0),this.physicalSize=new _(1,1,1),this.physicalScale=1,this.normPhysicalSize=new _(1,1,1),this.physicalPixelSize=this.imageInfo.physicalPixelSize,this.tickMarkPhysicalLength=1,this.setVoxelSize(this.physicalPixelSize),this.numChannels=this.imageInfo.numChannels,this.channelNames=this.imageInfo.channelNames.slice(),this.channelColorsDefault=this.imageInfo.channelColors?this.imageInfo.channelColors.map((n,r)=>n??oe(r)):this.channelNames.map((n,r)=>oe(r)),this.channelColorsDefault.length<this.imageInfo.numChannels)for(let n=this.channelColorsDefault.length-1;n<this.imageInfo.numChannels;++n)this.channelColorsDefault[n]=oe(n);this.channels=[];for(let n=0;n<this.imageInfo.numChannels;++n){const r=new Zi(this.channelNames[n]);this.channels.push(r),r.dims=this.imageInfo.subregionSize.toArray()}this.physicalUnitSymbol=this.imageInfo.spatialUnit,this.volumeDataObservers=[]}setUnloaded(){this.loaded=!1,this.channels.forEach(t=>{t.loaded=!1})}isLoaded(){return this.loaded}updateDimensions(){const{volumeSize:t,subregionSize:e,subregionOffset:s}=this.imageInfo;this.setVoxelSize(this.physicalPixelSize),this.normRegionSize=e.clone().divide(t),this.normRegionOffset=s.clone().divide(t)}mustLoadNewData(){return this.loadSpec.useExplicitLevel!==this.loadSpecRequired.useExplicitLevel||this.loadSpec.time!==this.loadSpecRequired.time||!this.loadSpec.subregion.containsBox(this.loadSpecRequired.subregion)||this.loadSpecRequired.channels.some(t=>!this.loadSpec.channels.includes(t))}mayLoadNewScaleLevel(){return!this.loadSpec.subregion.equals(this.loadSpecRequired.subregion)||this.loadSpecRequired.maxAtlasEdge!==this.loadSpec.maxAtlasEdge||this.loadSpecRequired.multiscaleLevel!==this.loadSpec.multiscaleLevel||this.loadSpecRequired.scaleLevelBias!==this.loadSpec.scaleLevelBias}async updateRequiredData(t,e){this.loadSpecRequired={...this.loadSpecRequired,...t};let s=this.mustLoadNewData();if(!s&&this.mayLoadNewScaleLevel()){const n=await this.loadScaleLevelDims();if(n){const r=n.map(({shape:o})=>[o[2],o[3],o[4]]),a=Xn(this.loadSpecRequired,r);s=this.imageInfo.multiscaleLevel!==a}}s&&await this.loadNewData(e)}async loadScaleLevelDims(){var t;try{return await((t=this.loader)==null?void 0:t.loadDims(this.loadSpecRequired))}catch(e){this.volumeDataObservers.forEach(s=>s.onVolumeLoadError(this,e));return}}async loadNewData(t){var e;this.setUnloaded(),this.loadSpec={...this.loadSpecRequired,subregion:this.loadSpecRequired.subregion.clone()};try{await((e=this.loader)==null?void 0:e.loadVolumeData(this,void 0,t))}catch(s){throw this.volumeDataObservers.forEach(n=>n.onVolumeLoadError(this,s)),s}}setVoxelSize(t){t.x=t.x>0?t.x:1,t.y=t.y>0?t.y:1,t.z=t.z>0?t.z:1,this.physicalPixelSize=t,this.physicalSize=this.imageInfo.originalSize.clone().multiply(this.physicalPixelSize),this.physicalScale=Math.max(this.physicalSize.x,this.physicalSize.y,this.physicalSize.z),this.normPhysicalSize=this.physicalSize.clone().divideScalar(this.physicalScale),this.tickMarkPhysicalLength=10**Math.floor(Math.log10(this.physicalScale/2))}setUnitSymbol(t){this.physicalUnitSymbol=t}getContentCenter(){return this.normRegionSize.clone().divideScalar(2).add(this.normRegionOffset).subScalar(.5).multiply(this.normPhysicalSize)}cleanup(){}getChannel(t){return this.channels[t]}onChannelLoaded(t){this.loadSpec.channels.every(e=>this.channels[e].loaded)&&(this.loaded=!0),t.forEach(e=>{var s;return(s=this.channelLoadCallback)==null?void 0:s.call(this,this,e)}),this.volumeDataObservers.forEach(e=>e.onVolumeData(this,t))}setChannelDataFromAtlas(t,e,s,n,r,a="uint8",o=0){this.channels[t].setFromAtlas(e,s,n,a,r[0],r[1],this.imageInfo.subregionSize,o),this.onChannelLoaded([t])}setChannelDataFromVolume(t,e,s,n="uint8",r=0){const{subregionSize:a,atlasTileDims:o}=this.imageInfo;this.channels[t].setFromVolumeData(e,a.x,a.y,a.z,o.x*a.x,o.y*a.y,s[0],s[1],n,r),this.onChannelLoaded([t])}appendEmptyChannel(t,e){const s=this.imageInfo.numChannels,n=t||"channel_"+s,r=e||oe(s);this.numChannels+=1,this.channelNames.push(n),this.channelColorsDefault.push(r),this.channels.push(new Zi(n));for(let a=0;a<this.volumeDataObservers.length;++a)this.volumeDataObservers[a].onVolumeChannelAdded(this,s);return s}getIntensity(t,e,s,n){return this.channels[t].getIntensity(e,s,n)}getHistogram(t){return this.channels[t].getHistogram()}setLut(t,e){this.channels[t].setLut(e)}setColorPalette(t,e){this.channels[t].setColorPalette(e)}setColorPaletteAlpha(t,e){this.channels[t].setColorPaletteAlpha(e)}getRotation(){return this.imageInfo.transform.rotation.toArray()}getTranslation(){return this.voxelsToWorldSpace(this.imageInfo.transform.translation.toArray())}voxelsToWorldSpace(t){const e=1/Math.max(this.physicalSize.x,Math.max(this.physicalSize.y,this.physicalSize.z));return new _().fromArray(t).multiply(this.physicalPixelSize).multiplyScalar(e).toArray()}addVolumeDataObserver(t){this.volumeDataObservers.push(t)}removeVolumeDataObserver(t){if(t){const e=this.volumeDataObservers.indexOf(t);e!==-1&&this.volumeDataObservers.splice(e,1)}}removeAllVolumeDataObservers(){this.volumeDataObservers=[]}}class jn{constructor(){M(this,"time",0);M(this,"subregion",new st(new _(0,0,0),new _(1,1,1)));M(this,"useExplicitLevel",!1)}}class Qe{setPrefetchPriority(t){}syncMultichannelLoading(t){}updateFetchOptions(t){}async createVolume(t,e){const{imageInfo:s,loadSpec:n}=await this.createImageInfo(t),r=new po(s,n,this);return r.channelLoadCallback=e,r.imageMetadata=yo(s),r}async loadVolumeData(t,e,s){const n=(o,h)=>{o&&(t.imageInfo=new Je(o),t.updateDimensions()),t.loadSpec={...h,...a}},r=(o,h,l,c,u)=>{for(let f=0;f<o.length;f++){const d=o[f],m=h[f],y=l[f],g=c[f],p=t.loadSpec.time;u?t.setChannelDataFromAtlas(d,y,u[0],u[1],g,m,p):t.setChannelDataFromVolume(d,y,g,m,p),s==null||s(t,d)}},a={...t.loadSpec,...e};return this.loadRawChannelData(t.imageInfo.imageInfo,a,n,r)}}const go=i=>i.every(t=>t===i[0]),xo=(i,t,e)=>{for(let s=0;s<e;s++)i.push(t)},ve=i=>{const t=i>>1;return t+ +(t!==0)};function Ne(i,t){i<t[0]&&(t[0]=i),i>t[1]&&(t[1]=i)}class Ye{constructor(t,e,s,n,r=!1){const a=[[1/0,-1/0],[1/0,-1/0],[1/0,-1/0],[1/0,-1/0]];for(const o of t)Ne(o[0],a[0]),Ne(o[2],a[1]),Ne(o[3],a[2]),Ne(o[4],a[3]);if(a.flat().some(o=>!Number.isFinite(o))){this.directionStates=[],this.priorityDirectionStates=[];return}this.directionStates=[],this.priorityDirectionStates=[];for(const[o,h]of a.flat().entries()){const l=o>>1,c=l+ +(l!==0);let u;if(o&1){const d=s.map(m=>Math.min(h+e[l],m[c]-1));if(go(d))u=d[0];else{u=[];for(const[m,y]of d.entries())xo(u,y,s[m][1])}}else u=Math.max(h-e[l],0);const f={direction:o,start:h,end:u,chunks:[]};n&&n.includes(o)?this.priorityDirectionStates.push(f):r||this.directionStates.push(f)}for(const o of t){for(const h of this.directionStates)o[ve(h.direction)]===h.start&&h.chunks.push(o);for(const h of this.priorityDirectionStates)o[ve(h.direction)]===h.start&&h.chunks.push(o)}}static*iterateDirections(t){let e=1;for(;t.length>0;){t=t.filter(s=>{const n=Array.isArray(s.end)?Math.max(...s.end):s.end;return s.direction&1?s.start+e<=n:s.start-e>=n});for(const s of t){const n=e*(s.direction&1?1:-1);for(const r of s.chunks){if(Array.isArray(s.end)&&r[ve(s.direction)]+n>s.end[r[1]])continue;const a=r.slice();a[ve(s.direction)]+=n,yield a}}e+=1}}*[Symbol.iterator](){if(this.priorityDirectionStates.length>0)for(const t of Ye.iterateDirections(this.priorityDirectionStates))yield t;for(const t of Ye.iterateDirections(this.directionStates))yield t}}let N=function(i){return i.UNKNOWN="unknown",i.NOT_FOUND="not_found",i.TOO_LARGE="too_large",i.LOAD_DATA_FAILED="load_data_failed",i.INVALID_METADATA="invalid_metadata",i.INVALID_MULTI_SOURCE_ZARR="invalid_multi_source_zarr",i}({});class $ extends Error{constructor(t,e){super(t,e),this.name="VolumeLoadError",this.type=(e==null?void 0:e.type)??N.UNKNOWN}}je.set("NodeNotFoundError",lt);je.set("KeyError",Jt);je.set("VolumeLoadError",$);function $t(i="Unknown error occurred while loading volume data",t=N.UNKNOWN,e){return s=>{if(e!==void 0&&s===e)return s;throw s instanceof $?s:(console.log(`Error loading volume data: ${s}`),new $(i,{type:t,cause:s}))}}function _o(i){if(i===void 0)return;const t=/^#?([a-fA-F\d]{2})([a-fA-F\d]{2})([a-fA-F\d]{2})$/i.exec(i);if(t)return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]}function wo(i){var r;if((r=i.omeroMetadata)!=null&&r.channels){const{channels:a}=i.omeroMetadata,o=[],h=[];for(let l=0;l<a.length;l++){const c=a[l];o.push(c.label??`Channel ${l+i.channelOffset}`),h.push(_o(c.color))}return{names:o,colors:h}}const t=i.axesTCZYX[1],e=t<0?1:i.scaleLevels[0].shape[t],s=Array.from({length:e},(a,o)=>`Channel ${o+i.channelOffset}`),n=Array.from({length:e},()=>{});return{names:s,colors:n}}const bo=([i,t,e])=>2+ +(i>-1)+ +(t>-1)+ +(e>-1);function So(i){const t=[-1,-1,-1,-1,-1],e=["t","c","z","y","x"];i.forEach((n,r)=>{const a=e.indexOf(n.name);if(a>-1)t[a]=r;else throw new $(`Unrecognized axis in zarr: ${n.name}`,{type:N.INVALID_METADATA})});const s=t[4]===-1;if(s||t[3]===-1)throw new $(`Did not find ${s?"an X":"a Y"} axis in zarr`,{type:N.INVALID_METADATA});return t}function Ao(i,t){const e=bo(t),s=Array(e);let n=0;return t.forEach((r,a)=>{if(r>=0){if(r>=e)throw new $(`Unexpected axis index in zarr: ${r}`,{type:N.INVALID_METADATA});s[n++]=i[a]}}),s}function Hn(i,t,e){const s=[e,e,e,e,e];return t.forEach((n,r)=>{if(n>=0){if(n>=i.length)throw new $(`Unexpected axis index in zarr: ${n}`,{type:N.INVALID_METADATA});s[r]=i[n]}}),s}function ks(i,t){const e=i.coordinateTransformations;if(e===void 0)return console.warn("WARNING: OMEZarrLoader: no coordinate transformations for scale level."),[1,1,1,1,1];const s=a=>a.type==="scale",n=e.find(s);if(!n)return console.warn('WARNING: OMEZarrLoader: no coordinate transformation of type "scale" for scale level.'),[1,1,1,1,1];const r=n.scale.slice();return Hn(r,t,1)}function sn(i,t,e,s){const n=t[2]>-1?i.shape[t[2]]:1,r=s[2]>-1?e.shape[s[2]]:1,a=n-r,o=i.shape[t[3]]-e.shape[s[3]],h=i.shape[t[4]]-e.shape[s[4]];return a===0&&o===0&&h===0?0:a<=0&&o<=0&&h<=0?-1:a>=0&&o>=0&&h>=0?1:void 0}const zo=1e-5,ys=(i,t)=>Math.abs(i-t)<zo;function Mo(i,t,e,s){const n=ks(i.multiscaleMetadata.datasets[t],i.axesTCZYX),r=ks(e.multiscaleMetadata.datasets[s],e.axesTCZYX);return ys(n[2],r[2])&&ys(n[3],r[3])&&ys(n[4],r[4])}function Eo(i){if(i.length<2)return;const t=Array.from({length:i.length},()=>[]),e=Array.from({length:i.length},()=>[]),s=new Array(i.length).fill(0);for(;s.every((n,r)=>n<i[r].scaleLevels.length);){let n=!0,r=0,a=i[0],o=a.scaleLevels[s[0]];for(let h=1;h<i.length;h++){const l=i[h],c=l.scaleLevels[s[h]],u=sn(o,a.axesTCZYX,c,l.axesTCZYX);if(u)n=!1,u>0&&(r=h,a=l,o=c);else{if(u===void 0)throw new $("Incompatible zarr arrays: pixel dimensions are mismatched",{type:N.INVALID_MULTI_SOURCE_ZARR});Mo(a,s[r],l,s[h])||console.warn("Incompatible zarr arrays: scale levels of equal size have different scale transformations");const f=a.axesTCZYX[0]>-1?o.shape[a.axesTCZYX[0]]:1,d=l.axesTCZYX[0]>-1?c.shape[l.axesTCZYX[0]]:1;f!==d&&console.warn(`Incompatible zarr arrays: different numbers of timesteps: ${f} vs ${d}`)}}if(n)for(let h=0;h<s.length;h++){const l=i[h],c=s[h];t[h].push(l.scaleLevels[c]),e[h].push(l.multiscaleMetadata.datasets[c]),s[h]+=1}else for(const[h,l]of s.entries()){const c=i[h],u=c.scaleLevels[l];sn(o,a.axesTCZYX,u,c.axesTCZYX)!==0&&(s[h]+=1)}}if(i[0].scaleLevels.length===0)throw new $("Incompatible zarr arrays: no sets of scale levels found that matched in all sources",{type:N.INVALID_MULTI_SOURCE_ZARR});for(let n=0;n<i.length;n++)i[n].scaleLevels=t[n],i[n].multiscaleMetadata.datasets=e[n]}function Io(i,t,e,s){const r=(t.endsWith("/")?t.slice(0,-1):t)+i.path+(i.path.endsWith("/")?"":"/"),a=async(o,h)=>{h!=null&&h.subscriber&&h.reportChunk&&h.reportChunk(o,h.subscriber);const l=r+o.join(","),c=e==null?void 0:e.get(l);if(c&&wn(c))return c;let u;return s&&(h!=null&&h.subscriber)?u=await s.addRequest(l,h==null?void 0:h.subscriber,()=>i.getChunk(o,h),h.isPrefetch):u=await i.getChunk(o,h),e==null||e.insert(l,u),u};return new Proxy(i,{get:(o,h)=>{if(h==="getChunk")return a;const l=o[h];return l instanceof Function?function(...c){return l.apply(o,c)}:l}})}class To extends En{constructor(t,e){super(t,e)}async get(t,e={}){var s;try{return await super.get(t,e)}catch(n){if((s=n==null?void 0:n.message)!=null&&s.startsWith("Unexpected response status 403"))return;throw n}}}const Co=i=>i.ome??i;function Zn(i,t){return typeof i=="object"&&i!==null&&t in i}function he(i,t,e="zarr"){if(!Zn(i,t))throw new $(`${e} metadata is missing required entry "${t}"`,{type:N.INVALID_METADATA})}function Rs(i,t,e="zarr"){if(!Array.isArray(i[t]))throw new $(`${e} metadata entry "${t}" is not an array`,{type:N.INVALID_METADATA})}function Do(i,t="zarr"){he(i,"multiscales",t),Rs(i,"multiscales",t)}function ko(i,t=0,e="zarr"){const s=i.multiscales[t];if(!s)throw new $(`${e} metadata does not have requested multiscale level ${t}`,{type:N.INVALID_METADATA});const n=Zn(s,"name")?` ("${s.name})`:"",r=`${e} multiscale ${t}${n}`;he(s,"axes",r),Rs(s,"axes",r),s.axes.forEach((a,o)=>he(a,"name",`${r} axis ${o}`)),he(s,"datasets",e),Rs(s,"datasets",e),s.datasets.forEach((a,o)=>he(a,"path",`${r} dataset ${o}`))}const{slice:ps}=Ka,re="chunk request cancelled";function Ro(i,t){let e=i[0],s=i[0];for(let n=0;n<i.length;n++){const r=i[n];r<e&&(e=r),r>s&&(s=r)}if(t==="float64"){const n=new Float32Array(i.length);for(let r=0;r<i.length;r++)n[r]=i[r];t="float32",i=n}return{data:i,dtype:t,min:e,max:s}}const Oo={maxPrefetchDistance:[5,5,5,5],maxPrefetchChunks:30};class Ks extends Qe{constructor(e,s,n=Oo,r=[]){super();M(this,"syncChannels",!1);this.sources=e,this.requestQueue=s,this.fetchOptions=n,this.priorityDirections=r}static async createLoader(e,s=0,n,r,a){var d;r||(r=new Gn(a==null?void 0:a.concurrencyLimit,a==null?void 0:a.prefetchConcurrencyLimit));const o=Array.isArray(e)?e:[e],h=Array.isArray(s)?s:[s],l=o.map(async(m,y)=>{var R;const g=new To(m),p=Rn(g),x=await ot(p,{kind:"group"}).catch($t(`Failed to open OME-Zarr data at ${m}`,N.NOT_FOUND)),w=o.length>1?`Zarr source ${y}`:"Zarr",A=Co(x.attrs);Do(A,w);let b=h[Math.min(y,h.length-1)];b>((R=A.multiscales)==null?void 0:R.length)&&(console.warn(`WARNING: OMEZarrLoader: scene ${b} is invalid. Using scene 0.`),b=0),ko(A,b,w);const{multiscales:S,omero:z}=A,T=S[b],C=T.datasets.map(({path:v})=>ot(p.resolve(v),{kind:"array"}).then(O=>Io(O,m,n,r)).catch($t(`Failed to open scale level ${v} of OME-Zarr data at ${m}`,N.NOT_FOUND))),D=await Promise.all(C),k=So(T.axes);return{scaleLevels:D,multiscaleMetadata:T,omeroMetadata:z,axesTCZYX:k,channelOffset:0}}),c=await Promise.all(l);let u=0;for(const m of c)m.channelOffset=u,u+=((d=m.omeroMetadata)==null?void 0:d.channels.length)??m.scaleLevels[0].shape[m.axesTCZYX[1]];Eo(c);const f=a!=null&&a.priorityDirections?a.priorityDirections.slice():void 0;return new Ks(c,r,a,f)}getUnitSymbols(){const e=this.sources[0],s=e.axesTCZYX[4],n=e.multiscaleMetadata.axes[s].unit,r=Ji(n)||n||"",a=e.axesTCZYX[0],o=a>-1?e.multiscaleMetadata.axes[a].unit:void 0,h=Ji(o)||o||"";return[r,h]}getLevelShapesZYX(){const e=this.sources[0],[s,n,r]=e.axesTCZYX.slice(-3);return e.scaleLevels.map(({shape:a})=>[s===-1?1:a[s],a[n],a[r]])}getScale(e){return ks(this.sources[0].multiscaleMetadata.datasets[e],this.sources[0].axesTCZYX)}orderByDimension(e,s=0){return Ao(e,this.sources[s].axesTCZYX)}orderByTCZYX(e,s,n=0){return Hn(e,this.sources[n].axesTCZYX,s)}matchChannelToSource(e){const s=this.sources.length-1,n=this.sources[s],r=n.scaleLevels[0].shape[n.axesTCZYX[1]],a=n.channelOffset+r;if(e>a)throw new $(`Volume channel index ${e} out of range (${a} channels available)`,{type:N.INVALID_METADATA});const o=this.sources.findIndex(c=>c.channelOffset>e),h=o===-1?s:o-1,l=e-this.sources[h].channelOffset;return{sourceIndex:h,channelIndexInSource:l}}setPrefetchPriority(e){this.priorityDirections=e}syncMultichannelLoading(e){this.syncChannels=e}updateFetchOptions(e){this.fetchOptions={...this.fetchOptions,...e}}loadDims(e){const[s,n]=this.getUnitSymbols(),r=this.maxExtent??new st(new _(0,0,0),new _(1,1,1)),o=en(e.subregion,r).getSize(new _),h=[1,1,o.z,o.y,o.x],l=this.sources[0].scaleLevels.map((c,u)=>{const f=this.getScale(u);return{spaceUnit:s,timeUnit:n,shape:this.orderByTCZYX(c.shape,1).map((m,y)=>Math.max(Math.ceil(m*h[y]),1)),spacing:this.orderByTCZYX(f,1),dataType:c.dtype}});return Promise.resolve(l)}createImageInfo(e){var C;const s=this.sources[0],[n,,r,a,o]=s.axesTCZYX,h=n>-1,l=r>-1,c=Qi(e,this.getLevelShapesZYX()),u=s.scaleLevels[c].shape,[f,d]=this.getUnitSymbols(),m=[];for(let D=0;D<this.sources.length;D++){const k=this.sources[D],R=k.axesTCZYX[1],v=R>-1?k.scaleLevels[c].shape[R]:1;m.push(v)}let y=1;if(h){y=u[n];for(let D=0;D<this.sources.length;D++){const k=this.sources[D].scaleLevels[c].shape,R=this.sources[D].axesTCZYX[0];k[R]<y&&(console.warn("The number of time points is not consistent across sources: ",k[R],y),y=k[R])}}this.maxExtent||(this.maxExtent=e.subregion.clone());const p=tn(e.subregion,new _(u[o],u[a],l?u[r]:1)).getSize(new _),x=ue(p.z,p.x,p.y),w=new Map,A=[],b=[];for(const D of this.sources){const{names:k,colors:R}=wo(D),v=k.map(O=>{const q=w.get(O);return q!==void 0?(w.set(O,q+1),`${O} (${q})`):(w.set(O,1),O)});A.push(...v),b.push(...R)}const S=s.scaleLevels.map((D,k)=>({spaceUnit:f,timeUnit:d,shape:this.orderByTCZYX(D.shape,1),spacing:this.getScale(k),dataType:D.dtype})),z={name:((C=s.omeroMetadata)==null?void 0:C.name)||"Volume",atlasTileDims:[x.x,x.y],subregionSize:[p.x,p.y,p.z],subregionOffset:[0,0,0],numChannelsPerSource:m,channelNames:A,channelColors:b,multiscaleLevel:c,multiscaleLevelDims:S,transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}},T={...e,subregion:new st(new _(0,0,0),new _(1,1,1))};return Promise.resolve({imageInfo:z,loadSpec:T})}prefetchChunk(e,s,n){e.getChunk(this.orderByDimension(s),{subscriber:n,isPrefetch:!0}).catch($t(`Unable to prefetch chunk with coords ${s.join(", ")}`,N.LOAD_DATA_FAILED,re))}beginPrefetch(e,s){if(e.length===0)return;const n=e.map(({sourceIdx:l,coords:c})=>{const u=this.orderByTCZYX(c,0,l);return u[1]+=this.sources[l].channelOffset,u}),r=this.sources.map(l=>{const c=l.scaleLevels[s],u=c.shape.map((f,d)=>Math.ceil(f/c.chunks[d]));return this.orderByTCZYX(u,1)}),a=new Ye(n,this.fetchOptions.maxPrefetchDistance,r,this.priorityDirections,this.fetchOptions.onlyPriorityDirections),o=this.requestQueue.addSubscriber();let h=0;for(const l of a){if(h>=this.fetchOptions.maxPrefetchChunks)break;const{sourceIndex:c,channelIndexInSource:u}=this.matchChannelToSource(l[1]),f=this.sources[c].scaleLevels[s];l[1]=u,this.prefetchChunk(f,l,o),h++}this.prefetchSubscriber!==void 0&&this.requestQueue.removeSubscriber(this.prefetchSubscriber,re),this.prefetchSubscriber=o}updateImageInfoForLoad(e,s){const n=this.maxExtent??new st(new _(0,0,0),new _(1,1,1)),r=en(s.subregion,n),a=Qi({...s,subregion:r},this.getLevelShapesZYX()),o=this.sources[0].scaleLevels[a].shape,[h,l,c]=this.sources[0].axesTCZYX.slice(2),u=tn(r,new _(o[c],o[l],h===-1?1:o[h])),f=u.getSize(new _),d=ue(f.z,f.x,f.y);return{...e,atlasTileDims:[d.x,d.y],subregionSize:[f.x,f.y,f.z],subregionOffset:[u.min.x,u.min.y,u.min.z],multiscaleLevel:a}}async loadRawChannelData(e,s,n,r){const a=this.syncChannels,o=this.updateImageInfoForLoad(e,s);n(o);const{numChannelsPerSource:h,multiscaleLevel:l}=o,c=h.reduce((A,b)=>A+b,0),u=s.channels??Array.from({length:c},(A,b)=>b),f=this.requestQueue.addSubscriber(),d=[],m=(A,b,S)=>{S===f&&d.push({sourceIdx:A,coords:b})},y=[],g=[],p=[],x=[],w=u.map(async A=>{const b=new _(...o.subregionOffset),S=b.clone().add(new _(...o.subregionSize)),{sourceIndex:z,channelIndexInSource:T}=this.matchChannelToSource(A),C=[s.time,T,ps(b.z,S.z),ps(b.y,S.y),ps(b.x,S.x)],D=this.sources[z].scaleLevels[l],k=this.orderByDimension(C,z),R=(q,ut)=>m(z,q,ut);console.log(D);const v=await Bn(D,k,{opts:{subscriber:f,reportChunk:R}}).catch($t("Could not load OME-Zarr volume data",N.LOAD_DATA_FAILED,re));if((v==null?void 0:v.data)===void 0)return;const O=Ro(v.data,D.dtype);a?(p.push(O.dtype),g.push(O.data),y.push(A),x.push([O.min,O.max])):r([A],[O.dtype],[O.data],[[O.min,O.max]])});this.loadSubscriber!==void 0&&this.requestQueue.removeSubscriber(this.loadSubscriber,re),this.loadSubscriber=f,this.beginPrefetch(d,l),await Promise.all(w),a&&r(y,p,g,x),this.requestQueue.removeSubscriber(f,re)}}function Os(i){let t=i[0],e=i[0];for(let s=1;s<i.length;s++)t=Math.min(t,i[s]),e=Math.max(e,i[s]);return[t,e]}const Kn=i=>{const t=i.pixel_size_x*i.width/i.tile_width,e=i.pixel_size_y*i.height/i.tile_height,s=i.pixel_size_z;return[t,e,s]},Lo=i=>{var r,a;const[t,e,s]=Kn(i),n=((r=i.transform)==null?void 0:r.translation)??[0,0,0];return n[0]=n[0]*i.tile_width/i.width,n[1]=n[1]*i.tile_height/i.height,{name:i.name,atlasTileDims:[i.cols,i.rows],subregionSize:[i.tile_width,i.tile_height,i.tiles],subregionOffset:[0,0,0],numChannelsPerSource:i.images.map(o=>o.channels.length),channelNames:i.channel_names,channelColors:i.channel_colors,multiscaleLevel:0,multiscaleLevelDims:[{shape:[i.times||1,i.channels,i.tiles,i.tile_height,i.tile_width],spacing:[i.time_scale||1,1,s,e,t],spaceUnit:i.pixel_size_unit||"m",timeUnit:i.time_unit||"s",dataType:"uint8"}],transform:{translation:n,rotation:(a=i.transform)!=null&&a.rotation?i.transform.rotation:[0,0,0],scale:[1,1,1]},userData:{...i.userData,originalVolumeSize:[i.width,i.height,i.tiles],originalPhysicalPixelSize:[i.pixel_size_x,i.pixel_size_y,i.pixel_size_z]}}};class Ws extends Qe{constructor(e,s){super();M(this,"syncChannels",!1);Array.isArray(e)?this.urls=e:this.urls=[e],this.jsonInfo=new Array(this.urls.length),this.cache=s}async getJsonImageInfo(e){const s=this.jsonInfo[e];if(s)return s;const r=await(await fetch(this.urls[e])).json();return r.pixel_size_unit=r.pixel_size_unit||"m",r.times=r.times||this.urls.length,this.jsonInfo[e]=r,r}syncMultichannelLoading(e){this.syncChannels=e}async loadDims(e){const s=await this.getJsonImageInfo(e.time),[n,r,a]=Kn(s);return[{shape:[s.times||1,s.channels,s.tiles,s.tile_height,s.tile_width],spacing:[1,1,a,r,n],spaceUnit:s.pixel_size_unit??"m",dataType:"uint8",timeUnit:s.time_unit??"s"}]}async createImageInfo(e){const s=await this.getJsonImageInfo(e.time);return{imageInfo:Lo(s),loadSpec:e}}async loadRawChannelData(e,s,n,r){const a=await this.getJsonImageInfo(s.time);let o=a==null?void 0:a.images;if(!o)return;const h=s.channels;h&&(o=o.filter(({channels:m})=>m.some(y=>h.includes(y))));const l=this.urls[s.time].replace(/[^/]*$/,"");o=o.map(m=>({...m,name:l+m.name}));const c={...s,subregion:new st(new _(0,0,0),new _(1,1,1)),multiscaleLevel:0,channels:o.flatMap(({channels:m})=>m)};n(void 0,c);const[u,f]=ho(e),d=(m,y,g,p)=>r(m,y,g,p,[u,f]);await Ws.loadVolumeAtlasData(o,d,this.cache,this.syncChannels)}static async loadVolumeAtlasData(e,s,n,r=!1){const a=[],o=[],h=[],l=[],c=e.map(async u=>{let f=!0;for(let S=0;S<Math.min(u.channels.length,4);++S){const z=u.channels[S],T=n==null?void 0:n.get(`${u.name}/${z}`);if(T&&!wn(T)){const C=new Uint8Array(T);r?(a.push(z),o.push("uint8"),h.push(C),l.push(Os(C))):s([z],["uint8"],[C],[Os(C)])}else{f=!1;break}}if(f)return;const m=await(await fetch(u.name,{mode:"cors"})).blob(),y=await createImageBitmap(m),p=new OffscreenCanvas(y.width,y.height).getContext("2d");if(!p){console.log("Error creating canvas 2d context for "+u.name);return}p.globalCompositeOperation="copy",p.globalAlpha=1,p.drawImage(y,0,0);const x=p.getImageData(0,0,y.width,y.height),w=[],A=y.width*y.height;for(let S=0;S<Math.min(u.channels.length,4);++S)w.push(new Uint8Array(A));const b=[];for(let S=0;S<Math.min(u.channels.length,4);++S){let z=1/0,T=-1/0;for(let C=0;C<A;C++)w[S][C]=x.data[C*4+S],z=Math.min(z,w[S][C]),T=Math.max(T,w[S][C]);b[S]=[z,T]}for(let S=0;S<Math.min(u.channels.length,4);++S){const z=u.channels[S];n==null||n.insert(`${u.name}/${z}`,w[S]),r?(a.push(z),o.push("uint8"),h.push(w[S]),l.push(b[S])):s([z],["uint8"],[w[S]],[b[S]],[y.width,y.height])}});await Promise.all(c),r&&s(a,o,h,l)}}function Po(i){switch(i){case"uint8":case"int8":return 1;case"uint16":case"int16":return 2;case"uint32":case"int32":case"float32":return 4;case"float64":return 8;default:throw new Error(`Unsupported dtype: ${i}`)}}const Uo=(i,t)=>{const e=ue(i.sizeZ,i.sizeX,i.sizeY);return{name:i.name,atlasTileDims:[e.x,e.y],subregionSize:[i.sizeX,i.sizeY,i.sizeZ],subregionOffset:[0,0,0],numChannelsPerSource:[i.sizeC],channelNames:i.channelNames,channelColors:void 0,multiscaleLevel:0,multiscaleLevelDims:[{shape:[1,i.sizeC,i.sizeZ,i.sizeY,i.sizeX],spacing:[1,1,i.physicalPixelSize[2],i.physicalPixelSize[1],i.physicalPixelSize[0]],spaceUnit:i.spatialUnit||"m",timeUnit:"s",dataType:t}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},userData:i.userData}};class Fo extends Qe{constructor(t,e){if(super(),this.jsonInfo=e,this.data=t,this.data.shape[0]!==this.jsonInfo.sizeC||this.data.shape[1]!==this.jsonInfo.sizeZ||this.data.shape[2]!==this.jsonInfo.sizeY||this.data.shape[3]!==this.jsonInfo.sizeX)throw new Error("RawArrayLoader: data shape does not match metadata")}async loadDims(t){const e=this.jsonInfo;return[{shape:[1,e.sizeC,e.sizeZ,e.sizeY,e.sizeX],spacing:[1,1,e.physicalPixelSize[2],e.physicalPixelSize[1],e.physicalPixelSize[0]],spaceUnit:e.spatialUnit||"m",dataType:this.data.dtype,timeUnit:"s"}]}async createImageInfo(t){return{imageInfo:Uo(this.jsonInfo,this.data.dtype),loadSpec:t}}loadRawChannelData(t,e,s,n){const r=e.channels,a={...e,subregion:new st(new _(0,0,0),new _(1,1,1)),multiscaleLevel:0};s(void 0,a);const o=t.numChannelsPerSource.reduce((h,l)=>h+l,0);for(let h=0;h<o;++h){if(r&&r.length>0&&!r.includes(h))continue;const l=this.data.shape[3]*this.data.shape[2]*this.data.shape[1],c=Ds[this.data.dtype],u=new c(this.data.buffer.buffer,h*l*Po(this.data.dtype),l),f=Os(u);n([h],[this.data.dtype],[u],[f])}return Promise.resolve()}}function B(i){return(t,...e)=>vo(i,t,e)}function Qt(i,t){return B(Wn(i,t).get)}const{apply:vo,getOwnPropertyDescriptor:Wn,getPrototypeOf:Js,ownKeys:No}=Reflect,{iterator:Te,toStringTag:Bo}=Symbol,qo=Object,{create:Qs,defineProperty:Vo}=qo,Go=Array,$o=Go.prototype,Jn=$o[Te],Yo=B(Jn),Qn=ArrayBuffer,Xo=Qn.prototype;Qt(Xo,"byteLength");const nn=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;nn&&Qt(nn.prototype,"byteLength");const tr=Js(Uint8Array);tr.from;const Y=tr.prototype;Y[Te];B(Y.keys);B(Y.values);B(Y.entries);B(Y.set);B(Y.reverse);B(Y.fill);B(Y.copyWithin);B(Y.sort);B(Y.slice);B(Y.subarray);Qt(Y,"buffer");Qt(Y,"byteOffset");Qt(Y,"length");Qt(Y,Bo);const jo=Uint8Array,er=Uint16Array,ti=Uint32Array,Ho=Float32Array,fe=Js([][Te]()),sr=B(fe.next),Zo=B(function*(){}().next),Ko=Js(fe),Wo=DataView.prototype,Jo=B(Wo.getUint16),ei=WeakMap,ir=ei.prototype,nr=B(ir.get),Qo=B(ir.set),rr=new ei,th=Qs(null,{next:{value:function(){const t=nr(rr,this);return sr(t)}},[Te]:{value:function(){return this}}});function eh(i){if(i[Te]===Jn&&fe.next===sr)return i;const t=Qs(th);return Qo(rr,t,Yo(i)),t}const sh=new ei,ih=Qs(Ko,{next:{value:function(){const t=nr(sh,this);return Zo(t)},writable:!0,configurable:!0}});for(const i of No(fe))i!=="next"&&Vo(ih,i,Wn(fe,i));const ar=new Qn(4),nh=new Ho(ar),rh=new ti(ar),J=new er(512),Q=new jo(512);for(let i=0;i<256;++i){const t=i-127;t<-24?(J[i]=0,J[i|256]=32768,Q[i]=24,Q[i|256]=24):t<-14?(J[i]=1024>>-t-14,J[i|256]=1024>>-t-14|32768,Q[i]=-t-1,Q[i|256]=-t-1):t<=15?(J[i]=t+15<<10,J[i|256]=t+15<<10|32768,Q[i]=13,Q[i|256]=13):t<128?(J[i]=31744,J[i|256]=64512,Q[i]=24,Q[i|256]=24):(J[i]=31744,J[i|256]=64512,Q[i]=13,Q[i|256]=13)}const si=new ti(2048);for(let i=1;i<1024;++i){let t=i<<13,e=0;for(;!(t&8388608);)t<<=1,e-=8388608;t&=-8388609,e+=947912704,si[i]=t|e}for(let i=1024;i<2048;++i)si[i]=939524096+(i-1024<<13);const te=new ti(64);for(let i=1;i<31;++i)te[i]=i<<23;te[31]=1199570944;te[32]=2147483648;for(let i=33;i<63;++i)te[i]=2147483648+(i-32<<23);te[63]=3347054592;const or=new er(64);for(let i=1;i<64;++i)i!==32&&(or[i]=1024);function ah(i){const t=i>>10;return rh[0]=si[or[t]+(i&1023)]+te[t],nh[0]}function hr(i,t,...e){return ah(Jo(i,t,...eh(e)))}function lr(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var ii={exports:{}};function cr(i,t,e){const s=e&&e.debug||!1;s&&console.log("[xml-utils] getting "+t+" in "+i);const n=typeof i=="object"?i.outer:i,r=n.slice(0,n.indexOf(">")+1),a=['"',"'"];for(let o=0;o<a.length;o++){const h=a[o],l=t+"\\="+h+"([^"+h+"]*)"+h;s&&console.log("[xml-utils] pattern:",l);const u=new RegExp(l).exec(r);if(s&&console.log("[xml-utils] match:",u),u)return u[1]}}ii.exports=cr;ii.exports.default=cr;var oh=ii.exports,gs=lr(oh),ni={exports:{}},ri={exports:{}},ai={exports:{}};function ur(i,t,e){const n=new RegExp(t).exec(i.slice(e));return n?e+n.index:-1}ai.exports=ur;ai.exports.default=ur;var hh=ai.exports,oi={exports:{}};function fr(i,t,e){const n=new RegExp(t).exec(i.slice(e));return n?e+n.index+n[0].length-1:-1}oi.exports=fr;oi.exports.default=fr;var lh=oi.exports,hi={exports:{}};function dr(i,t){const e=new RegExp(t,"g"),s=i.match(e);return s?s.length:0}hi.exports=dr;hi.exports.default=dr;var ch=hi.exports;const uh=hh,xs=lh,rn=ch;function mr(i,t,e){const s=e&&e.debug||!1,n=!(e&&typeof e.nested===!1),r=e&&e.startIndex||0;s&&console.log("[xml-utils] starting findTagByName with",t," and ",e);const a=uh(i,`<${t}[ 
>/]`,r);if(s&&console.log("[xml-utils] start:",a),a===-1)return;const o=i.slice(a+t.length);let h=xs(o,"^[^<]*[ /]>",0);const l=h!==-1&&o[h-1]==="/";if(s&&console.log("[xml-utils] selfClosing:",l),l===!1)if(n){let d=0,m=1,y=0;for(;(h=xs(o,"[ /]"+t+">",d))!==-1;){const g=o.substring(d,h+1);if(m+=rn(g,"<"+t+`[ 
	>]`),y+=rn(g,"</"+t+">"),y>=m)break;d=h}}else h=xs(o,"[ /]"+t+">",0);const c=a+t.length+h+1;if(s&&console.log("[xml-utils] end:",c),c===-1)return;const u=i.slice(a,c);let f;return l?f=null:f=u.slice(u.indexOf(">")+1,u.lastIndexOf("<")),{inner:f,outer:u,start:a,end:c}}ri.exports=mr;ri.exports.default=mr;var fh=ri.exports;const dh=fh;function yr(i,t,e){const s=[],n=e&&e.debug||!1,r=e&&typeof e.nested=="boolean"?e.nested:!0;let a=e&&e.startIndex||0,o;for(;o=dh(i,t,{debug:n,startIndex:a});)r?a=o.start+1+t.length:a=o.end,s.push(o);return n&&console.log("findTagsByName found",s.length,"tags"),s}ni.exports=yr;ni.exports.default=yr;var mh=ni.exports,yh=lr(mh);const le={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},tt={};for(const i in le)le.hasOwnProperty(i)&&(tt[le[i]]=parseInt(i,10));const ph=[tt.BitsPerSample,tt.ExtraSamples,tt.SampleFormat,tt.StripByteCounts,tt.StripOffsets,tt.StripRowCounts,tt.TileByteCounts,tt.TileOffsets,tt.SubIFDs],_s={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},I={};for(const i in _s)_s.hasOwnProperty(i)&&(I[_s[i]]=parseInt(i,10));const j={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8},gh={Unspecified:0},bl={AddCompression:1},Sl={None:0,Deflate:1,Zstandard:2},xh={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function _h(i,t){const{width:e,height:s}=i,n=new Uint8Array(e*s*3);let r;for(let a=0,o=0;a<i.length;++a,o+=3)r=256-i[a]/t*256,n[o]=r,n[o+1]=r,n[o+2]=r;return n}function wh(i,t){const{width:e,height:s}=i,n=new Uint8Array(e*s*3);let r;for(let a=0,o=0;a<i.length;++a,o+=3)r=i[a]/t*256,n[o]=r,n[o+1]=r,n[o+2]=r;return n}function bh(i,t){const{width:e,height:s}=i,n=new Uint8Array(e*s*3),r=t.length/3,a=t.length/3*2;for(let o=0,h=0;o<i.length;++o,h+=3){const l=i[o];n[h]=t[l]/65536*256,n[h+1]=t[l+r]/65536*256,n[h+2]=t[l+a]/65536*256}return n}function Sh(i){const{width:t,height:e}=i,s=new Uint8Array(t*e*3);for(let n=0,r=0;n<i.length;n+=4,r+=3){const a=i[n],o=i[n+1],h=i[n+2],l=i[n+3];s[r]=255*((255-a)/256)*((255-l)/256),s[r+1]=255*((255-o)/256)*((255-l)/256),s[r+2]=255*((255-h)/256)*((255-l)/256)}return s}function Ah(i){const{width:t,height:e}=i,s=new Uint8ClampedArray(t*e*3);for(let n=0,r=0;n<i.length;n+=3,r+=3){const a=i[n],o=i[n+1],h=i[n+2];s[r]=a+1.402*(h-128),s[r+1]=a-.34414*(o-128)-.71414*(h-128),s[r+2]=a+1.772*(o-128)}return s}const zh=.95047,Mh=1,Eh=1.08883;function Ih(i){const{width:t,height:e}=i,s=new Uint8Array(t*e*3);for(let n=0,r=0;n<i.length;n+=3,r+=3){const a=i[n+0],o=i[n+1]<<24>>24,h=i[n+2]<<24>>24;let l=(a+16)/116,c=o/500+l,u=l-h/200,f,d,m;c=zh*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),l=Mh*(l*l*l>.008856?l*l*l:(l-16/116)/7.787),u=Eh*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),f=c*3.2406+l*-1.5372+u*-.4986,d=c*-.9689+l*1.8758+u*.0415,m=c*.0557+l*-.204+u*1.057,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,m=m>.0031308?1.055*m**(1/2.4)-.055:12.92*m,s[r]=Math.max(0,Math.min(1,f))*255,s[r+1]=Math.max(0,Math.min(1,d))*255,s[r+2]=Math.max(0,Math.min(1,m))*255}return s}const pr=new Map;function At(i,t){Array.isArray(i)||(i=[i]),i.forEach(e=>pr.set(e,t))}async function Th(i){const t=pr.get(i.Compression);if(!t)throw new Error(`Unknown compression method identifier: ${i.Compression}`);const e=await t();return new e(i)}At([void 0,1],()=>import("./raw-in9isEBO.js").then(i=>i.default));At(5,()=>import("./lzw-_aCqfs4w.js").then(i=>i.default));At(6,()=>{throw new Error("old style JPEG compression is not supported.")});At(7,()=>import("./jpeg-JhJy4lL1.js").then(i=>i.default));At([8,32946],()=>import("./deflate-Dthki0TA.js").then(i=>i.default));At(32773,()=>import("./packbits-DDWKfGV_.js").then(i=>i.default));At(34887,()=>import("./lerc-b45y672c.js").then(async i=>(await i.zstd.init(),i)).then(i=>i.default));At(50001,()=>import("./webimage-DBgUwIbt.js").then(i=>i.default));function ts(i,t,e,s=1){return new(Object.getPrototypeOf(i)).constructor(t*e*s)}function Ch(i,t,e,s,n){const r=t/s,a=e/n;return i.map(o=>{const h=ts(o,s,n);for(let l=0;l<n;++l){const c=Math.min(Math.round(a*l),e-1);for(let u=0;u<s;++u){const f=Math.min(Math.round(r*u),t-1),d=o[c*t+f];h[l*s+u]=d}}return h})}function Yt(i,t,e){return(1-e)*i+e*t}function Dh(i,t,e,s,n){const r=t/s,a=e/n;return i.map(o=>{const h=ts(o,s,n);for(let l=0;l<n;++l){const c=a*l,u=Math.floor(c),f=Math.min(Math.ceil(c),e-1);for(let d=0;d<s;++d){const m=r*d,y=m%1,g=Math.floor(m),p=Math.min(Math.ceil(m),t-1),x=o[u*t+g],w=o[u*t+p],A=o[f*t+g],b=o[f*t+p],S=Yt(Yt(x,w,y),Yt(A,b,y),c%1);h[l*s+d]=S}}return h})}function kh(i,t,e,s,n,r="nearest"){switch(r.toLowerCase()){case"nearest":return Ch(i,t,e,s,n);case"bilinear":case"linear":return Dh(i,t,e,s,n);default:throw new Error(`Unsupported resampling method: '${r}'`)}}function Rh(i,t,e,s,n,r){const a=t/s,o=e/n,h=ts(i,s,n,r);for(let l=0;l<n;++l){const c=Math.min(Math.round(o*l),e-1);for(let u=0;u<s;++u){const f=Math.min(Math.round(a*u),t-1);for(let d=0;d<r;++d){const m=i[c*t*r+f*r+d];h[l*s*r+u*r+d]=m}}}return h}function Oh(i,t,e,s,n,r){const a=t/s,o=e/n,h=ts(i,s,n,r);for(let l=0;l<n;++l){const c=o*l,u=Math.floor(c),f=Math.min(Math.ceil(c),e-1);for(let d=0;d<s;++d){const m=a*d,y=m%1,g=Math.floor(m),p=Math.min(Math.ceil(m),t-1);for(let x=0;x<r;++x){const w=i[u*t*r+g*r+x],A=i[u*t*r+p*r+x],b=i[f*t*r+g*r+x],S=i[f*t*r+p*r+x],z=Yt(Yt(w,A,y),Yt(b,S,y),c%1);h[l*s*r+d*r+x]=z}}}return h}function Lh(i,t,e,s,n,r,a="nearest"){switch(a.toLowerCase()){case"nearest":return Rh(i,t,e,s,n,r);case"bilinear":case"linear":return Oh(i,t,e,s,n,r);default:throw new Error(`Unsupported resampling method: '${a}'`)}}function Ph(i,t,e){let s=0;for(let n=t;n<e;++n)s+=i[n];return s}function Ls(i,t,e){switch(i){case 1:if(t<=8)return new Uint8Array(e);if(t<=16)return new Uint16Array(e);if(t<=32)return new Uint32Array(e);break;case 2:if(t===8)return new Int8Array(e);if(t===16)return new Int16Array(e);if(t===32)return new Int32Array(e);break;case 3:switch(t){case 16:case 32:return new Float32Array(e);case 64:return new Float64Array(e)}break}throw Error("Unsupported data format/bitsPerSample")}function Uh(i,t){return(i===1||i===2)&&t<=32&&t%8===0?!1:!(i===3&&(t===16||t===32||t===64))}function Fh(i,t,e,s,n,r,a){const o=new DataView(i),h=e===2?a*r:a*r*s,l=e===2?1:s,c=Ls(t,n,h),u=parseInt("1".repeat(n),2);if(t===1){let f;e===1?f=s*n:f=n;let d=r*f;d&7&&(d=d+7&-8);for(let m=0;m<a;++m){const y=m*d;for(let g=0;g<r;++g){const p=y+g*l*n;for(let x=0;x<l;++x){const w=p+x*n,A=(m*r+g)*l+x,b=Math.floor(w/8),S=w%8;if(S+n<=8)c[A]=o.getUint8(b)>>8-n-S&u;else if(S+n<=16)c[A]=o.getUint16(b)>>16-n-S&u;else if(S+n<=24){const z=o.getUint16(b)<<8|o.getUint8(b+2);c[A]=z>>24-n-S&u}else c[A]=o.getUint32(b)>>32-n-S&u}}}}return c.buffer}class vh{constructor(t,e,s,n,r,a){this.fileDirectory=t,this.geoKeys=e,this.dataView=s,this.littleEndian=n,this.tiles=r?{}:null,this.isTiled=!t.StripOffsets;const o=t.PlanarConfiguration;if(this.planarConfiguration=typeof o>"u"?1:o,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=a}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(t){return this.isTiled||(t+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-t*this.getTileHeight()}getBytesPerPixel(){let t=0;for(let e=0;e<this.fileDirectory.BitsPerSample.length;++e)t+=this.getSampleByteSize(e);return t}getSampleByteSize(t){if(t>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${t} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[t]/8)}getReaderForSample(t){const e=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[t]:1,s=this.fileDirectory.BitsPerSample[t];switch(e){case 1:if(s<=8)return DataView.prototype.getUint8;if(s<=16)return DataView.prototype.getUint16;if(s<=32)return DataView.prototype.getUint32;break;case 2:if(s<=8)return DataView.prototype.getInt8;if(s<=16)return DataView.prototype.getInt16;if(s<=32)return DataView.prototype.getInt32;break;case 3:switch(s){case 16:return function(n,r){return hr(this,n,r)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(t=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[t]:1}getBitsPerSample(t=0){return this.fileDirectory.BitsPerSample[t]}getArrayForSample(t,e){const s=this.getSampleFormat(t),n=this.getBitsPerSample(t);return Ls(s,n,e)}async getTileOrStrip(t,e,s,n,r){const a=Math.ceil(this.getWidth()/this.getTileWidth()),o=Math.ceil(this.getHeight()/this.getTileHeight());let h;const{tiles:l}=this;this.planarConfiguration===1?h=e*a+t:this.planarConfiguration===2&&(h=s*a*o+e*a+t);let c,u;this.isTiled?(c=this.fileDirectory.TileOffsets[h],u=this.fileDirectory.TileByteCounts[h]):(c=this.fileDirectory.StripOffsets[h],u=this.fileDirectory.StripByteCounts[h]);const f=(await this.source.fetch([{offset:c,length:u}],r))[0];let d;return l===null||!l[h]?(d=(async()=>{let m=await n.decode(this.fileDirectory,f);const y=this.getSampleFormat(),g=this.getBitsPerSample();return Uh(y,g)&&(m=Fh(m,y,this.planarConfiguration,this.getSamplesPerPixel(),g,this.getTileWidth(),this.getBlockHeight(e))),m})(),l!==null&&(l[h]=d)):d=l[h],{x:t,y:e,sample:s,data:await d}}async _readRaster(t,e,s,n,r,a,o,h,l){const c=this.getTileWidth(),u=this.getTileHeight(),f=this.getWidth(),d=this.getHeight(),m=Math.max(Math.floor(t[0]/c),0),y=Math.min(Math.ceil(t[2]/c),Math.ceil(f/c)),g=Math.max(Math.floor(t[1]/u),0),p=Math.min(Math.ceil(t[3]/u),Math.ceil(d/u)),x=t[2]-t[0];let w=this.getBytesPerPixel();const A=[],b=[];for(let T=0;T<e.length;++T)this.planarConfiguration===1?A.push(Ph(this.fileDirectory.BitsPerSample,0,e[T])/8):A.push(0),b.push(this.getReaderForSample(e[T]));const S=[],{littleEndian:z}=this;for(let T=g;T<p;++T)for(let C=m;C<y;++C){let D;this.planarConfiguration===1&&(D=this.getTileOrStrip(C,T,0,r,l));for(let k=0;k<e.length;++k){const R=k,v=e[k];this.planarConfiguration===2&&(w=this.getSampleByteSize(v),D=this.getTileOrStrip(C,T,v,r,l));const O=D.then(q=>{const ut=q.data,Dt=new DataView(ut),ft=this.getBlockHeight(q.y),W=q.y*u,it=q.x*c,kt=W+ft,br=(q.x+1)*c,Sr=b[R],Ar=Math.min(ft,ft-(kt-t[3]),d-W),zr=Math.min(c,c-(br-t[2]),f-it);for(let ee=Math.max(0,t[1]-W);ee<Ar;++ee)for(let se=Math.max(0,t[0]-it);se<zr;++se){const Mr=(ee*c+se)*w,_i=Sr.call(Dt,Mr+A[R],z);let Ce;n?(Ce=(ee+W-t[1])*x*e.length+(se+it-t[0])*e.length+R,s[Ce]=_i):(Ce=(ee+W-t[1])*x+se+it-t[0],s[R][Ce]=_i)}});S.push(O)}}if(await Promise.all(S),a&&t[2]-t[0]!==a||o&&t[3]-t[1]!==o){let T;return n?T=Lh(s,t[2]-t[0],t[3]-t[1],a,o,e.length,h):T=kh(s,t[2]-t[0],t[3]-t[1],a,o,h),T.width=a,T.height=o,T}return s.width=a||t[2]-t[0],s.height=o||t[3]-t[1],s}async readRasters({window:t,samples:e=[],interleave:s,pool:n=null,width:r,height:a,resampleMethod:o,fillValue:h,signal:l}={}){const c=t||[0,0,this.getWidth(),this.getHeight()];if(c[0]>c[2]||c[1]>c[3])throw new Error("Invalid subsets");const u=c[2]-c[0],f=c[3]-c[1],d=u*f,m=this.getSamplesPerPixel();if(!e||!e.length)for(let x=0;x<m;++x)e.push(x);else for(let x=0;x<e.length;++x)if(e[x]>=m)return Promise.reject(new RangeError(`Invalid sample index '${e[x]}'.`));let y;if(s){const x=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,w=Math.max.apply(null,this.fileDirectory.BitsPerSample);y=Ls(x,w,d*e.length),h&&y.fill(h)}else{y=[];for(let x=0;x<e.length;++x){const w=this.getArrayForSample(e[x],d);Array.isArray(h)&&x<h.length?w.fill(h[x]):h&&!Array.isArray(h)&&w.fill(h),y.push(w)}}const g=n||await Th(this.fileDirectory);return await this._readRaster(c,e,y,s,g,r,a,o,l)}async readRGB({window:t,interleave:e=!0,pool:s=null,width:n,height:r,resampleMethod:a,enableAlpha:o=!1,signal:h}={}){const l=t||[0,0,this.getWidth(),this.getHeight()];if(l[0]>l[2]||l[1]>l[3])throw new Error("Invalid subsets");const c=this.fileDirectory.PhotometricInterpretation;if(c===j.RGB){let p=[0,1,2];if(this.fileDirectory.ExtraSamples!==gh.Unspecified&&o){p=[];for(let x=0;x<this.fileDirectory.BitsPerSample.length;x+=1)p.push(x)}return this.readRasters({window:t,interleave:e,samples:p,pool:s,width:n,height:r,resampleMethod:a,signal:h})}let u;switch(c){case j.WhiteIsZero:case j.BlackIsZero:case j.Palette:u=[0];break;case j.CMYK:u=[0,1,2,3];break;case j.YCbCr:case j.CIELab:u=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const f={window:l,interleave:!0,samples:u,pool:s,width:n,height:r,resampleMethod:a,signal:h},{fileDirectory:d}=this,m=await this.readRasters(f),y=2**this.fileDirectory.BitsPerSample[0];let g;switch(c){case j.WhiteIsZero:g=_h(m,y);break;case j.BlackIsZero:g=wh(m,y);break;case j.Palette:g=bh(m,d.ColorMap);break;case j.CMYK:g=Sh(m);break;case j.YCbCr:g=Ah(m);break;case j.CIELab:g=Ih(m);break;default:throw new Error("Unsupported photometric interpretation.")}if(!e){const p=new Uint8Array(g.length/3),x=new Uint8Array(g.length/3),w=new Uint8Array(g.length/3);for(let A=0,b=0;A<g.length;A+=3,++b)p[b]=g[A],x[b]=g[A+1],w[b]=g[A+2];g=[p,x,w]}return g.width=m.width,g.height=m.height,g}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const t=[];for(let e=0;e<this.fileDirectory.ModelTiepoint.length;e+=6)t.push({i:this.fileDirectory.ModelTiepoint[e],j:this.fileDirectory.ModelTiepoint[e+1],k:this.fileDirectory.ModelTiepoint[e+2],x:this.fileDirectory.ModelTiepoint[e+3],y:this.fileDirectory.ModelTiepoint[e+4],z:this.fileDirectory.ModelTiepoint[e+5]});return t}getGDALMetadata(t=null){const e={};if(!this.fileDirectory.GDAL_METADATA)return null;const s=this.fileDirectory.GDAL_METADATA;let n=yh(s,"Item");t===null?n=n.filter(r=>gs(r,"sample")===void 0):n=n.filter(r=>Number(gs(r,"sample"))===t);for(let r=0;r<n.length;++r){const a=n[r];e[gs(a,"name")]=a.inner}return e}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const t=this.fileDirectory.GDAL_NODATA;return Number(t.substring(0,t.length-1))}getOrigin(){const t=this.fileDirectory.ModelTiepoint,e=this.fileDirectory.ModelTransformation;if(t&&t.length===6)return[t[3],t[4],t[5]];if(e)return[e[3],e[7],e[11]];throw new Error("The image does not have an affine transformation.")}getResolution(t=null){const e=this.fileDirectory.ModelPixelScale,s=this.fileDirectory.ModelTransformation;if(e)return[e[0],-e[1],e[2]];if(s)return s[1]===0&&s[4]===0?[s[0],-s[5],s[10]]:[Math.sqrt(s[0]*s[0]+s[4]*s[4]),-Math.sqrt(s[1]*s[1]+s[5]*s[5]),s[10]];if(t){const[n,r,a]=t.getResolution();return[n*t.getWidth()/this.getWidth(),r*t.getHeight()/this.getHeight(),a*t.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(t=!1){const e=this.getHeight(),s=this.getWidth();if(this.fileDirectory.ModelTransformation&&!t){const[n,r,a,o,h,l,c,u]=this.fileDirectory.ModelTransformation,d=[[0,0],[0,e],[s,0],[s,e]].map(([g,p])=>[o+n*g+r*p,u+h*g+l*p]),m=d.map(g=>g[0]),y=d.map(g=>g[1]);return[Math.min(...m),Math.min(...y),Math.max(...m),Math.max(...y)]}else{const n=this.getOrigin(),r=this.getResolution(),a=n[0],o=n[1],h=a+r[0]*s,l=o+r[1]*e;return[Math.min(a,h),Math.min(o,l),Math.max(a,h),Math.max(o,l)]}}}class Nh{constructor(t){this._dataView=new DataView(t)}get buffer(){return this._dataView.buffer}getUint64(t,e){const s=this.getUint32(t,e),n=this.getUint32(t+4,e);let r;if(e){if(r=s+2**32*n,!Number.isSafeInteger(r))throw new Error(`${r} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return r}if(r=2**32*s+n,!Number.isSafeInteger(r))throw new Error(`${r} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return r}getInt64(t,e){let s=0;const n=(this._dataView.getUint8(t+(e?7:0))&128)>0;let r=!0;for(let a=0;a<8;a++){let o=this._dataView.getUint8(t+(e?a:7-a));n&&(r?o!==0&&(o=~(o-1)&255,r=!1):o=~o&255),s+=o*256**a}return n&&(s=-s),s}getUint8(t,e){return this._dataView.getUint8(t,e)}getInt8(t,e){return this._dataView.getInt8(t,e)}getUint16(t,e){return this._dataView.getUint16(t,e)}getInt16(t,e){return this._dataView.getInt16(t,e)}getUint32(t,e){return this._dataView.getUint32(t,e)}getInt32(t,e){return this._dataView.getInt32(t,e)}getFloat16(t,e){return hr(this._dataView,t,e)}getFloat32(t,e){return this._dataView.getFloat32(t,e)}getFloat64(t,e){return this._dataView.getFloat64(t,e)}}class Bh{constructor(t,e,s,n){this._dataView=new DataView(t),this._sliceOffset=e,this._littleEndian=s,this._bigTiff=n}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(t,e){return this.sliceOffset<=t&&this.sliceTop>=t+e}readUint8(t){return this._dataView.getUint8(t-this._sliceOffset,this._littleEndian)}readInt8(t){return this._dataView.getInt8(t-this._sliceOffset,this._littleEndian)}readUint16(t){return this._dataView.getUint16(t-this._sliceOffset,this._littleEndian)}readInt16(t){return this._dataView.getInt16(t-this._sliceOffset,this._littleEndian)}readUint32(t){return this._dataView.getUint32(t-this._sliceOffset,this._littleEndian)}readInt32(t){return this._dataView.getInt32(t-this._sliceOffset,this._littleEndian)}readFloat32(t){return this._dataView.getFloat32(t-this._sliceOffset,this._littleEndian)}readFloat64(t){return this._dataView.getFloat64(t-this._sliceOffset,this._littleEndian)}readUint64(t){const e=this.readUint32(t),s=this.readUint32(t+4);let n;if(this._littleEndian){if(n=e+2**32*s,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}if(n=2**32*e+s,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}readInt64(t){let e=0;const s=(this._dataView.getUint8(t+(this._littleEndian?7:0))&128)>0;let n=!0;for(let r=0;r<8;r++){let a=this._dataView.getUint8(t+(this._littleEndian?r:7-r));s&&(n?a!==0&&(a=~(a-1)&255,n=!1):a=~a&255),e+=a*256**r}return s&&(e=-e),e}readOffset(t){return this._bigTiff?this.readUint64(t):this.readUint32(t)}}const an=`\r
\r
`;function gr(i){if(typeof Object.fromEntries<"u")return Object.fromEntries(i);const t={};for(const[e,s]of i)t[e.toLowerCase()]=s;return t}function qh(i){const t=i.split(`\r
`).map(e=>{const s=e.split(":").map(n=>n.trim());return s[0]=s[0].toLowerCase(),s});return gr(t)}function Vh(i){const[t,...e]=i.split(";").map(n=>n.trim()),s=e.map(n=>n.split("="));return{type:t,params:gr(s)}}function Ps(i){let t,e,s;return i&&([,t,e,s]=i.match(/bytes (\d+)-(\d+)\/(\d+)/),t=parseInt(t,10),e=parseInt(e,10),s=parseInt(s,10)),{start:t,end:e,total:s}}function Gh(i,t){let e=null;const s=new TextDecoder("ascii"),n=[],r=`--${t}`,a=`${r}--`;for(let o=0;o<10;++o)s.decode(new Uint8Array(i,o,r.length))===r&&(e=o);if(e===null)throw new Error("Could not find initial boundary");for(;e<i.byteLength;){const o=s.decode(new Uint8Array(i,e,Math.min(r.length+1024,i.byteLength-e)));if(o.length===0||o.startsWith(a))break;if(!o.startsWith(r))throw new Error("Part does not start with boundary");const h=o.substr(r.length+2);if(h.length===0)break;const l=h.indexOf(an),c=qh(h.substr(0,l)),{start:u,end:f,total:d}=Ps(c["content-range"]),m=e+r.length+l+an.length,y=parseInt(f,10)+1-parseInt(u,10);n.push({headers:c,data:i.slice(m,m+y),offset:u,length:y,fileSize:d}),e=m+y+4}return n}class xr{async fetch(t,e=void 0){return Promise.all(t.map(s=>this.fetchSlice(s,e)))}async fetchSlice(t){throw new Error(`fetching of slice ${t} not possible, not implemented`)}get fileSize(){return null}async close(){}}class $h extends Map{constructor(t={}){if(super(),!(t.maxSize&&t.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof t.maxAge=="number"&&t.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=t.maxSize,this.maxAge=t.maxAge||Number.POSITIVE_INFINITY,this.onEviction=t.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(t){if(typeof this.onEviction=="function")for(const[e,s]of t)this.onEviction(e,s.value)}_deleteIfExpired(t,e){return typeof e.expiry=="number"&&e.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(t,e.value),this.delete(t)):!1}_getOrDeleteIfExpired(t,e){if(this._deleteIfExpired(t,e)===!1)return e.value}_getItemValue(t,e){return e.expiry?this._getOrDeleteIfExpired(t,e):e.value}_peek(t,e){const s=e.get(t);return this._getItemValue(t,s)}_set(t,e){this.cache.set(t,e),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(t,e){this.oldCache.delete(t),this._set(t,e)}*_entriesAscending(){for(const t of this.oldCache){const[e,s]=t;this.cache.has(e)||this._deleteIfExpired(e,s)===!1&&(yield t)}for(const t of this.cache){const[e,s]=t;this._deleteIfExpired(e,s)===!1&&(yield t)}}get(t){if(this.cache.has(t)){const e=this.cache.get(t);return this._getItemValue(t,e)}if(this.oldCache.has(t)){const e=this.oldCache.get(t);if(this._deleteIfExpired(t,e)===!1)return this._moveToRecent(t,e),e.value}}set(t,e,{maxAge:s=this.maxAge}={}){const n=typeof s=="number"&&s!==Number.POSITIVE_INFINITY?Date.now()+s:void 0;return this.cache.has(t)?this.cache.set(t,{value:e,expiry:n}):this._set(t,{value:e,expiry:n}),this}has(t){return this.cache.has(t)?!this._deleteIfExpired(t,this.cache.get(t)):this.oldCache.has(t)?!this._deleteIfExpired(t,this.oldCache.get(t)):!1}peek(t){if(this.cache.has(t))return this._peek(t,this.cache);if(this.oldCache.has(t))return this._peek(t,this.oldCache)}delete(t){const e=this.cache.delete(t);return e&&this._size--,this.oldCache.delete(t)||e}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(t){if(!(t&&t>0))throw new TypeError("`maxSize` must be a number greater than 0");const e=[...this._entriesAscending()],s=e.length-t;s<0?(this.cache=new Map(e),this.oldCache=new Map,this._size=e.length):(s>0&&this._emitEvictions(e.slice(0,s)),this.oldCache=new Map(e.slice(s)),this.cache=new Map,this._size=0),this.maxSize=t}*keys(){for(const[t]of this)yield t}*values(){for(const[,t]of this)yield t}*[Symbol.iterator](){for(const t of this.cache){const[e,s]=t;this._deleteIfExpired(e,s)===!1&&(yield[e,s.value])}for(const t of this.oldCache){const[e,s]=t;this.cache.has(e)||this._deleteIfExpired(e,s)===!1&&(yield[e,s.value])}}*entriesDescending(){let t=[...this.cache];for(let e=t.length-1;e>=0;--e){const s=t[e],[n,r]=s;this._deleteIfExpired(n,r)===!1&&(yield[n,r.value])}t=[...this.oldCache];for(let e=t.length-1;e>=0;--e){const s=t[e],[n,r]=s;this.cache.has(n)||this._deleteIfExpired(n,r)===!1&&(yield[n,r.value])}}*entriesAscending(){for(const[t,e]of this._entriesAscending())yield[t,e.value]}get size(){if(!this._size)return this.oldCache.size;let t=0;for(const e of this.oldCache.keys())this.cache.has(e)||t++;return Math.min(this._size+t,this.maxSize)}entries(){return this.entriesAscending()}forEach(t,e=this){for(const[s,n]of this.entriesAscending())t.call(e,n,s,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function Yh(i){return new Promise(t=>setTimeout(t,i))}function Xh(i,t){const e=Array.isArray(i)?i:Array.from(i),s=Array.isArray(t)?t:Array.from(t);return e.map((n,r)=>[n,s[r]])}class Wt extends Error{constructor(t){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,Wt),this.name="AbortError"}}class jh extends Error{constructor(t,e){super(e),this.errors=t,this.message=e,this.name="AggregateError"}}const Hh=jh;class Zh{constructor(t,e,s=null){this.offset=t,this.length=e,this.data=s}get top(){return this.offset+this.length}}class on{constructor(t,e,s){this.offset=t,this.length=e,this.blockIds=s}}class Kh extends xr{constructor(t,{blockSize:e=65536,cacheSize:s=100}={}){super(),this.source=t,this.blockSize=e,this.blockCache=new $h({maxSize:s,onEviction:(n,r)=>{this.evictedBlocks.set(n,r)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(t,e){const s=[],n=[],r=[];this.evictedBlocks.clear();for(const{offset:f,length:d}of t){let m=f+d;const{fileSize:y}=this;y!==null&&(m=Math.min(m,y));const g=Math.floor(f/this.blockSize)*this.blockSize;for(let p=g;p<m;p+=this.blockSize){const x=Math.floor(p/this.blockSize);!this.blockCache.has(x)&&!this.blockRequests.has(x)&&(this.blockIdsToFetch.add(x),n.push(x)),this.blockRequests.has(x)&&s.push(this.blockRequests.get(x)),r.push(x)}}await Yh(),this.fetchBlocks(e);const a=[];for(const f of n)this.blockRequests.has(f)&&a.push(this.blockRequests.get(f));await Promise.allSettled(s),await Promise.allSettled(a);const o=[],h=r.filter(f=>this.abortedBlockIds.has(f)||!this.blockCache.has(f));if(h.forEach(f=>this.blockIdsToFetch.add(f)),h.length>0&&e&&!e.aborted){this.fetchBlocks(null);for(const f of h){const d=this.blockRequests.get(f);if(!d)throw new Error(`Block ${f} is not in the block requests`);o.push(d)}await Promise.allSettled(o)}if(e&&e.aborted)throw new Wt("Request was aborted");const l=r.map(f=>this.blockCache.get(f)||this.evictedBlocks.get(f)),c=l.filter(f=>!f);if(c.length)throw new Hh(c,"Request failed");const u=new Map(Xh(r,l));return this.readSliceData(t,u)}fetchBlocks(t){if(this.blockIdsToFetch.size>0){const e=this.groupBlocks(this.blockIdsToFetch),s=this.source.fetch(e,t);for(let n=0;n<e.length;++n){const r=e[n];for(const a of r.blockIds)this.blockRequests.set(a,(async()=>{try{const o=(await s)[n],h=a*this.blockSize,l=h-o.offset,c=Math.min(l+this.blockSize,o.data.byteLength),u=o.data.slice(l,c),f=new Zh(h,u.byteLength,u,a);this.blockCache.set(a,f),this.abortedBlockIds.delete(a)}catch(o){if(o.name==="AbortError")o.signal=t,this.blockCache.delete(a),this.abortedBlockIds.add(a);else throw o}finally{this.blockRequests.delete(a)}})())}this.blockIdsToFetch.clear()}}groupBlocks(t){const e=Array.from(t).sort((a,o)=>a-o);if(e.length===0)return[];let s=[],n=null;const r=[];for(const a of e)n===null||n+1===a?(s.push(a),n=a):(r.push(new on(s[0]*this.blockSize,s.length*this.blockSize,s)),s=[a],n=a);return r.push(new on(s[0]*this.blockSize,s.length*this.blockSize,s)),r}readSliceData(t,e){return t.map(s=>{let n=s.offset+s.length;this.fileSize!==null&&(n=Math.min(this.fileSize,n));const r=Math.floor(s.offset/this.blockSize),a=Math.floor(n/this.blockSize),o=new ArrayBuffer(s.length),h=new Uint8Array(o);for(let l=r;l<=a;++l){const c=e.get(l),u=c.offset-s.offset,f=c.top-n;let d=0,m=0,y;u<0?d=-u:u>0&&(m=u),f<0?y=c.length-d:y=n-c.offset-d;const g=new Uint8Array(c.data,d,y);h.set(g,m)}return o})}}class li{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(t){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class ci{constructor(t){this.url=t}async request({headers:t,signal:e}={}){throw new Error("request is not implemented")}}class Wh extends li{constructor(t){super(),this.response=t}get status(){return this.response.status}getHeader(t){return this.response.headers.get(t)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class Jh extends ci{constructor(t,e){super(t),this.credentials=e}async request({headers:t,signal:e}={}){const s=await fetch(this.url,{headers:t,credentials:this.credentials,signal:e});return new Wh(s)}}class Qh extends li{constructor(t,e){super(),this.xhr=t,this.data=e}get status(){return this.xhr.status}getHeader(t){return this.xhr.getResponseHeader(t)}async getData(){return this.data}}class tl extends ci{constructRequest(t,e){return new Promise((s,n)=>{const r=new XMLHttpRequest;r.open("GET",this.url),r.responseType="arraybuffer";for(const[a,o]of Object.entries(t))r.setRequestHeader(a,o);r.onload=()=>{const a=r.response;s(new Qh(r,a))},r.onerror=n,r.onabort=()=>n(new Wt("Request aborted")),r.send(),e&&(e.aborted&&r.abort(),e.addEventListener("abort",()=>r.abort()))})}async request({headers:t,signal:e}={}){return await this.constructRequest(t,e)}}var ws={};class el extends li{constructor(t,e){super(),this.response=t,this.dataPromise=e}get status(){return this.response.statusCode}getHeader(t){return this.response.headers[t]}async getData(){return await this.dataPromise}}class sl extends ci{constructor(t){super(t),this.parsedUrl=ws.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",ws)}constructRequest(t,e){return new Promise((s,n)=>{const r=this.httpApi.get({...this.parsedUrl,headers:t},a=>{const o=new Promise(h=>{const l=[];a.on("data",c=>{l.push(c)}),a.on("end",()=>{const c=Buffer.concat(l).buffer;h(c)}),a.on("error",n)});s(new el(a,o))});r.on("error",n),e&&(e.aborted&&r.destroy(new Wt("Request aborted")),e.addEventListener("abort",()=>r.destroy(new Wt("Request aborted"))))})}async request({headers:t,signal:e}={}){return await this.constructRequest(t,e)}}class ui extends xr{constructor(t,e,s,n){super(),this.client=t,this.headers=e,this.maxRanges=s,this.allowFullFile=n,this._fileSize=null}async fetch(t,e){return this.maxRanges>=t.length?this.fetchSlices(t,e):(this.maxRanges>0&&t.length>1,Promise.all(t.map(s=>this.fetchSlice(s,e))))}async fetchSlices(t,e){const s=await this.client.request({headers:{...this.headers,Range:`bytes=${t.map(({offset:n,length:r})=>`${n}-${n+r}`).join(",")}`},signal:e});if(s.ok)if(s.status===206){const{type:n,params:r}=Vh(s.getHeader("content-type"));if(n==="multipart/byteranges"){const u=Gh(await s.getData(),r.boundary);return this._fileSize=u[0].fileSize||null,u}const a=await s.getData(),{start:o,end:h,total:l}=Ps(s.getHeader("content-range"));this._fileSize=l||null;const c=[{data:a,offset:o,length:h-o}];if(t.length>1){const u=await Promise.all(t.slice(1).map(f=>this.fetchSlice(f,e)));return c.concat(u)}return c}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const n=await s.getData();return this._fileSize=n.byteLength,[{data:n,offset:0,length:n.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(t,e){const{offset:s,length:n}=t,r=await this.client.request({headers:{...this.headers,Range:`bytes=${s}-${s+n}`},signal:e});if(r.ok)if(r.status===206){const a=await r.getData(),{total:o}=Ps(r.getHeader("content-range"));return this._fileSize=o||null,{data:a,offset:s,length:n}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const a=await r.getData();return this._fileSize=a.byteLength,{data:a,offset:0,length:a.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function fi(i,{blockSize:t,cacheSize:e}){return t===null?i:new Kh(i,{blockSize:t,cacheSize:e})}function il(i,{headers:t={},credentials:e,maxRanges:s=0,allowFullFile:n=!1,...r}={}){const a=new Jh(i,e),o=new ui(a,t,s,n);return fi(o,r)}function nl(i,{headers:t={},maxRanges:e=0,allowFullFile:s=!1,...n}={}){const r=new tl(i),a=new ui(r,t,e,s);return fi(a,n)}function rl(i,{headers:t={},maxRanges:e=0,allowFullFile:s=!1,...n}={}){const r=new sl(i),a=new ui(r,t,e,s);return fi(a,n)}function al(i,{forceXHR:t=!1,...e}={}){return typeof fetch=="function"&&!t?il(i,e):typeof XMLHttpRequest<"u"?nl(i,e):rl(i,e)}function Us(i){switch(i){case I.BYTE:case I.ASCII:case I.SBYTE:case I.UNDEFINED:return 1;case I.SHORT:case I.SSHORT:return 2;case I.LONG:case I.SLONG:case I.FLOAT:case I.IFD:return 4;case I.RATIONAL:case I.SRATIONAL:case I.DOUBLE:case I.LONG8:case I.SLONG8:case I.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${i}`)}}function ol(i){const t=i.GeoKeyDirectory;if(!t)return null;const e={};for(let s=4;s<=t[3]*4;s+=4){const n=xh[t[s]],r=t[s+1]?le[t[s+1]]:null,a=t[s+2],o=t[s+3];let h=null;if(!r)h=o;else{if(h=i[r],typeof h>"u"||h===null)throw new Error(`Could not get value of geoKey '${n}'.`);typeof h=="string"?h=h.substring(o,o+a-1):h.subarray&&(h=h.subarray(o,o+a),a===1&&(h=h[0]))}e[n]=h}return e}function Bt(i,t,e,s){let n=null,r=null;const a=Us(t);switch(t){case I.BYTE:case I.ASCII:case I.UNDEFINED:n=new Uint8Array(e),r=i.readUint8;break;case I.SBYTE:n=new Int8Array(e),r=i.readInt8;break;case I.SHORT:n=new Uint16Array(e),r=i.readUint16;break;case I.SSHORT:n=new Int16Array(e),r=i.readInt16;break;case I.LONG:case I.IFD:n=new Uint32Array(e),r=i.readUint32;break;case I.SLONG:n=new Int32Array(e),r=i.readInt32;break;case I.LONG8:case I.IFD8:n=new Array(e),r=i.readUint64;break;case I.SLONG8:n=new Array(e),r=i.readInt64;break;case I.RATIONAL:n=new Uint32Array(e*2),r=i.readUint32;break;case I.SRATIONAL:n=new Int32Array(e*2),r=i.readInt32;break;case I.FLOAT:n=new Float32Array(e),r=i.readFloat32;break;case I.DOUBLE:n=new Float64Array(e),r=i.readFloat64;break;default:throw new RangeError(`Invalid field type: ${t}`)}if(t===I.RATIONAL||t===I.SRATIONAL)for(let o=0;o<e;o+=2)n[o]=r.call(i,s+o*a),n[o+1]=r.call(i,s+(o*a+4));else for(let o=0;o<e;++o)n[o]=r.call(i,s+o*a);return t===I.ASCII?new TextDecoder("utf-8").decode(n):n}class hl{constructor(t,e,s){this.fileDirectory=t,this.geoKeyDirectory=e,this.nextIFDByteOffset=s}}class Be extends Error{constructor(t){super(`No image at index ${t}`),this.index=t}}class ll{async readRasters(t={}){const{window:e,width:s,height:n}=t;let{resX:r,resY:a,bbox:o}=t;const h=await this.getImage();let l=h;const c=await this.getImageCount(),u=h.getBoundingBox();if(e&&o)throw new Error('Both "bbox" and "window" passed.');if(s||n){if(e){const[m,y]=h.getOrigin(),[g,p]=h.getResolution();o=[m+e[0]*g,y+e[1]*p,m+e[2]*g,y+e[3]*p]}const d=o||u;if(s){if(r)throw new Error("Both width and resX passed");r=(d[2]-d[0])/s}if(n){if(a)throw new Error("Both width and resY passed");a=(d[3]-d[1])/n}}if(r||a){const d=[];for(let m=0;m<c;++m){const y=await this.getImage(m),{SubfileType:g,NewSubfileType:p}=y.fileDirectory;(m===0||g===2||p&1)&&d.push(y)}d.sort((m,y)=>m.getWidth()-y.getWidth());for(let m=0;m<d.length;++m){const y=d[m],g=(u[2]-u[0])/y.getWidth(),p=(u[3]-u[1])/y.getHeight();if(l=y,r&&r>g||a&&a>p)break}}let f=e;if(o){const[d,m]=h.getOrigin(),[y,g]=l.getResolution(h);f=[Math.round((o[0]-d)/y),Math.round((o[1]-m)/g),Math.round((o[2]-d)/y),Math.round((o[3]-m)/g)],f=[Math.min(f[0],f[2]),Math.min(f[1],f[3]),Math.max(f[0],f[2]),Math.max(f[1],f[3])]}return l.readRasters({...t,window:f})}}class di extends ll{constructor(t,e,s,n,r={}){super(),this.source=t,this.littleEndian=e,this.bigTiff=s,this.firstIFDOffset=n,this.cache=r.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(t,e){const s=this.bigTiff?4048:1024;return new Bh((await this.source.fetch([{offset:t,length:typeof e<"u"?e:s}]))[0],t,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(t){const e=this.bigTiff?20:12,s=this.bigTiff?8:2;let n=await this.getSlice(t);const r=this.bigTiff?n.readUint64(t):n.readUint16(t),a=r*e+(this.bigTiff?16:6);n.covers(t,a)||(n=await this.getSlice(t,a));const o={};let h=t+(this.bigTiff?8:2);for(let u=0;u<r;h+=e,++u){const f=n.readUint16(h),d=n.readUint16(h+2),m=this.bigTiff?n.readUint64(h+4):n.readUint32(h+4);let y,g;const p=Us(d),x=h+(this.bigTiff?12:8);if(p*m<=(this.bigTiff?8:4))y=Bt(n,d,m,x);else{const w=n.readOffset(x),A=Us(d)*m;if(n.covers(w,A))y=Bt(n,d,m,w);else{const b=await this.getSlice(w,A);y=Bt(b,d,m,w)}}m===1&&ph.indexOf(f)===-1&&!(d===I.RATIONAL||d===I.SRATIONAL)?g=y[0]:g=y,o[le[f]]=g}const l=ol(o),c=n.readOffset(t+s+e*r);return new hl(o,l,c)}async requestIFD(t){if(this.ifdRequests[t])return this.ifdRequests[t];if(t===0)return this.ifdRequests[t]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[t];if(!this.ifdRequests[t-1])try{this.ifdRequests[t-1]=this.requestIFD(t-1)}catch(e){throw e instanceof Be?new Be(t):e}return this.ifdRequests[t]=(async()=>{const e=await this.ifdRequests[t-1];if(e.nextIFDByteOffset===0)throw new Be(t);return this.parseFileDirectoryAt(e.nextIFDByteOffset)})(),this.ifdRequests[t]}async getImage(t=0){const e=await this.requestIFD(t);return new vh(e.fileDirectory,e.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let t=0,e=!0;for(;e;)try{await this.requestIFD(t),++t}catch(s){if(s instanceof Be)e=!1;else throw s}return t}async getGhostValues(){const t=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const e="GDAL_STRUCTURAL_METADATA_SIZE=",s=e.length+100;let n=await this.getSlice(t,s);if(e===Bt(n,I.ASCII,e.length,t)){const a=Bt(n,I.ASCII,s,t).split(`
`)[0],o=Number(a.split("=")[1].split(" ")[0])+a.length;o>s&&(n=await this.getSlice(t,o));const h=Bt(n,I.ASCII,o,t);this.ghostValues={},h.split(`
`).filter(l=>l.length>0).map(l=>l.split("=")).forEach(([l,c])=>{this.ghostValues[l]=c})}return this.ghostValues}static async fromSource(t,e,s){const n=(await t.fetch([{offset:0,length:1024}],s))[0],r=new Nh(n),a=r.getUint16(0,0);let o;if(a===18761)o=!0;else if(a===19789)o=!1;else throw new TypeError("Invalid byte order value.");const h=r.getUint16(2,o);let l;if(h===42)l=!1;else if(h===43){if(l=!0,r.getUint16(4,o)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const c=l?r.getUint64(8,o):r.getUint32(4,o);return new di(t,o,l,c,e)}close(){return typeof this.source.close=="function"?this.source.close():!1}}async function cl(i,t={},e){return di.fromSource(al(i,t),e)}function ul(i){return i&&i.trim().replace(/\0/g,"").trim()}function fl(i){if(typeof i!="string")return;const t=new DOMParser;try{return t.parseFromString(i,"text/xml").getElementsByTagName("OME")[0]}catch{return}}class _r{constructor(){M(this,"sizex",0);M(this,"sizey",0);M(this,"sizez",1);M(this,"sizec",1);M(this,"sizet",1);M(this,"unit","");M(this,"pixeltype","");M(this,"dimensionorder","");M(this,"pixelsizex",1);M(this,"pixelsizey",1);M(this,"pixelsizez",1);M(this,"channelnames",[])}}function hn(i){const e={uint8:"uint8",uint16:"uint16",uint32:"uint32",int8:"int8",int16:"int16",int32:"int32",float:"float32"}[i];return e===void 0?(console.warn(`Unsupported OME pixel type ${i}; defaulting to uint8`),"uint8"):e}function ln(i,t){const e=i.getAttribute(t);if(e===null)throw new $(`Missing attribute ${t} in OME-TIFF metadata`,{type:N.INVALID_METADATA});return e}function dl(i){const t=new _r,e=i.getElementsByTagName("Pixels")[0];t.sizex=Number(ln(e,"SizeX")),t.sizey=Number(ln(e,"SizeY")),t.sizez=Number(e.getAttribute("SizeZ")),t.sizec=Number(e.getAttribute("SizeC")),t.sizet=Number(e.getAttribute("SizeT")),t.unit=e.getAttribute("PhysicalSizeXUnit")||"",t.pixeltype=e.getAttribute("Type")||"",t.dimensionorder=e.getAttribute("DimensionOrder")||"XYZCT",t.pixelsizex=Number(e.getAttribute("PhysicalSizeX")),t.pixelsizey=Number(e.getAttribute("PhysicalSizeY")),t.pixelsizez=Number(e.getAttribute("PhysicalSizeZ"));const s=e.getElementsByTagName("Channel");for(let n=0;n<s.length;++n){const r=s[n].getAttribute("Name"),a=s[n].getAttribute("ID");t.channelnames.push(r||a||"Channel"+n)}return t}const ml=i=>i==="uint8"?1:i==="uint16"?2:4,yl=i=>i===1?"uint8":i===2?"uint16":"uint32";class pl extends Qe{constructor(t){super(),this.url=t}async loadOmeDims(){if(!this.dims){const t=await cl(this.url[0],{allowFullFile:!0}).catch($t(`Could not open TIFF file at ${this.url[0]}`,N.NOT_FOUND)),e=await t.getImage().catch($t("Failed to open TIFF image",N.NOT_FOUND)),s=e.getFileDirectory().ImageDescription,n=ul(s),r=fl(n);if(r!==void 0){const a=r.getElementsByTagName("Image")[0];this.dims=dl(a)}else{console.warn("Could not read OME-TIFF metadata from file. Doing our best with base TIFF metadata."),this.dims=new _r;let a=[];if(typeof n=="string")try{const o=JSON.parse(n);Array.isArray(o.shape)&&(a=o.shape)}catch{}this.dims.sizex=a[a.length-1]??e.getWidth(),this.dims.sizey=a[a.length-2]??e.getHeight(),this.dims.sizez=a[a.length-3]??await t.getImageCount(),this.url.length>1?this.dims.sizec=this.url.length:this.dims.sizec=a[a.length-4]??1,this.dims.pixeltype=yl(e.getBytesPerPixel()),this.dims.channelnames=Array.from({length:this.dims.sizec},(o,h)=>"Channel"+h)}}return this.dims}async loadDims(t){const e=await this.loadOmeDims(),s=ue(e.sizez,e.sizex,e.sizey),n=ce,r=Math.floor(n/s.x),a=Math.floor(n/s.y);return[{shape:[e.sizet,e.sizec,e.sizez,a,r],spacing:[1,1,e.pixelsizez,e.pixelsizey*e.sizey/a,e.pixelsizex*e.sizex/r],spaceUnit:e.unit?e.unit:"micron",dataType:hn(e.pixeltype),timeUnit:"s"}]}async createImageInfo(t){const e=await this.loadOmeDims(),s=ue(e.sizez,e.sizex,e.sizey),n=ce,r=Math.floor(n/s.x),a=Math.floor(n/s.y),o=this.url.length>1?Array(this.url.length).fill(1):[e.sizec];return{imageInfo:{name:"TEST",atlasTileDims:[s.x,s.y],subregionSize:[r,a,e.sizez],subregionOffset:[0,0,0],numChannelsPerSource:o,channelNames:e.channelnames,multiscaleLevel:0,multiscaleLevelDims:[{shape:[e.sizet,e.sizec,e.sizez,a,r],spacing:[1,1,e.pixelsizez,e.pixelsizey*e.sizey/a,e.pixelsizex*e.sizex/r],spaceUnit:e.unit||"",timeUnit:"",dataType:hn(e.pixeltype)}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}},loadSpec:new jn}}async loadRawChannelData(t,e,s,n){const r=await this.loadOmeDims(),o=new Je(t).volumeSize,h=[];for(let l=0;l<t.numChannelsPerSource.length;++l){const c=t.numChannelsPerSource[l];for(let u=0;u<c;++u){const f=new Promise((d,m)=>{const y={channel:u,tilesizex:o.x,tilesizey:o.y,sizec:c,sizez:o.z,dimensionOrder:r.dimensionorder,bytesPerSample:ml(r.pixeltype),url:this.url[l]},g=new Worker(new URL("/timelapse-colorizer/pr-preview-internal/pr-823/assets/FetchTiffWorker-CfWXhx_B.js",import.meta.url),{type:"module"});g.onmessage=p=>{if(p.data.isError){m(Rr(p.data.error));return}const{data:x,dtype:w,channel:A,range:b}=p.data;n([A],[w],[x],[b]),g.terminate(),d()},g.postMessage(y)});h.push(f)}}await Promise.all(h)}}let wt=function(i){return i.ZARR="zarr",i.JSON="json",i.TIFF="tiff",i.DATA="data",i}({});function wr(i){return i.endsWith(".json")?wt.JSON:i.endsWith(".tif")||i.endsWith(".tiff")?wt.TIFF:wt.ZARR}async function gl(i,t){const e=Array.isArray(i)?i[0]:i,s=(t==null?void 0:t.fileType)||wr(e),n=Array.isArray(i)?i:[i];switch(s){case wt.ZARR:return await Ks.createLoader(i,t==null?void 0:t.scene,t==null?void 0:t.cache,t==null?void 0:t.queue,t==null?void 0:t.fetchOptions);case wt.JSON:return new Ws(i,t==null?void 0:t.cache);case wt.TIFF:return new pl(n);case wt.DATA:if(!(t!=null&&t.rawArrayOptions))throw new Error("Must provide RawArrayOptions for RawArrayLoader");return new Fo(t==null?void 0:t.rawArrayOptions.data,t==null?void 0:t.rawArrayOptions.metadata)}}let at=function(i){return i[i.INIT=0]="INIT",i[i.CREATE_LOADER=1]="CREATE_LOADER",i[i.CLOSE_LOADER=2]="CLOSE_LOADER",i[i.CREATE_VOLUME=3]="CREATE_VOLUME",i[i.LOAD_DIMS=4]="LOAD_DIMS",i[i.LOAD_VOLUME_DATA=5]="LOAD_VOLUME_DATA",i[i.SET_PREFETCH_PRIORITY_DIRECTIONS=6]="SET_PREFETCH_PRIORITY_DIRECTIONS",i[i.SYNCHRONIZE_MULTICHANNEL_LOADING=7]="SYNCHRONIZE_MULTICHANNEL_LOADING",i[i.UPDATE_FETCH_OPTIONS=8]="UPDATE_FETCH_OPTIONS",i}({}),Xe=function(i){return i[i.SUCCESS=0]="SUCCESS",i[i.ERROR=1]="ERROR",i[i.EVENT=2]="EVENT",i}({}),cn=function(i){return i[i.METADATA_UPDATE=0]="METADATA_UPDATE",i[i.CHANNEL_LOAD=1]="CHANNEL_LOAD",i}({});function bs(i){return{...i,subregion:new st(new _().copy(i.subregion.min),new _().copy(i.subregion.max))}}let un,fn,dn,mn=0;const Fs=new Map,qt=i=>{const t=Fs.get(i);if(t===void 0)throw new $(`Loader with ID ${i} does not exist`);return t};let yn=!1;const xl={[at.INIT]:({maxCacheSize:i,maxActiveRequests:t,maxLowPriorityRequests:e})=>(yn||(un=new Ur(i),fn=new Vn(t,e),dn=new Gn(fn),yn=!0),Promise.resolve()),[at.CREATE_LOADER]:async({path:i,options:t})=>{const e=await gl(i,{...t,cache:un,queue:dn});if(e===void 0)return;const s=Array.isArray(i)?i[0]:i,r=((t==null?void 0:t.fileType)||wr(s))===wt.JSON,a=mn;return mn+=1,Fs.set(a,{loader:e,copyOnLoad:r}),a},[at.CLOSE_LOADER]:(i,t)=>(Fs.delete(t),Promise.resolve()),[at.CREATE_VOLUME]:async(i,t)=>{const{loader:e}=qt(t);return await e.createImageInfo(bs(i))},[at.LOAD_DIMS]:async(i,t)=>{const{loader:e}=qt(t);return await e.loadDims(bs(i))},[at.LOAD_VOLUME_DATA]:({imageInfo:i,loadSpec:t,loadId:e},s)=>{const{loader:n,copyOnLoad:r}=qt(s);return n.loadRawChannelData(i,bs(t),(a,o)=>{const h={responseResult:Xe.EVENT,eventType:cn.METADATA_UPDATE,loaderId:s,loadId:e,imageInfo:a,loadSpec:o};self.postMessage(h)},(a,o,h,l,c)=>{const u={responseResult:Xe.EVENT,eventType:cn.CHANNEL_LOAD,loaderId:s,loadId:e,channelIndex:a,dtype:o,data:h,ranges:l,atlasDims:c};self.postMessage(u,r?[]:h.map(f=>f.buffer))})},[at.SET_PREFETCH_PRIORITY_DIRECTIONS]:(i,t)=>{const{loader:e}=qt(t);return e==null||e.setPrefetchPriority(i),Promise.resolve()},[at.SYNCHRONIZE_MULTICHANNEL_LOADING]:(i,t)=>{const{loader:e}=qt(t);return e==null||e.syncMultichannelLoading(i),Promise.resolve()},[at.UPDATE_FETCH_OPTIONS]:(i,t)=>{const{loader:e}=qt(t);return e==null||e.updateFetchOptions(i),Promise.resolve()}};self.onmessage=async({data:i})=>{let t;try{const e=await xl[i.type](i.payload,i.loaderId);t={...i,responseResult:Xe.SUCCESS,payload:e}}catch(e){t={...i,responseResult:Xe.ERROR,payload:kr(e)}}self.postMessage(t)};export{bl as L,Sl as a,lr as g};
